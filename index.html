<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Académico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://visjs.github.io/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <!-- PDF Viewer Styles -->
    <link rel="stylesheet" href="assets/base.min.css"/>
    <link rel="stylesheet" href="assets/fancy.min.css"/>
    <link rel="stylesheet" href="assets/main.css?v=1.2"/>
    <link rel="stylesheet" href="assets/styles.css?v=1.3"/>
    <style></style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- ---------------------------------- -->
	<!-- Component: Header -->
	<!-- ---------------------------------- -->
	<header class="bg-blue-600 text-white shadow-lg">
	    <div class="px-4 py-3">
	        <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-2 md:space-y-0">
	            <div class="flex items-center justify-between">
	                <h1 class="text-xl md:text-2xl font-bold">Calendario Académico main-5v3</h1>
	                <div class="md:hidden">
	                    <button @click="setView('dayGridMonth')" :class="{'bg-blue-700': currentView === 'dayGridMonth'}" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-alt"></i>
	                    </button>
	                    <button @click="setView('dayGridWeek')" :class="{'bg-blue-700': currentView === 'dayGridWeek'}" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-week"></i>
	                    </button>
	                    <button @click="goToToday" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-day"></i>
	                    </button>
	                </div>
	            </div>
	            <div class="flex items-center justify-between space-x-2">
	                <div class="flex items-center space-x-2">
	                    <button @click="navigate('prev')" class="p-2 rounded-full hover:bg-blue-700">
	                        <i class="fas fa-chevron-left"></i>
	                    </button>
	                    <h2 id="calendar-title" class="text-base md:text-lg font-semibold">
	                        {{ getTitle }}
	                    </h2>
	                    <button @click="navigate('next')" class="p-2 rounded-full hover:bg-blue-700">
	                        <i class="fas fa-chevron-right"></i>
	                    </button>
	                </div>
	                <div class="hidden md:flex space-x-2 ml-4">
	                    <button @click="setView('dayGridMonth')" :class="{'bg-blue-70': currentView === 'dayGridMonth'}" class="px-3 py-1 rounded-md flex items-center" :disabled="disabledButtons.month">
	                        <i class="fas fa-calendar-alt mr-2"></i>
	                        <span>Mes</span>
	                    </button>
	                    <button @click="setView('dayGridWeek')" :class="{'bg-blue-700': currentView === 'dayGridWeek'}" class="px-3 py-1 rounded-md flex items-center" :disabled="disabledButtons.week">
	                        <i class="fas fa-calendar-week mr-2"></i>
	                        <span>Semana</span>
	                    </button>
	                    <button @click="goToToday" class="px-3 py-1 rounded-md flex items-center hover:bg-blue-700" :disabled="disabledButtons.today">
	                        <i class="fas fa-calendar-day mr-2"></i>
	                        <span>Hoy</span>
	                    </button>
			    <button @click="openPeriodoModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.periodo" style="display:none;">
	                        <i class="fas fa-calendar mr-2"></i>
	                        <span>Periodo</span>
	                    </button>
	                    <button @click="toggleTimeline" :class="{'bg-blue-700': showTimeline}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.timeline" style="display:none;">
	                        <i class="fas fa-list-alt mr-2"></i>
	                        <span>Cronograma</span>
	                    </button>	
	                    <button @click="toggleVisorPDF" :class="{'bg-blue-700': showVisorPDF}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.visorPDF">
	                        <i class="fas fa-file-pdf mr-2"></i>
	                        <span>Visor PDF</span>
	                    </button>
	                    <button @click="openTercerosModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.terceros">
	                        <i class="fas fa-users"></i>
	                    </button>
	                    <button @click="openProgrammingModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.programming">
	                        <i class="fas fa-list"></i>
	                    </button>
	                    <button @click="toggleEventLimit" :disabled="currentView !== 'dayGridMonth' || disabledButtons.eventLimit" :class="{'bg-blue-700': limitEvents, 'bg-gray-400 cursor-not-allowed': currentView !== 'dayGridMonth'}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700">
	                        <i :class="limitEvents ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
	                    </button>
	                </div>
	            </div>
	        </div>
	    </div>
	</header>
	<!-- ---------------------------------- -->
	<!-- End Component: Header -->
	<!-- ---------------------------------- -->

        <!-- ---------------------------------- -->
        <!-- Component: Calendar -->
        <!-- ---------------------------------- -->
        <div id="calendar" class="flex-1" v-show="!showTimeline"></div>
        <!-- ---------------------------------- -->
        <!-- End Component: Calendar -->
        <!-- ---------------------------------- -->

<!-- ---------------------------------- -->
<!-- Component: Event Modal -->
<!-- ---------------------------------- -->
<div v-if="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
    <div class="relative bg-white rounded-lg shadow-xl w-full max-w-md m-4">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">{{ currentEvent ? 'Editar Evento' : 'Crear Evento' }}</h3>
            <button @click="closeModal" class="text-gray-500 hover:text-gray-700">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="p-4">
            <form @submit.prevent="saveEvent">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Título</label>
                    <input v-model="searchQuery" @input="filterTerceros" @blur="hideOptions" @focus="filterTerceros" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar tercero..." autocomplete="off">
                    <div v-if="showOptions && filteredTerceros.length" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                        <div v-for="tercero in filteredTerceros" :key="tercero.id" @click="selectTercero(tercero)" class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-indigo-600 hover:text-white">
                            {{ tercero.nombreTercero }}
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input v-model="form.description" @input="handleDescriptionInput" type="text" maxlength="120" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Descripción del evento">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Rango de Fechas</label>
                    <input ref="dateRangePicker" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Selecciona un rango de fechas">
                </div>
                <!-- CHANGE: Replaced color select with estadoViatico select -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Estado del Viático</label>
                    <select v-model="form.estadoViatico" @change="updateViaticaBasedOnEstado" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option v-for="state in viaticoStates" :key="state.value" :value="state.value" :style="{ backgroundColor: state.color, color: state.textColor }" class="py-2">
                            {{ state.label }}
                        </option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Transporte</label>
                    <input v-model="form.transporte" @input="handleTransporteInput" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Valor del transporte">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Origen</label>
                    <input v-model="origenQuery" @input="filterOrigenCities" @blur="hideOrigenOptions" @focus="filterOrigenCities" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar ciudad de origen..." autocomplete="off">
                    <div v-if="showOrigenOptions && filteredOrigenCities.length" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                        <div v-for="city in filteredOrigenCities" :key="city.id" @click="selectOrigenCity(city)" class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-indigo-600 hover:text-white">
                            {{ city.nombreCiudad }}
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Destino</label>
                    <input v-model="destinoQuery" @input="filterDestinoCities" @blur="hideDestinoOptions" @focus="filterDestinoCities" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Buscar ciudad de destino..." autocomplete="off">
                    <div v-if="showDestinoOptions && filteredDestinoCities.length" class="absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                        <div v-for="city in filteredDestinoCities" :key="city.id" @click="selectDestinoCity(city)" class="cursor-pointer select-none relative py-2 pl-3 pr-9 hover:bg-indigo-600 hover:text-white">
                            {{ city.nombreCiudad }}
                        </div>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Ruta Adicional</label>
                    <input v-model="form.rutaAdicional" @input="handleRutaAdicionalInput" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ruta adicional">
                </div>
                <div v-if="error" class="mb-4 text-red-600 text-sm">{{ error }}</div>
                <div class="flex justify-end space-x-2">
                    <button v-if="currentEvent" type="button" @click="deleteEvent" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Eliminar</button>
                    <button type="button" @click="closeModal" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- ---------------------------------- -->
<!-- End Component: Event Modal -->
<!-- ---------------------------------- -->
		
<!-- ---------------------------------- -->
<!-- Component: Visor PDF -->
<!-- ---------------------------------- -->
<div v-if="isGeneratingPDF" class="loading-modal">
    <div class="loading-spinner"></div>
</div>
<div id="visorPDF" class="flex-1" v-show="showVisorPDF">
    <!-- Generar PDF Button -->
    <button @click="generatePDF" class="generate-pdf-button">Generar PDF</button>
    <!-- Added hidden #outline element to satisfy theViewer -->
    <div id="outline" style="display: none;"></div>
    <div v-if="viaticos.length === 0" class="text-center visorPDF-white py-4">
        No hay viáticos disponibles para mostrar. Por favor, genera la programación primero.
    </div>

    <!-- Render templates based on tipoTercero -->
    <div v-for="(viatico, index) in viaticos" :key="index">
        <!-- CATEDRATICO Template -->
        <div v-if="viatico.tercero.tipoTercero === 'CATEDRATICO'" :id="'pf1-' + index" class="pf w0 h0" :data-page-no="index + 1">
            <div class="pc pc1 w0 h0">
                <img class="bi x0 y0 w1 h1" alt="" src="assets/bg1.png?v=1" crossOrigin="anonymous" />
                <div class="c x1 y1 w2 h2">
                    <div class="t m0 x2 h3 y2 ff1 fs0 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div>
                    <div class="t m0 x2 h3 y3 ff1 fs0 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div>
                    <div class="t m0 x3 h3 y4 ff1 fs0 fc0 sc0 ls0 ws0">CATEDRATICO</div>
                </div>
                <!-- ... Rest of pf1 template content ... -->
                <div class="c x0 y60 w15 h22"><div class="t m0 x5 h1f y67 ff3 fs3 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
            </div>
            <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
        </div>

        <!-- SERVIDOR Template -->
        <div v-if="viatico.tercero.tipoTercero === 'SERVIDOR'" :id="'pf2-' + index" class="pf w18 h23" :data-page-no="index + 1">
            <div class="pc pc2 w18 h23">
                <img class="bi x0 y0 w19 h24" alt="" src="assets/bg2.png?v=1" crossOrigin="anonymous" />
                <div class="c x2e y68 w1a h25">
                    <div class="t m0 x2f h26 y69 ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div>
                    <div class="t m0 x5 h26 y6a ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div>
                    <div class="t m0 x30 h26 y6b ff1 fs4 fc0 sc0 ls0 ws0">SERVIDOR</div>
                </div>
                <!-- ... Rest of pf2 template content ... -->
                <div class="c x0 ya0 w2b h3b"><div class="t m0 x26 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Descripción del día</div></div>
                <div class="c x36 ya0 w24 h3b"><div class="t m0 x3f h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">No. de Días</div></div>
                <div class="c x33 ya0 w1f h3b"><div class="t m0 x40 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Viáticos Diario</div></div>
                <div class="c x31 ya0 w1b h3b"><div class="t m0 x24 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Total</div></div>
                <div class="c x0 ya2 w2b h3c"><div class="t m0 x3b h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">Pernoctados</div></div>
                <div class="c x36 ya2 w24 h3c"><div class="t m0 x3d h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaPernoctados }}</div></div>
                <div class="c x33 ya2 w1f h3c">
                    <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiario) }}</div>
                </div>
                <div class="c x31 ya2 w1b h3c">
                    <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _7"> </span>-</div>
                </div>
                <div class="c x0 ya4 w2b h3c"><div class="t m0 x25 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">No Pernoctados</div></div>
                <div class="c x36 ya4 w24 h3c"><div class="t m0 x3d h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaNoPernoctados }}</div></div>
                <div class="c x33 ya4 w1f h3c">
                    <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(REDONDEAR(computeViaticoDetails(viatico).viaticoValorDiario / 2, 0)) }}</div>
                </div>
                <div class="c x31 ya4 w1b h3c">
                    <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiarioMedio) }}</div>
                </div>
                <div class="c x0 ya6 w2c h3c"><div class="t m0 x41 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">Total Viáticos</div></div>
                <div class="c x31 ya6 w1b h3c">
                    <div class="t m0 x5 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoTotal) }}</div>
                </div>
                <div class="c x0 yc7 w2c h42"><div class="t m0 x5 h43 yce ff3 fs8 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
            </div>
            <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
        </div>

        <!-- CONTRATISTA Template -->
        <div v-if="viatico.tercero.tipoTercero === 'CONTRATISTA'" :id="'pf3-' + index" class="pf w18 h23" :data-page-no="index + 1">
            <div class="pc pc3 w18 h23">
                <img class="bi x0 y0 w19 h24" alt="" src="assets/bg3.png?v=1" crossOrigin="anonymous" />
                <div class="c x2e y68 w1a h25">
                    <div class="t m0 x2f h26 y69 ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div>
                    <div class="t m0 x5 h26 y6a ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div>
                    <div class="t m0 x30 h26 y6b ff1 fs4 fc0 sc0 ls0 ws0">CONTRATISTA</div>
                </div>
                <!-- ... Rest of pf3 template content ... -->
                <div class="c x0 ya0 w2b h3b"><div class="t m0 x26 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Descripción del día</div></div>
                <div class="c x36 ya0 w24 h3b"><div class="t m0 x3f h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">No. de Días</div></div>
                <div class="c x33 ya0 w1f h3b"><div class="t m0 x40 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Viáticos Diario</div></div>
                <div class="c x31 ya0 w1b h3b"><div class="t m0 x24 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Total</div></div>
                <div class="c x0 ya2 w2b h3c"><div class="t m0 x3b h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">Pernoctados</div></div>
                <div class="c x36 ya2 w24 h3c"><div class="t m0 x3d h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaPernoctados }}</div></div>
                <div class="c x33 ya2 w1f h3c">
                    <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoValorDiario) }}</div>
                </div>
                <div class="c x31 ya2 w1b h3c">
                    <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiario) }}</div>
                </div>
                <div class="c x0 ya4 w2b h3c"><div class="t m0 x25 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">No Pernoctados</div></div>
                <div class="c x36 ya4 w24 h3c"><div class="t m0 x3d h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaNoPernoctados }}</div></div>
                <div class="c x33 ya4 w1f h3c">
                    <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(REDONDEAR(computeViaticoDetails(viatico).viaticoValorDiario / 2, 0)) }}</div>
                </div>
                <div class="c x31 ya4 w1b h3c">
                    <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiarioMedio) }}</div>
                </div>
                <div class="c x0 ya6 w2c h3c"><div class="t m0 x41 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">Total Viáticos</div></div>
                <div class="c x31 ya6 w1b h3c">
                    <div class="t m0 x5 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoTotal) }}</div>
                </div>
                <div class="c x0 yc7 w2c h42"><div class="t m0 x5 h43 yce ff3 fs8 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
            </div>
            <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
        </div>
        <!-- End CONTRATISTA Template -->    
    </div>
</div>
<!-- ---------------------------------- -->
<!-- End Component: Visor PDF -->
<!-- ---------------------------------- -->


        <!-- ---------------------------------- -->
        <!-- Component: Programming Modal -->
        <!-- ---------------------------------- -->
        <div v-if="showProgrammingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Programación</h3>
                        <button @click="closeProgrammingModal" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="programmingDateRange" class="block text-sm font-medium text-gray-700">Seleccionar Rango de Fechas</label>
                            <input type="text" id="programmingDateRange" ref="programmingDateRangePicker" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div v-if="programmingEventsJson" class="mt-4">
                            <label class="block text-sm font-medium text-gray-700">Total eventos: {{ programmingEventsJson ? JSON.parse(programmingEventsJson).length : 0 }}</label>
                            <pre class="bg-gray-100 p-4 rounded-md overflow-auto max-h-60">{{ programmingEventsJson }}</pre>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeProgrammingModal" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Cerrar
                        </button>
                        <button type="button" @click="generateProgrammingJson" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Aceptar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ---------------------------------- -->
        <!-- End Component: Programming Modal -->
        <!-- ---------------------------------- -->


    </div>
  
    <!-- JavaScript and Vue app initialization -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://visjs.github.io/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>    
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add JSZip and FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


<!-- ---------------------------------- -->
<!-- Component: JavaScript and Vue app initialization -->
<!-- ---------------------------------- -->
<script>
// ----------------------------------
// Component: Vue Setup and Imports
// ----------------------------------
const { createApp, ref, onMounted, onUnmounted, nextTick, computed, reactive } = Vue;

// Mock data for terceros
const mockTerceros = [
    { id: '1', ccTercero: 'CC001', nombreTercero: 'Juan Pérez', inicialTercero: 'JP', tipoDocumentoTercero: '03', numeroDocumentoTercero: '12345678', props: { tipoTercero: 'CONTRATISTA', baseLiquidacion: '5000000', cargoServidor: 'Contratista', entidadBancaria: 'BANCOLOMBIA', cuentaBancaria: '1234567890', tipoCuenta: 'Ahorro', telefono: '3001234567', correo: 'juan.perez@example.com', fechaNacimiento: '1980-05-15', contrato: 'C001' } },
    { id: '2', ccTercero: 'CC002', nombreTercero: 'María Gómez', inicialTercero: 'MG', tipoDocumentoTercero: '03', numeroDocumentoTercero: '87654321', props: { tipoTercero: 'CATEDRATICO', baseLiquidacion: '3000000', cargoServidor: 'Hora Catedra', entidadBancaria: 'BANCO DAVIVIENDA', cuentaBancaria: '0987654321', tipoCuenta: 'Corriente', telefono: '3109876543', correo: 'maria.gomez@example.com', fechaNacimiento: '1990-08-22', contrato: 'C002' } },
    { id: '3', ccTercero: 'CC003', nombreTercero: 'Carlos López', inicialTercero: 'CL', tipoDocumentoTercero: '03', numeroDocumentoTercero: '11223344', props: { tipoTercero: 'SERVIDOR', baseLiquidacion: '4000000', cargoServidor: 'Servidor', entidadBancaria: 'BANCO DE BOGOTA', cuentaBancaria: '4567891234', tipoCuenta: 'Ahorro', telefono: '3204567890', correo: 'carlos.lopez@example.com', fechaNacimiento: '1975-03-10', contrato: 'C003' } }
];

// Mock data source simulation
const TerceroDataSource = async () => {
    return new Promise((resolve) => {
        setTimeout(() => resolve([...mockTerceros]), 500);
    });
};

// Mock data for cities
const mockCities = [
    { id: '1', nombreCiudad: 'CALI', departamento: 'VALLE', categoria: 1 },
    { id: '2', nombreCiudad: 'BOGOTA', departamento: 'CUNDINAMARCA', categoria: 2 },
    { id: '3', nombreCiudad: 'MEDELLIN', departamento: 'ANTIOQUIA', categoria: 1 },
    { id: '4', nombreCiudad: 'CARTAGENA', departamento: 'BOLIVAR', categoria: 3 },
    { id: '5', nombreCiudad: 'BARRANQUILLA', departamento: 'ATLANTICO', categoria: 2 },
    { id: '6', nombreCiudad: 'PEREIRA', departamento: 'RISARALDA', categoria: 1 }
];

// Mock data source simulation for cities
const CityDataSource = async () => {
    return new Promise((resolve) => {
        setTimeout(() => resolve([...mockCities]), 500);
    });
};
// ----------------------------------
// End Component: Vue Setup and Imports
// ----------------------------------

// ----------------------------------
// Component: Vue App Initialization
// ----------------------------------
const app = createApp({
    setup() {
        // ----------------------------------
        // Component: State management
        // ----------------------------------
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const currentView = ref('dayGridMonth');
        const calendarApi = ref(null);
        const events = ref(JSON.parse(localStorage.getItem('academicEvents')) || []);
        const showModal = ref(false);
        const currentEvent = ref(null);
        const error = ref(null);
        const dateRangePicker = ref(null);
        const limitEvents = ref(true);
        const form = ref({
            title: '',
            description: '',
            startDate: '',
            endDate: '',
            estadoViatico: 'CREADO', // CHANGE: Replaced color with estadoViatico, default to CREADO
            terceroId: '',
            viatica: true,
            transporte: '',
            origen: '',
            destino: '',
            rutaAdicional: ''
        });
        const showProgrammingModal = ref(false);
        const programmingDateRangePicker = ref(null);
        const programmingRange = ref({ start: '', end: '' });
        const programmingEventsJson = ref(null);
        const showTercerosModal = ref(false);
        const terceros = ref([]);
        const searchQuery = ref('');
        const showOptions = ref(false);
        const currentTercero = ref(null);
        const showTerceroForm = ref(false);
        const terceroForm = ref({
            id: '',
            ccTercero: '',
            nombreTercero: '',
            inicialTercero: '',
            tipoDocumentoTercero: '03',
            numeroDocumentoTercero: '',
            props: {
                tipoTercero: 'CONTRATISTA',
                baseLiquidacion: '',
                cargoServidor: 'Servidor',
                entidadBancaria: 'BANCOLOMBIA',
                cuentaBancaria: '',
                tipoCuenta: 'Ahorro',
                telefono: '',
                correo: '',
                fechaNacimiento: '',
                contrato: ''
            }
        });
        let flatpickrInstance = null;
        let programmingFlatpickrInstance = null;
        const showPeriodoModal = ref(false);
        const periodos = ref(JSON.parse(localStorage.getItem('periodos')) || []);
        const currentPeriodo = ref(null);
        const periodoForm = ref({
            periodo: '2025-1',
            centro: 'CALI',
            programa: 'ADMINISTRACION PUBLICA',
            semestres: Array(10).fill(false),
            asignaturas: {}
        });
        const showTimeline = ref(false);
        const timelineContainer = ref(null);
        let timeline = null;
        const timelineModalState = reactive({
            isOpen: false,
            action: 'add',
            eventData: { id: '', content: '', group: '', start: '', end: '' }
        });
        const DEPENDENCIA = "0072DP - DECANATURA PREGRADO";
        const viaticos = ref([]);
        const isGeneratingPDF = ref(false);    
        const showVisorPDF = ref(false);
        const disabledButtons = ref({
            month: false,
            week: false,
            today: false,
            periodo: false,
            timeline: false,
            visorPDF: false,
            terceros: false,
            programming: false,
            eventLimit: false
        });
        // CHANGE: Define viático states and their colors
        const viaticoStates = [
            { value: 'NO-VIATICA', label: 'NO-VIATICA', color: '#D3D3D3', textColor: '#000000' },
            { value: 'ANULADA', label: 'ANULADA', color: '#800080', textColor: '#FFFFFF' },
            { value: 'REINTEGRO', label: 'REINTEGRO', color: '#D8BFD8', textColor: '#000000' },
            { value: 'CREADO', label: 'CREADO', color: '#3b82f6', textColor: '#FFFFFF' },
            { value: 'SIN-LEGALIZAR', label: 'SIN-LEGALIZAR', color: '#FFFF00', textColor: '#000000' },
            { value: 'EN-APROBACION', label: 'EN-APROBACION', color: '#00FFFF', textColor: '#000000' },
            { value: 'LEGALIZADO', label: 'LEGALIZADO', color: '#FFA500', textColor: '#000000' },
            { value: 'PAGADO', label: 'PAGADO', color: '#008000', textColor: '#FFFFFF' }
        ];
        // ----------------------------------
        // End Component: State management
        // ----------------------------------

        // ----------------------------------
        // Component: Button State Management
        // ----------------------------------
        const updateButtonStates = () => {
            if (showTimeline.value) {
                disabledButtons.value = {
                    month: true,
                    week: true,
                    today: true,
                    periodo: true,
                    timeline: false,
                    visorPDF: true,
                    terceros: true,
                    programming: true,
                    eventLimit: true
                };
            } else if (showVisorPDF.value) {
                disabledButtons.value = {
                    month: true,
                    week: true,
                    today: true,
                    periodo: true,
                    timeline: true,
                    visorPDF: false,
                    terceros: true,
                    programming: true,
                    eventLimit: true
                };
            } else {
                disabledButtons.value = {
                    month: false,
                    week: false,
                    today: false,
                    periodo: false,
                    timeline: false,
                    visorPDF: false,
                    terceros: false,
                    programming: false,
                    eventLimit: currentView.value !== 'dayGridMonth'
                };
            }
        };
        // ----------------------------------
        // End Component: Button State Management
        // ----------------------------------

        // ----------------------------------
        // Component: Terceros Management
        // ----------------------------------
        const loadTerceros = async () => {
            terceros.value = await TerceroDataSource();
        };

        const filteredTerceros = computed(() => {
            if (!searchQuery.value) return terceros.value;
            return terceros.value.filter(tercero => 
                tercero.nombreTercero.toLowerCase().includes(searchQuery.value.toLowerCase())
            );
        });

        const filterTerceros = () => {
            showOptions.value = true;
        };

        const selectTercero = (tercero) => {
            form.value.terceroId = tercero.id;
            form.value.title = tercero.nombreTercero;
            searchQuery.value = tercero.nombreTercero;
            showOptions.value = false;
        };

        const hideOptions = () => {
            setTimeout(() => {
                showOptions.value = false;
            }, 200);
        };

        const openTercerosModal = async () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showTercerosModal.value = true;
            showTerceroForm.value = false;
            await loadTerceros();
            updateButtonStates();
        };

        const closeTercerosModal = () => {
            showTercerosModal.value = false;
            showTerceroForm.value = false;
            currentTercero.value = null;
            updateButtonStates();
        };

        const openTerceroForm = () => {
            showTerceroForm.value = true;
            currentTercero.value = null;
            terceroForm.value = {
                id: '',
                ccTercero: '',
                nombreTercero: '',
                inicialTercero: '',
                tipoDocumentoTercero: '03',
                numeroDocumentoTercero: '',
                props: {
                    tipoTercero: 'CONTRATISTA',
                    baseLiquidacion: '',
                    cargoServidor: 'Servidor',
                    entidadBancaria: 'BANCOLOMBIA',
                    cuentaBancaria: '',
                    tipoCuenta: 'Ahorro',
                    telefono: '',
                    correo: '',
                    fechaNacimiento: '',
                    contrato: ''
                }
            };
        };

        const closeTerceroForm = () => {
            showTerceroForm.value = false;
            currentTercero.value = null;
        };

        const editTercero = (tercero) => {
            currentTercero.value = tercero;
            terceroForm.value = JSON.parse(JSON.stringify(tercero));
            showTerceroForm.value = true;
        };

        const saveTercero = () => {
            if (!terceroForm.value.nombreTercero || !terceroForm.value.numeroDocumentoTercero) {
                alert('El nombre y el número de documento son requeridos.');
                return;
            }
            if (currentTercero.value) {
                const index = terceros.value.findIndex(t => t.id === currentTercero.value.id);
                if (index !== -1) terceros.value[index] = { ...terceroForm.value };
            } else {
                const newTercero = { ...terceroForm.value, id: Date.now().toString() };
                terceros.value.push(newTercero);
            }
            closeTerceroForm();
        };

        const deleteTercero = (id) => {
            if (confirm('¿Estás seguro de eliminar este tercero?')) {
                terceros.value = terceros.value.filter(t => t.id !== id);
            }
        };
        // ----------------------------------
        // End Component: Terceros Management
        // ----------------------------------

        // ----------------------------------
        // Component: Cities Management
        // ----------------------------------
        const cities = ref([]);
        const origenQuery = ref('');
        const destinoQuery = ref('');
        const showOrigenOptions = ref(false);
        const showDestinoOptions = ref(false);

        const loadCities = async () => {
            cities.value = await CityDataSource();
        };

        const filteredOrigenCities = computed(() => {
            if (!origenQuery.value) return cities.value;
            return cities.value.filter(city => 
                city.nombreCiudad.toLowerCase().includes(origenQuery.value.toLowerCase())
            );
        });

        const filteredDestinoCities = computed(() => {
            if (!destinoQuery.value) return cities.value;
            return cities.value.filter(city => 
                city.nombreCiudad.toLowerCase().includes(destinoQuery.value.toLowerCase())
            );
        });

        const filterOrigenCities = () => {
            showOrigenOptions.value = true;
        };

        const filterDestinoCities = () => {
            showDestinoOptions.value = true;
        };

        const selectOrigenCity = (city) => {
            form.value.origen = city.id;
            origenQuery.value = city.nombreCiudad;
            showOrigenOptions.value = false;
        };

        const selectDestinoCity = (city) => {
            form.value.destino = city.id;
            destinoQuery.value = city.nombreCiudad;
            showDestinoOptions.value = false;
        };

        const hideOrigenOptions = () => {
            setTimeout(() => {
                showOrigenOptions.value = false;
            }, 200);
        };

        const hideDestinoOptions = () => {
            setTimeout(() => {
                showDestinoOptions.value = false;
            }, 200);
        };
        // ----------------------------------
        // End Component: Cities Management
        // ----------------------------------

        // ----------------------------------
        // Component: Viáticos Calculation Functions
        // ----------------------------------
        // Function to calculate the base tariff based on baseLiquidacion
        const tarifaViaticosDiario = (valor) => {
            const numValor = parseFloat(valor.replace(/,/g, '')); // Remove commas if any
            if (numValor >= 0 && numValor <= 1674542) return 151878;
            if (numValor <= 2631382) return 207569;
            if (numValor <= 3613828) return 251853;
            if (numValor <= 4456815) return 293056;
            if (numValor <= 5382527) return 336520;
            if (numValor <= 8117664) return 379828;
            if (numValor <= 11345698) return 461358;
            if (numValor <= 13471440) return 622374;
            if (numValor <= 16583843) return 809075;
            if (numValor <= 20053045) return 978656;
            return 1152515; // For values >= 20,053,046 ("En adelante")
        };

        // Function to calculate the viático value based on tipoTercero
        const valorViaticosDiario = (viatico) => {
            const tarifaBase = tarifaViaticosDiario(viatico.tercero.props.baseLiquidacion); // Use baseLiquidacion from tercero props

            if (viatico.tercero.tipoTercero === 'SERVIDOR') {
                return tarifaBase * 1.0; // 100% of tarifaBase
            } 
            if (viatico.tercero.tipoTercero === 'CONTRATISTA') {
                return tarifaBase * 0.8; // 80% of tarifaBase
            }

            return tarifaBase; // Default case if tipoTercero is neither SERVIDOR nor CONTRATISTA
        };

        // Function to round numbers as per REDONDEAR specification
        const REDONDEAR = (value, decimals) => {
            return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
        };

        // Function to format numbers with dots for thousands and comma for decimals (e.g., 622.374,00)
        const formatCurrency = (value) => {
            const rounded = REDONDEAR(value, 2); // Ensure 2 decimal places
            const [integerPart, decimalPart = '00'] = rounded.toFixed(2).split('.');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // Add dots for thousands
            return `${formattedInteger},${decimalPart.padStart(2, '0')}`; // Use comma for decimals
        };

        // Compute viático details for each viatico object (used in template)
        const computeViaticoDetails = (viatico) => {
            // Parse dates in DD/MM/YYYY format
            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('/').map(Number);
                return new Date(year, month - 1, day);
            };

            const startDate = parseDate(viatico.event.startDate);
            const endDate = parseDate(viatico.event.endDate);

            // Calculate total days (inclusive of start and end dates)
            const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            // Debug log for startDate, endDate, totalDays, and duracion
            console.log('[computeViaticoDetails] Viático Debug:', {
                tercero: viatico.tercero.nombreTercero,
                startDate: viatico.event.startDate,
                endDate: viatico.event.endDate,
                totalDays: totalDays,
                duracion: viatico.duracion
            });

            // Apply logic for viaticoDiaPernoctados and viaticoDiaNoPernoctados based on totalDays
            let viaticoDiaPernoctados, viaticoDiaNoPernoctados;
            if (totalDays === 1) {
                viaticoDiaPernoctados = 0;
                viaticoDiaNoPernoctados = 1;
            } else if (totalDays === 2) {
                viaticoDiaPernoctados = 1;
                viaticoDiaNoPernoctados = 1;
            } else if (totalDays === 3) {
                viaticoDiaPernoctados = 2;
                viaticoDiaNoPernoctados = 1;
            } else if (totalDays >= 4) {
                viaticoDiaPernoctados = totalDays - 1; // For 4 days: 3 pernoctados
                viaticoDiaNoPernoctados = 1;
            } else {
                // Fallback for unexpected cases
                viaticoDiaPernoctados = totalDays > 1 ? totalDays - 1 : 0;
                viaticoDiaNoPernoctados = totalDays > 1 ? 1 : totalDays;
            }

            // Calculate valorViaticosDiario using the function
            const viaticoValorDiario = valorViaticosDiario(viatico);

            // Calculate viaticoDiario = valorViaticosDiario * viaticoDiaPernoctados
            const viaticoDiario = viaticoValorDiario * viaticoDiaPernoctados;

            // Calculate viaticoDiarioMedio = REDONDEAR((valorViaticosDiario/2), 0) * viaticoDiaNoPernoctados
            const viaticoDiarioMedio = REDONDEAR(viaticoValorDiario / 2, 0) * viaticoDiaNoPernoctados;

            // Calculate viaticoTotal = viaticoDiario + viaticoDiarioMedio
            const viaticoTotal = viaticoDiario + viaticoDiarioMedio;

            return {
                viaticoDiaPernoctados,
                viaticoDiaNoPernoctados,
                viaticoValorDiario,
                viaticoDiario,
                viaticoDiarioMedio,
                viaticoTotal
            };
        };
        // ----------------------------------
        // End Component: Viáticos Calculation Functions
        // ----------------------------------

        // ----------------------------------
        // Component: Calendar Management
        // ----------------------------------
        const getTitle = () => {
            if (!calendarApi.value) return '';
            const view = calendarApi.value.view;
            if (view.type === 'dayGridMonth') {
                const date = view.currentStart;
                return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            } else if (view.type === 'dayGridWeek') {
                const start = view.currentStart;
                const end = view.currentEnd;
                end.setDate(end.getDate() - 1);
                if (start.getMonth() === end.getMonth()) {
                    return `${start.getDate()} - ${end.getDate()} ${monthNames[start.getMonth()]} ${start.getFullYear()}`;
                } else if (start.getFullYear() === end.getFullYear()) {
                    return `${start.getDate()} ${monthNames[start.getMonth()].substring(0, 3)} - ${end.getDate()} ${monthNames[end.getMonth()].substring(0, 3)} ${start.getFullYear()}`;
                } else {
                    return `${start.getDate()} ${monthNames[start.getMonth()].substring(0, 3)} ${start.getFullYear()} - ${end.getDate()} ${monthNames[end.getMonth()].substring(0, 3)} ${end.getFullYear()}`;
                }
            }
            return '';
        };

        const darkenColor = (color, percent) => {
            if (!color) return '#3b82f6'; // CHANGE: Default to CREADO color
            if (color.startsWith('#')) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = Math.max(0, (num >> 16) - amt);
                const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
                const B = Math.max(0, (num & 0x0000FF) - amt);
                return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
            }
            return '#2563eb'; // CHANGE: Fallback to darker CREADO color
        };

        const navigate = (direction) => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            if (direction === 'prev') calendarApi.value.prev();
            else if (direction === 'next') calendarApi.value.next();
            updateTitle();
        };

        const setView = (view) => {
            if (showTimeline.value || showVisorPDF.value) return;
            currentView.value = view;
            if (calendarApi.value) {
                calendarApi.value.changeView(view);
                if (view === 'dayGridMonth') {
                    calendarApi.value.setOption('dayMaxEventRows', limitEvents.value ? 4 : false);
                    calendarApi.value.setOption('dayMaxEvents', limitEvents.value ? 4 : false);
                } else if (view === 'dayGridWeek') {
                    calendarApi.value.setOption('dayMaxEventRows', false);
                    calendarApi.value.setOption('dayMaxEvents', false);
                }
                updateTitle();
                updateButtonStates();
            }
        };

        const goToToday = () => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            calendarApi.value.today();
            setView(currentView.value);
            updateTitle();
        };

        const toggleEventLimit = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            limitEvents.value = !limitEvents.value;
            if (calendarApi.value && currentView.value === 'dayGridMonth') {
                calendarApi.value.setOption('dayMaxEventRows', limitEvents.value ? 4 : false);
                calendarApi.value.setOption('dayMaxEvents', limitEvents.value ? 4 : false);
            }
            updateButtonStates();
        };

        const updateTitle = () => {
            const titleElement = document.getElementById('calendar-title');
            if (titleElement) titleElement.textContent = getTitle();
        };

        const renderEvents = () => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            try {
                calendarApi.value.getEvents().forEach(event => event.remove());
                events.value.forEach(event => {
                    // CHANGE: Map estadoViatico to color
                    const state = viaticoStates.find(s => s.value === event.estadoViatico) || viaticoStates.find(s => s.value === 'CREADO');
                    const eventColor = state.color;
                    calendarApi.value.addEvent({
                        id: event.id,
                        title: event.title,
                        start: event.startDate,
                        end: event.endDate,
                        allDay: true,
                        backgroundColor: eventColor,
                        borderColor: darkenColor(eventColor, 20),
                        extendedProps: { 
                            description: event.description || '',
                            terceroId: event.terceroId || '',
                            viatica: event.viatica || false,
                            transporte: event.transporte || '',
                            origen: event.origen || '',
                            destino: event.destino || '',
                            rutaAdicional: event.rutaAdicional || ''
                        }
                    });
                });
            } catch (error) {
                console.error('Error in renderEvents:', error);
            }
        };

        const reinitializeCalendar = () => {
            try {
                const calendarEl = document.getElementById('calendar');
                if (!calendarEl) {
                    console.error('Calendar element not found');
                    return;
                }

                calendarEl.classList.remove('hidden');
                calendarEl.style.height = '100%';

                const savedView = currentView.value;
                const savedEvents = [...events.value];

                if (calendarApi.value) {
                    calendarApi.value.destroy();
                    calendarApi.value = null;
                }

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    locale: 'es',
                    initialView: savedView,
                    headerToolbar: false,
                    firstDay: 1,
                    dayHeaderFormat: { weekday: 'long' },
                    height: '100%',
                    contentHeight: '100%',
                    eventClick: (info) => {
                        editEvent(info);
                    },
                    dateClick: function(info) {
                        openModal(info.dateStr);
                    },
                    eventDisplay: 'block',
                    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                    eventDidMount: function(info) {
                        if (info.event.allDay && info.event.start && info.event.end) {
                            const start = info.event.start;
                            const end = info.event.end;
                            const duration = (end - start) / (1000 * 60 * 60 * 24);
                            if (duration > 1) {
                                info.el.style.borderLeftWidth = '4px';
                                info.el.style.borderLeftStyle = 'solid';
                                info.el.style.borderLeftColor = darkenColor(info.event.backgroundColor, 20);
                            }
                        }
                    },
                    dayHeaderContent: function(arg) {
                        const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                        return { html: `<div>${dayName}</div>` };
                    },
                    views: {
                        dayGridMonth: {
                            dayMaxEventRows: limitEvents.value ? 4 : false,
                            dayMaxEvents: limitEvents.value ? 4 : false,
                            fixedWeekCount: false,
                            aspectRatio: 1.5
                        },
                        dayGridWeek: {
                            type: 'dayGrid',
                            duration: { weeks: 1 },
                            dayCount: 7,
                            dayMaxEventRows: false,
                            dayMaxEvents: false,
                            titleFormat: { year: 'numeric', month: 'long', day: 'numeric' },
                            dayHeaderContent: function(arg) {
                                const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                                const dayNumber = arg.date.getDate();
                                return {
                                    html: `
                                        <div class="flex flex-col items-center">
                                            <span class="fc-day-name">${dayName}</span>
                                            <span class="fc-day-number">${dayNumber}</span>
                                        </div>
                                    `
                                };
                            }
                        }
                    },
                    datesSet: function() {
                        updateTitle();
                    }
                });

                calendarApi.value = calendar;
                calendar.render();

                events.value = savedEvents;
                renderEvents();

                calendar.updateSize();

                const debounce = (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                };

                const handleResize = debounce(() => {
                    if (calendarApi.value) {
                        calendarApi.value.updateSize();
                    }
                }, 100);

                window.addEventListener('resize', handleResize);

                nextTick(() => {
                    window.removeEventListener('resize', handleResize);
                });

                updateButtonStates();
            } catch (error) {
                console.error('Error reinitializing calendar:', error);
            }
        };
        // ----------------------------------
        // End Component: Calendar Management
        // ----------------------------------

        // ----------------------------------
        // Component: Event Management
        // ----------------------------------
        // CHANGE: Function to update viatica based on estadoViatico
        const updateViaticaBasedOnEstado = () => {
            form.value.viatica = form.value.estadoViatico !== 'NO-VIATICA';
            console.log('[updateViaticaBasedOnEstado] Updated viatica:', {
                estadoViatico: form.value.estadoViatico,
                viatica: form.value.viatica
            });
        };

        const openModal = (date) => {
            if (showTimeline.value || showVisorPDF.value) return;
            if (date) {
                form.value.startDate = date;
                form.value.endDate = date;
            } else if (!currentEvent.value) {
                const today = new Date().toISOString().split('T')[0];
                form.value.startDate = today;
                form.value.endDate = today;
            }
            showModal.value = true;

            nextTick(() => {
                if (dateRangePicker.value) {
                    flatpickrInstance = flatpickr(dateRangePicker.value, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        locale: 'es',
                        defaultDate: [form.value.startDate, form.value.endDate],
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                form.value.startDate = selectedDates[0].toISOString().split('T')[0];
                                form.value.endDate = selectedDates[1].toISOString().split('T')[0];
                            }
                        },
                        onReady: (selectedDates, dateStr, instance) => {
                            if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                                dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                            }
                        },
                        onOpen: (selectedDates, dateStr, instance) => {
                            if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                                dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                            }
                        }
                    });

                    if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                        dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                    }
                }
            });
        };

        const closeModal = () => {
            showModal.value = false;
            currentEvent.value = null;
            error.value = null;
            form.value = {
                title: '',
                description: '',
                startDate: '',
                endDate: '',
                estadoViatico: 'CREADO', // CHANGE: Default to CREADO
                terceroId: '',
                viatica: true,
                transporte: '',
                origen: '',
                destino: '',
                rutaAdicional: ''
            };
            searchQuery.value = '';
            showOptions.value = false;
            origenQuery.value = '';
            destinoQuery.value = '';
            showOrigenOptions.value = false;
            showDestinoOptions.value = false;
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                flatpickrInstance = null;
            }
        };

        const computeViatico = () => {
            const eventToUse = currentEvent.value || form.value;
            if (eventToUse.terceroId && eventToUse.destino && eventToUse.viatica) {
                const viaticoObj = createViaticoObject(eventToUse, terceros.value, cities.value);
                if (viaticoObj && !viaticos.value.some(v => v.event.startDate === viaticoObj.event.startDate && v.tercero.numeroDocumentoTercero === viaticoObj.tercero.numeroDocumentoTercero)) {
                    viaticos.value.push(viaticoObj);
                }
            }
        };

        const editEvent = (eventInfo) => {
            if (showTimeline.value || showVisorPDF.value) return;
            const endDate = new Date(eventInfo.event.end || eventInfo.event.start);
            endDate.setDate(endDate.getDate() - 1);
            
            const origenCity = cities.value.find(city => city.id === eventInfo.event.extendedProps.origen);
            const destinoCity = cities.value.find(city => city.id === eventInfo.event.extendedProps.destino);

            currentEvent.value = {
                id: eventInfo.event.id,
                title: eventInfo.event.title,
                description: eventInfo.event.extendedProps.description || '',
                startDate: eventInfo.event.startStr.split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                estadoViatico: eventInfo.event.extendedProps.estadoViatico || 'CREADO', // CHANGE: Use estadoViatico
                terceroId: eventInfo.event.extendedProps.terceroId || '',
                viatica: eventInfo.event.extendedProps.viatica || false,
                transporte: eventInfo.event.extendedProps.transporte || '',
                origen: eventInfo.event.extendedProps.origen || '',
                destino: eventInfo.event.extendedProps.destino || '',
                rutaAdicional: eventInfo.event.extendedProps.rutaAdicional || ''
            };

            form.value = { ...currentEvent.value };
            searchQuery.value = form.value.title;
            origenQuery.value = origenCity ? origenCity.nombreCiudad : '';
            destinoQuery.value = destinoCity ? destinoCity.nombreCiudad : '';
            computeViatico();
            openModal();
        };

        const saveEvent = () => {
            if (!form.value.title) {
                error.value = 'El título es requerido';
                return;
            }
            if (!form.value.startDate || !form.value.endDate) {
                error.value = 'Las fechas son requeridas';
                return;
            }
            const startDate = new Date(form.value.startDate);
            const endDate = new Date(form.value.endDate);
            if (startDate > endDate) {
                error.value = 'La fecha de inicio no puede ser posterior a la fecha final';
                return;
            }
            error.value = null;
            const startDateStr = `${form.value.startDate}T00:00:00`;
            const adjustedEndDate = new Date(form.value.endDate);
            adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
            const endDateStr = adjustedEndDate.toISOString().split('T')[0] + 'T00:00:00';

            const eventData = {
                id: currentEvent.value ? currentEvent.value.id : Date.now().toString(),
                title: form.value.title,
                description: form.value.description,
                startDate: startDateStr,
                endDate: endDateStr,
                estadoViatico: form.value.estadoViatico, // CHANGE: Use estadoViatico
                terceroId: form.value.terceroId,
                viatica: form.value.viatica,
                transporte: form.value.transporte,
                origen: form.value.origen,
                destino: form.value.destino,
                rutaAdicional: form.value.rutaAdicional
            };

            if (currentEvent.value) {
                const index = events.value.findIndex(e => e.id === currentEvent.value.id);
                if (index !== -1) events.value[index] = eventData;
            } else {
                events.value.push(eventData);
            }
            localStorage.setItem('academicEvents', JSON.stringify(events.value));
            renderEvents();
            closeModal();
        };

        const deleteEvent = () => {
            if (currentEvent.value) {
                events.value = events.value.filter(e => e.id !== currentEvent.value.id);
                localStorage.setItem('academicEvents', JSON.stringify(events.value));
                renderEvents();
                closeModal();
            }
        };

        const createViaticoObject = (eventData, terceros, cities) => {
            if (!eventData) return null;

            const tercero = terceros.find(t => t.id === eventData.terceroId);
            const destinoCity = cities.find(c => c.id === eventData.destino);
            if (!tercero || !destinoCity) return null;

            const startDate = new Date(eventData.startDate);
            const endDate = new Date(eventData.endDate);

            // Adjust endDate for inclusive calculation (FullCalendar's endDate is exclusive)
            const adjustedEndDate = new Date(endDate);
            adjustedEndDate.setDate(adjustedEndDate.getDate() - 1);

            // Calculate total days (inclusive of start and adjusted end dates)
            const totalDays = Math.floor((adjustedEndDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            // Apply logic for duracion based on totalDays
            let duracion;
            if (totalDays === 1) {
                duracion = 0.5;
            } else if (totalDays === 2) {
                duracion = 1.5;
            } else if (totalDays === 3) {
                duracion = 2.5;
            } else if (totalDays >= 4) {
                duracion = totalDays - 0.5; // For 4 days: 3.5, etc.
            } else {
                // Fallback for unexpected cases
                duracion = totalDays > 1 ? totalDays - 0.5 : totalDays / 2;
            }

            // Debug log for startDate, endDate, totalDays, and duracion
            console.log('[createViaticoObject] Viático Debug:', {
                tercero: tercero.nombreTercero,
                startDate: eventData.startDate,
                endDate: eventData.endDate,
                adjustedEndDate: adjustedEndDate.toISOString(),
                totalDays: totalDays,
                duracion: duracion
            });

            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
            };

            // Construct partial viatico object for computeViaticoDetails
            const viatico = {
                dependencia: DEPENDENCIA,
                currentDate: formatDate(new Date('2025-05-04')),
                duracion: duracion,
                tercero: {
                    nombreTercero: tercero.nombreTercero,
                    nacimiento: tercero.props.fechaNacimiento ? formatDate(tercero.props.fechaNacimiento) : '',
                    numeroDocumentoTercero: tercero.numeroDocumentoTercero,
                    correo: tercero.props.correo,
                    telefono: tercero.props.telefono,
                    entidadBancaria: tercero.props.entidadBancaria,
                    cargoServidor: tercero.props.cargoServidor,
                    tipoCuenta: tercero.props.tipoCuenta,
                    tipoTercero: tercero.props.tipoTercero,
                    cuentaBancaria: tercero.props.cuentaBancaria,
                    props: tercero.props
                },
                event: {
                    startDate: formatDate(eventData.startDate),
                    endDate: formatDate(adjustedEndDate),
                    description: eventData.description || '',
                    transporte: eventData.transporte || '0',
                    itinerario: eventData.rutaAdicional || '',
                    ciudadDestino: destinoCity.nombreCiudad,
                    ciudadDestinoDepartamento: destinoCity.departamento
                },
                eventId: eventData.id
            };

            // Calculate cost using computeViaticoDetails
            const cost = computeViaticoDetails(viatico).viaticoTotal;

            // Return complete viatico object with updated cost
            return {
                ...viatico,
                cost: cost
            };
        };
        // ----------------------------------
        // End Component: Event Management
        // ----------------------------------

        // ----------------------------------
        // Component: Event Modal Input Formatting
        // ----------------------------------
        const formatTransporte = (value) => {
            const digitsOnly = value.replace(/\D/g, '');
            return digitsOnly.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const handleTransporteInput = (event) => {
            const input = event.target.value.replace(/,/g, '');
            if (/^\d*$/.test(input)) {
                form.value.transporte = formatTransporte(input);
            } else {
                form.value.transporte = formatTransporte(input.replace(/\D/g, ''));
            }
        };

        const handleRutaAdicionalInput = (event) => {
            let value = event.target.value;
            value = value.replace(/[^a-zA-Z\s]/g, '');
            form.value.rutaAdicional = value.toUpperCase();
        };

        const handleDescriptionInput = (event) => {
            const input = event.target;
            let value = input.value;
            
            // Store current cursor position
            const start = input.selectionStart;
            const end = input.selectionEnd;
            
            // Remove invalid characters (allow a-z, A-Z, 0-9, hyphen, space)
            value = value.replace(/[^a-zA-Z0-9\s-]/g, '');
            
            // Enforce 120-character limit
            if (value.length > 120) {
                value = value.substring(0, 120);
            }
            
            // Convert to uppercase
            value = value.toUpperCase();
            
            // Update reactive form value
            form.value.description = value;
            
            // Restore cursor position in next tick to avoid reactivity issues
            nextTick(() => {
                input.setSelectionRange(start, end);
            });
        };
        // ----------------------------------
        // End Component: Event Modal Input Formatting
        // ----------------------------------

        // ----------------------------------
        // Component: Programming Management
        // ----------------------------------
        const computeViaticoForProgramming = () => {
            console.log('[computeViaticoForProgramming] Starting computation...');
            console.log('[computeViaticoForProgramming] Terceros count:', terceros.value.length);
            console.log('[computeViaticoForProgramming] Cities count:', cities.value.length);
            console.log('[computeViaticoForProgramming] Events count:', events.value.length);

            if (!terceros.value.length || !cities.value.length) {
                console.warn('[computeViaticoForProgramming] Terceros or cities not loaded. Cannot compute viáticos.');
                viaticos.value = [];
                return;
            }

            if (!programmingRange.value.start || !programmingRange.value.end) {
                console.warn('[computeViaticoForProgramming] No date range selected. Setting default range.');
                const today = new Date();
                const start = new Date(today.getFullYear(), today.getMonth(), 1);
                const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                programmingRange.value.start = start.toISOString().split('T')[0];
                programmingRange.value.end = end.toISOString().split('T')[0];
            }

            console.log('[computeViaticoForProgramming] Date range:', {
                start: programmingRange.value.start,
                end: programmingRange.value.end
            });

            const startDate = new Date(programmingRange.value.start);
            const endDate = new Date(programmingRange.value.end);
            endDate.setDate(endDate.getDate() + 1); // Include end date in range

            const filteredEvents = events.value.filter(event => {
                const eventStart = new Date(event.startDate);
                const isWithinRange = eventStart >= startDate && eventStart <= endDate;
                const hasRequiredFields = event.terceroId && event.destino && event.viatica;
                console.log('[computeViaticoForProgramming] Filtering event:', {
                    eventId: event.id,
                    startDate: event.startDate,
                    isWithinRange,
                    hasTercero: !!event.terceroId,
                    hasDestino: !!event.destino,
                    hasViatica: event.viatica,
                    included: isWithinRange && hasRequiredFields
                });
                return isWithinRange && hasRequiredFields;
            });

            console.log('[computeViaticoForProgramming] Filtered events:', filteredEvents.map(e => ({
                id: e.id,
                startDate: e.startDate,
                terceroId: e.terceroId,
                destino: e.destino,
                viatica: e.viatica
            })));

            const newViaticos = filteredEvents
                .map(event => {
                    const viatico = createViaticoObject(event, terceros.value, cities.value);
                    console.log('[computeViaticoForProgramming] Created viatico for event:', {
                        eventId: event.id,
                        viatico: viatico ? {
                            eventId: viatico.eventId,
                            tercero: viatico.tercero.nombreTercero,
                            startDate: viatico.event.startDate,
                            destino: viatico.event.ciudadDestino
                        } : null
                    });
                    return viatico;
                })
                .filter(viatico => viatico !== null);

            // Remove duplicates based on eventId
            viaticos.value = newViaticos.filter((viatico, index, self) =>
                index === self.findIndex(v => v.eventId === viatico.eventId)
            );

            // Force reactivity update
            viaticos.value = reactive([...viaticos.value]);

            console.log('[computeViaticoForProgramming] Computed viáticos:', viaticos.value.map(v => ({
                eventId: v.eventId,
                tercero: v.tercero.nombreTercero,
                startDate: v.event.startDate,
                destino: v.event.ciudadDestino,
                cost: v.cost
            })));

            if (!viaticos.value.length) {
                console.warn('[computeViaticoForProgramming] No viáticos generated for the selected date range.');
            } else {
                console.log('[computeViaticoForProgramming] Total viáticos generated:', viaticos.value.length);
            }
        };

        const generateProgrammingJson = () => {
            console.log('[generateProgrammingJson] Starting...');
            console.log('[generateProgrammingJson] Initial state:', {
                tercerosCount: terceros.value.length,
                citiesCount: cities.value.length,
                eventsCount: events.value.length,
                programmingRange: programmingRange.value,
                viaticosCount: viaticos.value.length
            });

            if (!terceros.value.length || !cities.value.length) {
                console.error('[generateProgrammingJson] Error: Terceros or cities not loaded.');
                alert('Error: Terceros o ciudades no están cargados.');
                return;
            }

            if (!programmingRange.value.start || !programmingRange.value.end) {
                console.warn('[generateProgrammingJson] No date range selected.');
                alert('Por favor, selecciona un rango de fechas.');
                return;
            }

            console.log('[generateProgrammingJson] Computing viáticos...');
            computeViaticoForProgramming();

            console.log('[generateProgrammingJson] Viaticos after computation:', {
                count: viaticos.value.length,
                details: viaticos.value.map(v => ({
                    eventId: v.eventId,
                    tercero: v.tercero.nombreTercero,
                    startDate: v.event.startDate,
                    endDate: v.event.endDate,
                    destino: v.event.ciudadDestino,
                    cost: v.cost
                }))
            });

            const startDate = new Date(programmingRange.value.start);
            const endDate = new Date(programmingRange.value.end);
            endDate.setDate(endDate.getDate() + 1); // Include end date

            console.log('[generateProgrammingJson] Filtering events for JSON...', {
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            });

            const filteredEvents = events.value.filter(event => {
                const eventStart = new Date(event.startDate);
                const isWithinRange = eventStart >= startDate && eventStart <= endDate;
                const hasRequiredFields = event.terceroId && event.destino && event.viatica;
                console.log('[generateProgrammingJson] Event filter:', {
                    eventId: event.id,
                    startDate: event.startDate,
                    isWithinRange,
                    hasTercero: !!event.terceroId,
                    hasDestino: !!event.destino,
                    hasViatica: event.viatica,
                    included: isWithinRange && hasRequiredFields
                });
                return isWithinRange && hasRequiredFields;
            });

            console.log('[generateProgrammingJson] Filtered events for JSON:', filteredEvents.map(e => ({
                id: e.id,
                startDate: e.startDate,
                terceroId: e.terceroId,
                destino: e.destino,
                viatica: e.viatica
            })));

            const eventsWithViatico = filteredEvents.map(event => {
                const viatico = viaticos.value.find(v => v.eventId === event.id);
                console.log('[generateProgrammingJson] Mapping event:', {
                    eventId: event.id,
                    hasViatico: !!viatico,
                    viatico: viatico ? {
                        tercero: viatico.tercero.nombreTercero,
                        startDate: viatico.event.startDate,
                        destino: viatico.event.ciudadDestino
                    } : null
                });
                return {
                    ...event,
                    viatico: viatico || null
                };
            });

            programmingEventsJson.value = JSON.stringify(eventsWithViatico, null, 2);
            console.log('[generateProgrammingJson] Generated JSON:', programmingEventsJson.value);

            // Force reactivity update
            programmingEventsJson.value = reactive(programmingEventsJson.value);
            viaticos.value = [...viaticos.value]; // Force reactivity

            // Close modal and toggle Visor PDF
            showProgrammingModal.value = false;
            nextTick(() => {
                console.log('[generateProgrammingJson] Toggling Visor PDF...');
                if (showVisorPDF.value) {
                    toggleVisorPDF(); // Briefly toggle off
                    nextTick(() => toggleVisorPDF()); // Toggle back on
                } else {
                    toggleVisorPDF();
                }
                debugViaticos();
                console.log('[generateProgrammingJson] Completed.');
            });
        };

        const openProgrammingModal = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showProgrammingModal.value = true;
            updateButtonStates();

            nextTick(() => {
                if (programmingDateRangePicker.value) {
                    programmingFlatpickrInstance = flatpickr(programmingDateRangePicker.value, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        locale: 'es',
                        defaultDate: [programmingRange.value.start, programmingRange.value.end],
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                programmingRange.value.start = selectedDates[0].toISOString().split('T')[0];
                                programmingRange.value.end = selectedDates[1].toISOString().split('T')[0];
                            }
                        },
                        onReady: (selectedDates, dateStr, instance) => {
                            if (programmingRange.value.start && programmingRange.value.end) {
                                programmingDateRangePicker.value.value = `${programmingRange.value.start} a ${programmingRange.value.end}`;
                            }
                        },
                        onOpen: (selectedDates, dateStr, instance) => {
                            if (programmingRange.value.start && programmingRange.value.end) {
                                programmingDateRangePicker.value.value = `${programmingRange.value.start} a ${programmingRange.value.end}`;
                            }
                        }
                    });

                    if (programmingRange.value.start && programmingRange.value.end) {
                        programmingDateRangePicker.value.value = `${programmingRange.value.start} a ${programmingRange.value.end}`;
                    }
                }
            });
        };

        const closeProgrammingModal = () => {
            showProgrammingModal.value = false;
            programmingRange.value = { start: '', end: '' };
            if (programmingFlatpickrInstance) {
                programmingFlatpickrInstance.destroy();
                programmingFlatpickrInstance = null;
            }
            updateButtonStates();
        };
        // ----------------------------------
        // End Component: Programming Management
        // ----------------------------------
        
        // ----------------------------------
        // Component: Visor PDF Management
        // ----------------------------------
        const debugViaticos = () => {
            console.log('[debugViaticos] Debugging viaticos...');
            console.log('[debugViaticos] Viaticos count:', viaticos.value.length);
            viaticos.value.forEach((viatico, index) => {
                console.log(`[debugViaticos] Viatico ${index}:`, {
                    tercero: viatico.tercero.nombreTercero,
                    tipoTercero: viatico.tercero.tipoTercero,
                    startDate: viatico.event.startDate,
                    endDate: viatico.event.endDate,
                    destino: viatico.event.ciudadDestino,
                    eventId: viatico.eventId,
                    cost: viatico.cost
                });
                ['pf1', 'pf2', 'pf3'].forEach(prefix => {
                    const element = document.getElementById(`${prefix}-${index}`);
                    console.log(`[debugViaticos] Element ${prefix}-${index} exists:`, !!element);
                });
            });
        };

        const toggleVisorPDF = () => {
            showVisorPDF.value = !showVisorPDF.value;
            showTimeline.value = false;

            const calendarEl = document.getElementById('calendar');
            const timelineEl = document.getElementById('timeline');
            const visorPDFEl = document.getElementById('visorPDF');

            if (showVisorPDF.value) {
                if (calendarEl) calendarEl.classList.add('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.remove('hidden');
                nextTick(() => {
                    viaticos.value = [...viaticos.value]; // Force reactivity
                    debugViaticos();
                });
            } else {
                if (calendarEl) calendarEl.classList.remove('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.add('hidden');
                nextTick(() => {
                    if (calendarApi.value) {
                        calendarApi.value.render();
                        renderEvents();
                        calendarApi.value.updateSize();
                    } else {
                        reinitializeCalendar();
                    }
                });
            }
            updateButtonStates();
        };

        const generatePDF = async () => {
            if (viaticos.value.length === 0) {
                console.warn('[generatePDF] No viáticos available for PDF generation.');
                alert('No hay viáticos para generar el PDF.');
                return;
            }
        
            if (typeof window.html2canvas !== 'function') {
                console.error('[generatePDF] html2canvas is not loaded.');
                alert('Error: No se puede generar el PDF porque html2canvas no está disponible.');
                return;
            }
        
            if (typeof JSZip !== 'function') {
                console.error('[generatePDF] JSZip is not loaded.');
                alert('Error: No se puede generar el ZIP porque JSZip no está disponible.');
                return;
            }
        
            if (typeof saveAs !== 'function') {
                console.error('[generatePDF] FileSaver.js is not loaded.');
                alert('Error: No se puede guardar el ZIP porque FileSaver.js no está disponible.');
                return;
            }
        
            isGeneratingPDF.value = true;
            console.log('[generatePDF] Started PDF generation, showing loading modal.');
            console.log('[generatePDF] Viaticos:', viaticos.value.map(v => ({
                index: v.eventId,
                nombreTercero: v.tercero.nombreTercero,
                tipoTercero: v.tercero.tipoTercero,
                expectedElement: v.tercero.tipoTercero === 'CATEDRATICO' ? `pf1-${v.eventId}` : v.tercero.tipoTercero === 'SERVIDOR' ? `pf2-${v.eventId}` : `pf3-${v.eventId}`
            })));
        
            const { jsPDF } = window.jspdf;
            const zip = new JSZip();
            let pdfCount = 0;
        
            // Define letter size in pixels at 72 DPI
            const letterWidthPx = 612;
            const letterHeightPx = 792;
        
            // Generate PDFs in parallel
            const pdfPromises = viaticos.value.map(async (viatico, index) => {
                let templateId;
                switch (viatico.tercero.tipoTercero) {
                    case 'CATEDRATICO':
                        templateId = `pf1-${index}`;
                        break;
                    case 'SERVIDOR':
                        templateId = `pf2-${index}`;
                        break;
                    case 'CONTRATISTA':
                        templateId = `pf3-${index}`;
                        break;
                    default:
                        console.warn(`[generatePDF] Unknown tipoTercero for viático ${index}: ${viatico.tercero.tipoTercero}. Skipping.`);
                        return null;
                    }
        
                    const pageElement = document.getElementById(templateId);
                    if (!pageElement) {
                        console.warn(`[generatePDF] Page element ${templateId} not found for viático ${index}. Skipping.`);
                        return null;
                    }
        
                    try {
                        const doc = new jsPDF({
                            orientation: 'portrait',
                            unit: 'px',
                            format: [letterWidthPx, letterHeightPx],
                            compression: true
                        });
        
                        const originalDisplay = pageElement.style.display;
                        pageElement.style.display = 'block';
        
                        const elementWidth = pageElement.offsetWidth;
                        const elementHeight = pageElement.offsetHeight;
        
                        const canvas = await window.html2canvas(pageElement, {
                            scale: 2.5, // Increase scale for higher resolution
                            useCORS: true,
                            logging: true,
                            width: elementWidth,
                            height: elementHeight,
                            windowWidth: elementWidth,
                            windowHeight: elementHeight
                        });
        
                        pageElement.style.display = originalDisplay;
        
                        const imgData = canvas.toDataURL('image/jpeg', 0.90); // Increase JPEG quality to 90% for better visuals
                        const pdfWidth = doc.internal.pageSize.getWidth();
                        const pdfHeight = doc.internal.pageSize.getHeight();
        
                        doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'SLOW'); // Use SLOW compression for better quality
                        console.log(`[generatePDF] Generated PDF for viático ${index + 1}, template: ${templateId}.`);
        
                        const terceroName = viatico.tercero.nombreTercero.replace(/\s+/g, '_');
                        const destinoCity = viatico.event.ciudadDestino.replace(/\s+/g, '_');
                        const startDate = viatico.event.startDate.split('/').join('-');
                        const paddedIndex = String(index + 1).padStart(2, '0');
                        const filename = `${paddedIndex}_${terceroName}_${destinoCity}_${startDate}_${index + 1}.pdf`;
        
                        const pdfBlob = doc.output('blob');
                        console.log(`[generatePDF] PDF size for ${filename}: ${(pdfBlob.size / 1024).toFixed(2)} KB`);
                        return { filename, pdfBlob };
                    } catch (error) {
                        console.error(`[generatePDF] Error generating PDF for viático ${index + 1}, template ${templateId}:`, error);
                        return null;
                    }
                });
        
                // Wait for all PDFs to be generated
                const pdfResults = await Promise.all(pdfPromises);
        
                // Add valid PDFs to ZIP
                pdfResults.forEach(result => {
                    if (result) {
                        zip.file(result.filename, result.pdfBlob, { compression: 'DEFLATE', compressionOptions: { level: 6 } });
                        pdfCount++;
                        console.log(`[generatePDF] Added to ZIP: ${result.filename}, size: ${(result.pdfBlob.size / 1024).toFixed(2)} KB`);
                    }
                });
        
                if (pdfCount > 0) {
                    try {
                        const zipBlob = await zip.generateAsync({
                            type: 'blob',
                            compression: 'DEFLATE',
                            compressionOptions: { level: 6 }
                        });
                        saveAs(zipBlob, `comision_servicios_${new Date().toISOString().split('T')[0]}.zip`);
                        console.log('[generatePDF] Saved ZIP file with', pdfCount, 'PDFs, size:', (zipBlob.size / 1024 / 1024).toFixed(2), 'MB');
                    } catch (error) {
                        console.error('[generatePDF] Error generating ZIP file:', error);
                        alert('Error al generar el archivo ZIP: ' + error.message);
                    }
                } else {
                    console.warn('[generatePDF] No valid PDFs generated for ZIP.');
                    alert('No se generaron PDFs válidos para incluir en el ZIP.');
                }
        
                isGeneratingPDF.value = false;
                console.log('[generatePDF] Completed PDF generation, hiding loading modal.');
            };
        // ----------------------------------
        // End Component: Visor PDF Management
        // ----------------------------------

        // ----------------------------------
        // Component: Lifecycle Hooks
        // ----------------------------------
        onMounted(async () => {
            await loadTerceros();
            await loadCities();
            reinitializeCalendar();
            updateButtonStates();
        });

        onUnmounted(() => {
            if (calendarApi.value) {
                calendarApi.value.destroy();
                calendarApi.value = null;
            }
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                flatpickrInstance = null;
            }
            if (programmingFlatpickrInstance) {
                programmingFlatpickrInstance.destroy();
                programmingFlatpickrInstance = null;
            }
        });
        // ----------------------------------
        // End Component: Lifecycle Hooks
        // ----------------------------------

        // ----------------------------------
        // Component: Exposed Methods and Variables
        // ----------------------------------
        return {
            // State
            currentView,
            calendarApi,
            events,
            showModal,
            currentEvent,
            error,
            dateRangePicker,
            limitEvents,
            form,
            showProgrammingModal,
            programmingDateRangePicker,
            programmingRange,
            programmingEventsJson,
            showTercerosModal,
            terceros,
            searchQuery,
            showOptions,
            currentTercero,
            showTerceroForm,
            terceroForm,
            showPeriodoModal,
            periodos,
            currentPeriodo,
            periodoForm,
            showTimeline,
            timelineContainer,
            timelineModalState,
            DEPENDENCIA,
            viaticos,
            isGeneratingPDF,
            showVisorPDF,
            disabledButtons,
            viaticoStates, // CHANGE: Expose viaticoStates for modal select
            cities,
            origenQuery,
            destinoQuery,
            showOrigenOptions,
            showDestinoOptions,

            // Methods
            navigate,
            setView,
            goToToday,
            toggleEventLimit,
            openModal,
            closeModal,
            saveEvent,
            deleteEvent,
            editEvent,
            computeViatico,
            renderEvents,
            updateButtonStates,
            openTercerosModal,
            closeTercerosModal,
            openTerceroForm,
            closeTerceroForm,
            editTercero,
            saveTercero,
            deleteTercero,
            filterTerceros,
            selectTercero,
            hideOptions,
            filteredTerceros,
            openProgrammingModal,
            closeProgrammingModal,
            generateProgrammingJson,
            toggleVisorPDF,
            generatePDF,
            debugViaticos,
            formatCurrency,
            computeViaticoDetails,
            handleTransporteInput,
            handleRutaAdicionalInput,
            handleDescriptionInput,
            filterOrigenCities,
            filterDestinoCities,
            selectOrigenCity,
            selectDestinoCity,
            hideOrigenOptions,
            hideDestinoOptions,
            filteredOrigenCities,
            filteredDestinoCities,
            updateViaticaBasedOnEstado // CHANGE: Expose new method
        };
        // ----------------------------------
        // End Component: Exposed Methods and Variables
        // ----------------------------------
    }
});

// ----------------------------------
// Component: Mount Vue App
// ----------------------------------
app.mount('#app');
// ----------------------------------
// End Component: Mount Vue App
// ----------------------------------
</script>
<!-- ---------------------------------- -->
<!-- End Component: JavaScript and Vue app initialization -->
<!-- ---------------------------------- -->
</body>
</html>
