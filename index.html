<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Académico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://visjs.github.io/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <!-- PDF Viewer Styles -->
    <link rel="stylesheet" href="assets/base.min.css"/>
    <link rel="stylesheet" href="assets/fancy.min.css"/>
    <link rel="stylesheet" href="assets/main.css"/>
	<link rel="stylesheet" href="assets/styles.css"/>
    <style>
	button:disabled,
	button.disabled {
	    background-color: #d1d5db;
	    color: #6b7280;
	    opacity: 0.7;
	    cursor: not-allowed;
	    border-color: #d1d5db;
	}
	button:disabled:hover,
	button.disabled:hover {
	    background-color: #d1d5db;
	    color: #6b7280;
	}
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- ---------------------------------- -->
	<!-- Component: Header -->
	<!-- ---------------------------------- -->
	<header class="bg-blue-600 text-white shadow-lg">
	    <div class="px-4 py-3">
	        <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-2 md:space-y-0">
	            <div class="flex items-center justify-between">
	                <h1 class="text-xl md:text-2xl font-bold">Calendario Académico Header1</h1>
	                <div class="md:hidden">
	                    <button @click="setView('dayGridMonth')" :class="{'bg-blue-700': currentView === 'dayGridMonth'}" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-alt"></i>
	                    </button>
	                    <button @click="setView('dayGridWeek')" :class="{'bg-blue-700': currentView === 'dayGridWeek'}" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-week"></i>
	                    </button>
	                    <button @click="goToToday" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-day"></i>
	                    </button>
	                </div>
	            </div>
	            <div class="flex items-center justify-between space-x-2">
	                <div class="flex items-center space-x-2">
	                    <button @click="navigate('prev')" class="p-2 rounded-full hover:bg-blue-700">
	                        <i class="fas fa-chevron-left"></i>
	                    </button>
	                    <h2 id="calendar-title" class="text-base md:text-lg font-semibold">
	                        {{ getTitle() }}
	                    </h2>
	                    <button @click="navigate('next')" class="p-2 rounded-full hover:bg-blue-700">
	                        <i class="fas fa-chevron-right"></i>
	                    </button>
	                </div>
	                <div class="hidden md:flex space-x-2 ml-4">
	                    <button @click="setView('dayGridMonth')" :class="{'bg-blue-70': currentView === 'dayGridMonth'}" class="px-3 py-1 rounded-md flex items-center" :disabled="disabledButtons.month">
	                        <i class="fas fa-calendar-alt mr-2"></i>
	                        <span>Mes</span>
	                    </button>
	                    <button @click="setView('dayGridWeek')" :class="{'bg-blue-700': currentView === 'dayGridWeek'}" class="px-3 py-1 rounded-md flex items-center" :disabled="disabledButtons.week">
	                        <i class="fas fa-calendar-week mr-2"></i>
	                        <span>Semana</span>
	                    </button>
	                    <button @click="goToToday" class="px-3 py-1 rounded-md flex items-center hover:bg-blue-700" :disabled="disabledButtons.today">
	                        <i class="fas fa-calendar-day mr-2"></i>
	                        <span>Hoy</span>
	                    </button>
	                    <button @click="openPeriodoModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.periodo">
	                        <i class="fas fa-calendar mr-2"></i>
	                        <span>Periodo</span>
	                    </button>
	                    <button @click="toggleTimeline" :class="{'bg-blue-700': showTimeline}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.timeline">
	                        <i class="fas fa-list-alt mr-2"></i>
	                        <span>Cronograma</span>
	                    </button>
	                    <button @click="toggleVisorPDF" :class="{'bg-blue-700': showVisorPDF}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.visorPDF">
	                        <i class="fas fa-file-pdf mr-2"></i>
	                        <span>Visor PDF</span>
	                    </button>
	                    <button @click="openTercerosModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.terceros">
	                        <i class="fas fa-users"></i>
	                    </button>
	                    <button @click="openProgrammingModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.programming">
	                        <i class="fas fa-list"></i>
	                    </button>
	                    <button @click="toggleEventLimit" :disabled="currentView !== 'dayGridMonth' || disabledButtons.eventLimit" :class="{'bg-blue-700': limitEvents, 'bg-gray-400 cursor-not-allowed': currentView !== 'dayGridMonth'}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700">
	                        <i :class="limitEvents ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
	                    </button>
	                </div>
	            </div>
	        </div>
	    </div>
	</header>
	<!-- ---------------------------------- -->
	<!-- End Component: Header -->
	<!-- ---------------------------------- -->

        <!-- ---------------------------------- -->
        <!-- Component: Calendar -->
        <!-- ---------------------------------- -->
        <div id="calendar" class="flex-1" v-show="!showTimeline"></div>
        <!-- ---------------------------------- -->
        <!-- End Component: Calendar -->
        <!-- ---------------------------------- -->

        <!-- ---------------------------------- -->
	<!-- Component: Event Modal -->
	<!-- ---------------------------------- -->
	<div v-if="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
		<div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
			<div class="p-6">
				<div class="flex justify-between items-center mb-4">
					<h3 class="text-lg font-semibold text-gray-900">
						{{ currentEvent ? 'Editar Viático' : 'Nuevo Viático' }}
					</h3>
					<div class="flex items-center space-x-3">
						<div class="flex items-center">
							<label for="viatica" class="text-sm font-medium text-gray-700 mr-2">Viática</label>
							<input type="checkbox" id="viatica" v-model="form.viatica" class="h-6 w-6 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
						</div>
						<button @click="closeModal" class="text-gray-400 hover:text-gray-500">
							<i class="fas fa-times"></i>
						</button>
					</div>
				</div>
				<div v-if="error" class="mb-4 p-2 bg-red-100 text-red-700 rounded-md">
					{{ error }}
				</div>
				<form @submit.prevent="saveEvent">
					<div class="space-y-4">
						<div>
							<div class="relative">
								<input
									id="title"
									v-model="searchQuery"
									@focus="showOptions = true"
									@blur="hideOptions"
									@input="filterTerceros"
									placeholder="Selecciona un tercero..."
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
								<div v-if="showOptions && filteredTerceros.length" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
									<div
										v-for="tercero in filteredTerceros"
										:key="tercero.id"
										class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
										@mousedown="selectTercero(tercero)"
									>
										{{ tercero.nombreTercero }}
									</div>
								</div>
								<div v-else-if="showOptions" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
									<div class="px-3 py-2 text-gray-500">No se encontraron resultados</div>
								</div>
							</div>
							<input type="hidden" v-model="form.terceroId" name="terceroId" />
						</div>
						<div>
							<label for="description" class="block text-sm font-medium text-gray-700">Descripción de la comisión de servicios o salida de campo</label>
							<textarea
								id="description"
								v-model="form.description"
								@input="handleDescriptionInput"
								rows="3"
								maxlength="120"
								class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
							></textarea>
						</div>
						<div class="grid grid-cols-2 gap-4">
							<div class="relative">
								<label for="origen" class="block text-sm font-medium text-gray-700">Origen</label>
								<input
									id="origen"
									v-model="origenQuery"
									@focus="showOrigenOptions = true"
									@blur="hideOrigenOptions"
									@input="filterOrigenCities"
									placeholder="Selecciona una ciudad..."
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
								<div v-if="showOrigenOptions && filteredOrigenCities.length" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
									<div
										v-for="city in filteredOrigenCities"
										:key="city.id"
										class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
										@mousedown="selectOrigenCity(city)"
									>
										{{ city.nombreCiudad }}
									</div>
								</div>
								<div v-else-if="showOrigenOptions" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
									<div class="px-3 py-2 text-gray-500">No hay resultados</div>
								</div>
							</div>
							<div class="relative">
								<label for="destino" class="block text-sm font-medium text-gray-700">Destino</label>
								<input
									id="destino"
									v-model="destinoQuery"
									@focus="showDestinoOptions = true"
									@blur="hideDestinoOptions"
									@input="filterDestinoCities"
									placeholder="Selecciona una ciudad..."
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
								<div v-if="showDestinoOptions && filteredDestinoCities.length" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
									<div
										v-for="city in filteredDestinoCities"
										:key="city.id"
										class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
										@mousedown="selectDestinoCity(city)"
									>
										{{ city.nombreCiudad }}
									</div>
								</div>
								<div v-else-if="showDestinoOptions" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
									<div class="px-3 py-2 text-gray-500">No hay resultados</div>
								</div>
							</div>
						</div>
						<div class="grid grid-cols-2 gap-4">
							<div>
								<label for="dateRange" class="block text-sm font-medium text-gray-700">Rango de Fechas *</label>
								<input type="text" id="dateRange" ref="dateRangePicker" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
							</div>
							<div>
								<label for="rutaAdicional" class="block text-sm font-medium text-gray-700">Ruta Adicional</label>
								<input
									type="text"
									id="rutaAdicional"
									v-model="form.rutaAdicional"
									@input="handleRutaAdicionalInput"
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
							</div>
						</div>
						<div class="flex items-end gap-4">
							<div class="flex-1">
								<label for="transporte" class="block text-sm font-medium text-gray-700">Transporte</label>
								<input
									type="text"
									id="transporte"
									v-model="form.transporte"
									@input="handleTransporteInput"
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
							</div>
							<div class="flex-1">
								<label for="color" class="block text-sm font-medium text-gray-700">Color</label>
								<select id="color" v-model="form.color" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
									<option value="#3b82f6">Azul</option>
									<option value="#10b981">Verde</option>
									<option value="#8b5cf6">Morado</option>
									<option value="#f59e0b">Amarillo</option>
									<option value="#ef4444">Rojo</option>
								</select>
							</div>
							<div class="flex space-x-3 items-end">
								<button v-if="currentEvent" type="button" @click="deleteEvent" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
									Eliminar
								</button>
								<button type="button" @click="closeModal" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
									Cancelar
								</button>
								<button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
									Guardar
								</button>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- ---------------------------------- -->
	<!-- End Component: Event Modal -->
	<!-- ---------------------------------- -->
		
        <!-- ---------------------------------- -->
        <!-- Component: Visor PDF -->
        <!-- ---------------------------------- -->
        <div id="visorPDF" class="flex-1" v-show="showVisorPDF">
            
                <!-- Generar PDF Button -->
				<button @click="generatePDF" class="generate-pdf-button">Generar PDF</button>
                <!-- Added hidden #outline element to satisfy theViewer -->
                <div id="outline" style="display: none;"></div>
                <div v-if="viaticos.length === 0" class="text-center text-gray-500 py-4">
                    No hay viáticos disponibles para mostrar. Por favor, genera la programación primero.
                </div>

		<div v-for="(viatico, index) in viaticos" :key="index" :id="'pf1-' + index" class="pf w0 h0" :data-page-no="index + 1">
		    <div class="pc pc1 w0 h0">
		        <img class="bi x0 y0 w1 h1" alt="" src="assets/bg1.png" />
		        <div class="c x1 y1 w2 h2">
		            <div class="t m0 x2 h3 y2 ff1 fs0 fc0 sc0 ls0 ws0">FORMATO DE AUTORIZACIÓN, SOLICITUD DE TRÁMITE Y AUTOLIQUIDACIÓN DE COMISIONES</div>
		            <div class="t m0 x2 h3 y3 ff1 fs0 fc0 sc0 ls0 ws0">DE SERVICIOS Y SALIDAS DE CAMPO AL INTERIOR DEL PAÍS DE CATEDRÁTICOS, DOCENTES</div>
		            <div class="t m0 x3 h3 y4 ff1 fs0 fc0 sc0 ls0 ws0">CAPACITADORES E INVESTIGADORES</div>
		        </div>
		        <div class="c x4 y5 w3 h4"><div class="t m0 x5 h3 y6 ff1 fs0 fc0 sc0 ls0 ws0">CODIGO: GF-FO-023</div></div>
		        <div class="c x4 y7 w3 h5"><div class="t m0 x5 h3 y8 ff1 fs0 fc0 sc0 ls0 ws0">VERSION: 04</div></div>
		        <div class="c x4 y1 w3 h4"><div class="t m0 x5 h3 y9 ff1 fs0 fc0 sc0 ls0 ws0">FECHA: 03/04/2025</div></div>
		        <div class="c x0 ya w4 h6"><div class="t m1 x6 h7 yb ff2 fs1 fc1 sc1 ls0 ws0">D i l i g e n c i e o s e l e c c i o n e ú n i c a m e n t e y a c o m p l e t i t u d l o s c a m p o s e n g r i s</div></div>
		        <div class="c x0 yc w5 h8"><div class="t m0 x5 h3 yd ff1 fs0 fc2 sc2 ls0 ws0">Dependencia solicitante:</div></div>
		        <div class="c x7 yc w6 h8"><div class="t m0 x8 h3 yd ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.dependencia || '' }}</div></div>
		        <div class="c x9 yc w7 h8"><div class="t m0 xa h3 yd ff1 fs0 fc2 sc2 ls0 ws0">FECHA DE AUTOLIQUIDACIÓN</div></div>
		        <div class="c x4 yc w3 h8"><div class="t m0 xb h3 yd ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.currentDate || '' }}</div></div>
		        <div class="c x0 ye w4 h9"><div class="t m0 x5 h3 yf ff1 fs0 fc2 sc2 ls0 ws0">1. DATOS DEL CATEDRÁTICO / INVESTIGADOR / DOCENTE CAPACITADOR</div></div>
		        <div class="c x0 y10 w5 ha"><div class="t m0 x5 h3 y11 ff1 fs0 fc2 sc2 ls0 ws0">Nombre completo</div></div>
		        <div class="c x7 y10 w8 ha"><div class="t m0 xc h3 y11 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div></div>
		        <div class="c xd y10 w9 ha"><div class="t m0 xe h3 y11 ff1 fs0 fc2 sc2 ls0 ws0">Fecha de Nacimiento (dd/mm/aaaa)</div></div>
		        <div class="c xf y10 wa ha"><div class="t m0 x10 h3 y11 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.nacimiento || '' }}</div></div>
		        <div class="c x0 y12 w5 hb"><div class="t m0 x5 h3 y13 ff1 fs0 fc2 sc2 ls0 ws0">C.C. No.</div></div>
		        <div class="c x7 y12 wb hb"><div class="t m0 xc h3 y13 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.numeroDocumentoTercero || '' }}</div></div>
		        <div class="c x11 y12 wc hb"><div class="t m0 x5 h3 y13 ff1 fs0 fc2 sc2 ls0 ws0">Correo electrónico</div></div>
		        <div class="c x9 y12 wd hb"><div class="t m0 x3 hc y13 ff3 fs0 fc2 sc3 ls0 ws0">{{ viatico?.tercero?.correo || '' }}</div></div>
		        <div class="c x0 y14 w5 hd">
		            <div class="t m0 x5 h3 y15 ff1 fs0 fc2 sc2 ls0 ws0">Teléfono de contacto y/o</div>
		            <div class="t m0 x5 h3 y16 ff1 fs0 fc2 sc2 ls0 ws0">Celular</div>
		        </div>
		        <div class="c x7 y14 wb hd"><div class="t m0 x12 h3 y17 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.telefono || '' }}</div></div>
		        <div class="c x11 y14 wc hd"><div class="t m0 x5 h3 y17 ff1 fs0 fc2 sc2 ls0 ws0">Entidad Bancaria</div></div>
		        <div class="c x9 y14 wd hd"><div class="t m0 x13 he y17 ff4 fs0 fc2 sc3 ls0 ws0">{{ viatico?.tercero?.entidadBancaria || '' }}</div></div>
		        <div class="c x0 y18 w5 hb"><div class="t m0 x5 h3 y19 ff1 fs0 fc2 sc2 ls0 ws0">Rol ESAP:</div></div>
		        <div class="c x7 y18 w6 hb"><div class="t m0 x14 h3 y19 ff1 fs0 fc2 sc2 ls0 ws0">Docente catedrático - Capacitadores</div></div>
		        <div class="c x9 y18 we hb"><div class="t m0 x15 h3 y19 ff1 fs0 fc2 sc2 ls0 ws0">TIPO DE CUENTA:</div></div>
		        <div class="c xd y18 wf hb"><div class="t m0 x6 h3 y19 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.tipoCuenta || '' }}</div></div>
		        <div class="c x0 y1a w5 hf">
		            <div class="t m0 x5 h3 y1b ff1 fs0 fc2 sc2 ls0 ws0">Categoría docente</div>
		            <div class="t m0 x5 h3 y1c ff1 fs0 fc2 sc2 ls0 ws0">catedrático o investigador</div>
		        </div>
		        <div class="c x7 y1a w6 hf"><div class="t m0 x7 h3 y1d ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div></div>
		        <div class="c x9 y1a we hf"><div class="t m0 x10 h3 y1d ff1 fs0 fc2 sc2 ls0 ws0">No. DE CUENTA:</div></div>
		        <div class="c xd y1a wf hf"><div class="t m0 x14 h3 y1d ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.tercero?.cuentaBancaria || '' }}</div></div>
		        <div class="c x0 y1e w4 h10"><div class="t m0 x5 h3 y1f ff1 fs0 fc2 sc2 ls0 ws0">2. DATOS DE LA COMISIÓN DE SERVICIOS O SALIDA DE CAMPO</div></div>
		        <div class="c x0 y20 w5 h11">
		            <div class="t m0 x16 h3 y21 ff1 fs0 fc2 sc2 ls0 ws0">Duración de la comisión de</div>
		            <div class="t m0 x16 h3 y22 ff1 fs0 fc2 sc2 ls0 ws0">servicios o salida de campo</div>
		            <div class="t m0 x17 h3 y23 ff1 fs0 fc2 sc2 ls0 ws0">en días:</div>
		        </div>
		        <div class="c x7 y20 w10 h11"><div class="t m0 x18 h3 y24 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.duracion || '' }}</div></div>
		        <div class="c x1 y25 w11 h12"><div class="t m0 x19 h3 y26 ff1 fs0 fc2 sc2 ls0 ws0">Fecha de inicio</div></div>
		        <div class="c x11 y25 wc h12"><div class="t m0 x17 hc y27 ff3 fs0 fc2 sc3 ls0 ws0">{{ viatico?.event?.startDate || '' }}</div></div>
		        <div class="c x9 y25 we h12">
		            <div class="t m0 x1a h3 y26 ff1 fs0 fc2 sc2 ls0 ws0">Hora de vuelo ida:</div>
		            <div class="t m0 xb h3 y28 ff1 fs0 fc2 sc2 ls0 ws0">(estimada</div>
		        </div>
		        <div class="c xd y25 w12 h12"><div class="t m0 xa hc y27 ff3 fs0 fc2 sc3 ls0 ws0">7:00</div></div>
		        <div class="c x4 y25 w3 h12"><div class="t m0 x1b h3 y27 ff1 fs0 fc2 sc2 ls0 ws0">Itinerario detallado:</div></div>
		        <div class="c x1 y20 w11 h13"><div class="t m0 x1c h3 y29 ff1 fs0 fc2 sc2 ls0 ws0">Fecha de finalización</div></div>
		        <div class="c x11 y20 wc h13"><div class="t m0 x1d hc y29 ff3 fs0 fc2 sc3 ls0 ws0">{{ viatico?.event?.endDate || '' }}</div></div>
		        <div class="c x9 y20 we h13">
		            <div class="t m0 x0 h3 y2a ff1 fs0 fc2 sc2 ls0 ws0">Hora de vuelo regreso:</div>
		            <div class="t m0 x1e h3 y2b ff1 fs0 fc2 sc2 ls0 ws0">(estimada)</div>
		        </div>
		        <div class="c xd y20 w12 h13"><div class="t m0 x19 hc y29 ff3 fs0 fc2 sc3 ls0 ws0">16:00</div></div>
		        <div class="c x4 y20 w3 h13"><div class="t m0 x0 h14 y2c ff3 fs2 fc3 sc3 ls0 ws0">{{ viatico?.event?.itinerario || '' }}</div></div>
		        <div class="c x0 y2d w5 h8"><div class="t m0 x5 h3 y2e ff1 fs0 fc2 sc2 ls0 ws0">Departamento</div></div>
		        <div class="c x7 y2d w6 h8"><div class="t m0 x1f h3 y2e ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.event?.ciudadDestinoDepartamento || '' }}</div></div>
		        <div class="c x9 y2d w7 h8"><div class="t m0 x20 h3 y2e ff1 fs0 fc2 sc2 ls0 ws0">Requiere tiquetes aéreos</div></div>
		        <div class="c x4 y2d w3 h8"><div class="t m0 x8 h3 y2e ff1 fs0 fc2 sc2 ls0 ws0">NO</div></div>
		        <div class="c x0 y2f w5 h15">
		            <div class="t m0 x5 h3 y30 ff1 fs0 fc2 sc2 ls0 ws0">Municipio / Isla / área no</div>
		            <div class="t m0 x5 h3 y31 ff1 fs0 fc2 sc2 ls0 ws0">municipalizada</div>
		        </div>
		        <div class="c x7 y2f w6 h15"><div class="t m0 x6 h3 y32 ff1 fs0 fc2 sc2 ls0 ws0">{{ viatico?.event?.ciudadDestino || '' }}</div></div>
		        <div class="c x9 y2f w7 h15"><div class="t m0 x21 h3 y32 ff1 fs0 fc2 sc2 ls0 ws0">Aeropuerto Destino</div></div>
		        <div class="c x4 y2f w3 h15"><div class="t m0 xa h3 y32 ff1 fs0 fc2 sc2 ls0 ws0">VALLE DEL CAUCA (Palmira)</div></div>
		        <div class="c x0 y33 w5 h16"><div class="t m0 x5 h3 y34 ff1 fs0 fc2 sc2 ls0 ws0">Objeto</div></div>
		        <div class="c x7 y33 w13 h16"><div class="t m0 x21 hc y34 ff3 fs0 fc2 sc3 ls0 ws0">{{ viatico?.event?.description || '' }}</div></div>
		        <div class="c x0 y35 w4 h8"><div class="t m0 x5 h3 y36 ff1 fs0 fc2 sc2 ls0 ws0">3. LIQUIDACIÓN DE LA COMISIÓN DE SERVICIOS O SALIDA DE CAMPO</div></div>
		        <div class="c x0 y37 w14 h17"><div class="t m0 x22 h3 y38 ff1 fs0 fc2 sc2 ls0 ws0">Descripción del día</div></div>
		        <div class="c x11 y37 wc h17"><div class="t m0 x18 h3 y38 ff1 fs0 fc2 sc2 ls0 ws0">No. de Días</div></div>
		        <div class="c x9 y37 w7 h17"><div class="t m0 x23 h3 y38 ff1 fs0 fc2 sc2 ls0 ws0">Viáticos Diario</div></div>
		        <div class="c x4 y37 w3 h17"><div class="t m0 x24 h3 y38 ff1 fs0 fc2 sc2 ls0 ws0">Total</div></div>
		        <div class="c x0 y39 w14 h17"><div class="t m0 x25 hc y3a ff3 fs0 fc2 sc3 ls0 ws0">Pernoctados</div></div>
		        <div class="c x11 y39 wc h17"><div class="t m0 x21 hc y3a ff3 fs0 fc2 sc3 ls0 ws0">1</div></div>
		        <div class="c x9 y39 w7 h17">
		            <div class="t m0 x5 hc y3a ff3 fs0 fc2 sc3 ls0 ws0">$ <span class="_ _0"> </span>293,886</div>
		        </div>
		        <div class="c x4 y39 w3 h17">
		            <div class="t m0 x5 hc y3a ff3 fs0 fc2 sc3 ls0 ws0">$ <span class="_ _1"> </span>293,886</div>
		        </div>
		        <div class="c x0 y3b w14 h17"><div class="t m0 x26 hc y3c ff3 fs0 fc2 sc3 ls0 ws0">No Pernoctados</div></div>
		        <div class="c x11 y3b wc h17"><div class="t m0 x21 hc y3c ff3 fs0 fc2 sc3 ls0 ws0">1</div></div>
		        <div class="c x9 y3b w7 h17">
		            <div class="t m0 x5 hc y3c ff3 fs0 fc2 sc3 ls0 ws0">$ <span class="_ _0"> </span>146,943</div>
		        </div>
		        <div class="c x4 y3b w3 h17">
		            <div class="t m0 x5 hc y3c ff3 fs0 fc2 sc3 ls0 ws0">$ <span class="_ _1"> </span>146,943</div>
		        </div>
		        <div class="c x0 y3d w15 h17"><div class="t m0 x27 h3 y3e ff1 fs0 fc2 sc2 ls0 ws0">Total Viáticos o auxilio económico de desplazamiento</div></div>
		        <div class="c x4 y3d w3 h17">
		            <div class="t m0 x5 h3 y3e ff1 fs0 fc2 sc2 ls0 ws0">$ <span class="_ _1"> </span>440,829</div>
		        </div>
		        <div class="c x0 y3f w4 h17"><div class="t m0 x5 h3 y40 ff1 fs0 fc2 sc2 ls0 ws0">4. LIQUIDACIÓN DE GASTOS DE TRANSPORTE Y/O AUXILIOS ECONÓMICOS DE DESPLAZAMIENTO</div></div>
		        <div class="c x0 y41 w14 h17"><div class="t m0 x28 h3 y42 ff1 fs0 fc2 sc2 ls0 ws0">Descripción</div></div>
		        <div class="c x11 y41 w16 h17"><div class="t m0 x29 h3 y42 ff1 fs0 fc2 sc2 ls0 ws0">Total</div></div>
		        <div class="c x0 y43 w14 h18">
		            <div class="t m0 x10 h3 y44 ff1 fs0 fc2 sc2 ls0 ws0">Total gastos de transporte / auxilios económicos de desplazamientos</div>
		            <div class="t m0 x2a h3 y45 ff1 fs0 fc2 sc2 ls0 ws0">terminales aéreos</div>
		        </div>
		        <div class="c x11 y43 w16 h18">
		            <div class="t m0 x5 h3 y46 ff1 fs0 fc2 sc2 ls0 ws0">$ <span class="_ _2"> </span>-</div>
		        </div>
		        <div class="c x0 y47 w14 h18"><div class="t m0 x16 h3 y48 ff1 fs0 fc2 sc2 ls0 ws0">Transporte y desplazamiento por vía terrestre, marítimo, fluvial y/o ferroviario</div></div>
		        <div class="c x11 y47 w16 h18">
		            <div class="t m0 x5 h3 y48 ff1 fs0 fc2 sc2 ls0 ws0">$ <span class="_ _3"> </span>{{ viatico?.event?.transporte || '' }}</div>
		        </div>
		        <div class="c x0 y49 w14 h18">
		            <div class="t m0 x1c h3 y4a ff1 fs0 fc2 sc2 ls0 ws0">TOTAL GASTOS DE TRANSPORTE Y/O AUXILIOS ECONÓMICOS DE</div>
		            <div class="t m0 x1f h3 y4b ff1 fs0 fc2 sc2 ls0 ws0">DESPLAZAMIENTO</div>
		        </div>
		        <div class="c x11 y49 w16 h18">
		            <div class="t m0 x5 h3 y4c ff1 fs0 fc2 sc2 ls0 ws0">$ <span class="_ _4"> </span>470,429</div>
		        </div>
		        <div class="c x0 y4d w4 h19"><div class="t m0 x5 h3 y4e ff1 fs0 fc2 sc2 ls0 ws0">5. INFORMACIÓN FINANCIERA DE LA COMISIÓN DE SERVICIOS O SALIDA DE CAMPO</div></div>
		        <div class="c x0 y4f w4 h1a">
		            <div class="t m0 x5 hc y50 ff3 fs0 fc2 sc3 ls0 ws0">
		                El pago de la presente comisión de servicios / autorización de desplazamiento, se hará con cargo a 0072DP - DECANATURA PREGRADO, del Rubro C-0503-1000-16-20203K0503014-02, según
		            </div>
		            <div class="t m0 x5 hc y51 ff3 fs0 fc2 sc3 ls0 ws0">Certificado de Disponibilidad Presupuestal No. 4325 del 04/02/2025</div>
		        </div>
		        <div class="c x0 y52 w5 h1b">
		            <div class="t m0 x5 hc y53 ff3 fs0 fc2 sc3 ls0 ws0">_________________________</div>
		            <div class="t m0 x5 hc y54 ff3 fs0 fc2 sc3 ls0 ws0">________________________</div>
		            <div class="t m0 x5 hc y55 ff3 fs0 fc2 sc3 ls0 ws0">_________________________</div>
		            <div class="t m0 x5 hc y56 ff3 fs0 fc2 sc3 ls0 ws0">_________________________</div>
		            <div class="t m0 x5 hc y57 ff3 fs0 fc2 sc3 ls0 ws0">____</div>
		            <div class="t m0 x5 hc y58 ff3 fs0 fc2 sc3 ls0 ws0">Firma Jefe de Dependencia</div>
		            <div class="t m0 x5 hc y59 ff3 fs0 fc2 sc3 ls0 ws0">Firma Gerente de Proyecto</div>
		        </div>
		        <div class="c x7 y5a wb h1c"><div class="t m0 x18 hc y5b ff3 fs0 fc2 sc3 ls0 ws0">Carmen Marlene Rojas Gallego</div></div>
		        <div class="c xd y5a w9 h1c"><div class="t m0 x0 hc y5b ff3 fs0 fc2 sc3 ls0 ws0">Yeimi Viviana Agudo Rodriguez</div></div>
		        <div class="c x0 y5c w17 h1d"><div class="t m0 x2b hc y5d ff3 fs0 fc2 sc3 ls0 ws0">Coordinadora Académica</div></div>
		        <div class="c x9 y5c wd h1d"><div class="t m0 x2c hc y5d ff3 fs0 fc2 sc3 ls0 ws0">Directora Territorial</div></div>
		        <div class="c x0 y5e w15 h1e"><div class="t m0 x5 h1f y5f ff3 fs3 fc2 sc3 ls0 ws0">Elaboró: Carmen Marlene Rojas, Profesional Especializado</div></div>
		        <div class="c x4 y60 w3 h20">
		            <div class="t m0 x0 h3 y61 ff1 fs0 fc2 sc2 ls0 ws0">La información recolectada en este</div>
		            <div class="t m0 xe h3 y62 ff1 fs0 fc2 sc2 ls0 ws0">documento es tratada bajo la política de</div>
		            <div class="t m0 x2d h3 y63 ff1 fs0 fc2 sc2 ls0 ws0">Datos Personales de la ESAP en</div>
		            <div class="t m0 x15 h3 y64 ff1 fs0 fc2 sc2 ls0 ws0">cumplimiento a la Ley1581de2012</div>
		        </div>
		        <div class="c x0 y65 w15 h21"><div class="t m0 x5 h1f y66 ff3 fs3 fc2 sc3 ls0 ws0">Revisó: Carmen Marlene Rojas, Profesional Especializado</div></div>
		        <div class="c x0 y60 w15 h22"><div class="t m0 x5 h1f y67 ff3 fs3 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
		    </div>
		    <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
		</div>
                
                <div class="loading-indicator"></div>
            
        </div>
        <!-- ---------------------------------- -->
        <!-- End Component: Visor PDF -->
        <!-- ---------------------------------- -->


        <!-- ---------------------------------- -->
        <!-- Component: Programming Modal -->
        <!-- ---------------------------------- -->
        <div v-if="showProgrammingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Programación</h3>
                        <button @click="closeProgrammingModal" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="programmingDateRange" class="block text-sm font-medium text-gray-700">Seleccionar Rango de Fechas</label>
                            <input type="text" id="programmingDateRange" ref="programmingDateRangePicker" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div v-if="programmingEventsJson" class="mt-4">
                            <label class="block text-sm font-medium text-gray-700">Total eventos: {{ programmingEventsJson ? JSON.parse(programmingEventsJson).length : 0 }}</label>
                            <pre class="bg-gray-100 p-4 rounded-md overflow-auto max-h-60">{{ programmingEventsJson }}</pre>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeProgrammingModal" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Cerrar
                        </button>
                        <button type="button" @click="generateProgrammingJson" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Aceptar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ---------------------------------- -->
        <!-- End Component: Programming Modal -->
        <!-- ---------------------------------- -->


    </div>
  
    <!-- JavaScript and Vue app initialization -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://visjs.github.io/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>    
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ----------------------------------
// Component: Vue Setup and Imports
// ----------------------------------
const { createApp, ref, onMounted, onUnmounted, nextTick, computed, reactive } = Vue;

// Mock data for terceros
const mockTerceros = [
    { id: '1', ccTercero: 'CC001', nombreTercero: 'Juan Pérez', inicialTercero: 'JP', tipoDocumentoTercero: '03', numeroDocumentoTercero: '12345678', props: { tipoTercero: 'CONTRATISTA', baseLiquidacion: '5000000', cargoServidor: 'Contratista', entidadBancaria: 'BANCOLOMBIA', cuentaBancaria: '1234567890', tipoCuenta: 'Ahorro', telefono: '3001234567', correo: 'juan.perez@example.com', fechaNacimiento: '1980-05-15', contrato: 'C001' } },
    { id: '2', ccTercero: 'CC002', nombreTercero: 'María Gómez', inicialTercero: 'MG', tipoDocumentoTercero: '03', numeroDocumentoTercero: '87654321', props: { tipoTercero: 'CATEDRATICO', baseLiquidacion: '3000000', cargoServidor: 'Hora Catedra', entidadBancaria: 'BANCO DAVIVIENDA', cuentaBancaria: '0987654321', tipoCuenta: 'Corriente', telefono: '3109876543', correo: 'maria.gomez@example.com', fechaNacimiento: '1990-08-22', contrato: 'C002' } },
    { id: '3', ccTercero: 'CC003', nombreTercero: 'Carlos López', inicialTercero: 'CL', tipoDocumentoTercero: '03', numeroDocumentoTercero: '11223344', props: { tipoTercero: 'SERVIDOR', baseLiquidacion: '4000000', cargoServidor: 'Servidor', entidadBancaria: 'BANCO DE BOGOTA', cuentaBancaria: '4567891234', tipoCuenta: 'Ahorro', telefono: '3204567890', correo: 'carlos.lopez@example.com', fechaNacimiento: '1975-03-10', contrato: 'C003' } }
];

// Mock data source simulation
const TerceroDataSource = async () => {
    return new Promise((resolve) => {
        setTimeout(() => resolve([...mockTerceros]), 500);
    });
};

// Mock data for cities
const mockCities = [
    { id: '1', nombreCiudad: 'CALI', departamento: 'VALLE', categoria: 1 },
    { id: '2', nombreCiudad: 'BOGOTA', departamento: 'CUNDINAMARCA', categoria: 2 },
    { id: '3', nombreCiudad: 'MEDELLIN', departamento: 'ANTIOQUIA', categoria: 1 },
    { id: '4', nombreCiudad: 'CARTAGENA', departamento: 'BOLIVAR', categoria: 3 },
    { id: '5', nombreCiudad: 'BARRANQUILLA', departamento: 'ATLANTICO', categoria: 2 },
    { id: '6', nombreCiudad: 'PEREIRA', departamento: 'RISARALDA', categoria: 1 }
];

// Mock data source simulation for cities
const CityDataSource = async () => {
    return new Promise((resolve) => {
        setTimeout(() => resolve([...mockCities]), 500);
    });
};
// ----------------------------------
// End Component: Vue Setup and Imports
// ----------------------------------

const app = createApp({
    setup() {
        // ----------------------------------
        // Component: State management
        // ----------------------------------
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const currentView = ref('dayGridMonth');
        const calendarApi = ref(null);
        const events = ref(JSON.parse(localStorage.getItem('academicEvents')) || []);
        const showModal = ref(false);
        const currentEvent = ref(null);
        const error = ref(null);
        const dateRangePicker = ref(null);
        const limitEvents = ref(true);
        const form = ref({
            title: '',
            description: '',
            startDate: '',
            endDate: '',
            color: '#3b82f6',
            terceroId: '',
            viatica: true,
            transporte: '',
            origen: '',
            destino: '',
            rutaAdicional: ''
        });
        const showProgrammingModal = ref(false);
        const programmingDateRangePicker = ref(null);
        const programmingRange = ref({ start: '', end: '' });
        const programmingEventsJson = ref(null);
        const showTercerosModal = ref(false);
        const terceros = ref([]);
        const searchQuery = ref('');
        const showOptions = ref(false);
        const currentTercero = ref(null);
        const showTerceroForm = ref(false);
        const terceroForm = ref({
            id: '',
            ccTercero: '',
            nombreTercero: '',
            inicialTercero: '',
            tipoDocumentoTercero: '03',
            numeroDocumentoTercero: '',
            props: {
                tipoTercero: 'CONTRATISTA',
                baseLiquidacion: '',
                cargoServidor: 'Servidor',
                entidadBancaria: 'BANCOLOMBIA',
                cuentaBancaria: '',
                tipoCuenta: 'Ahorro',
                telefono: '',
                correo: '',
                fechaNacimiento: '',
                contrato: ''
            }
        });
        let flatpickrInstance = null;
        let programmingFlatpickrInstance = null;
        const showPeriodoModal = ref(false);
        const periodos = ref(JSON.parse(localStorage.getItem('periodos')) || []);
        const currentPeriodo = ref(null);
        const periodoForm = ref({
            periodo: '2025-1',
            centro: 'CALI',
            programa: 'ADMINISTRACION PUBLICA',
            semestres: Array(10).fill(false),
            asignaturas: {}
        });
        const showTimeline = ref(false);
        const timelineContainer = ref(null);
        let timeline = null;
        const timelineModalState = reactive({
            isOpen: false,
            action: 'add',
            eventData: { id: '', content: '', group: '', start: '', end: '' }
        });
        const DEPENDENCIA = "0072DP - DECANATURA PREGRADO";
        const viaticos = ref([]);
        const showVisorPDF = ref(false);
        const disabledButtons = ref({
            month: false,
            week: false,
            today: false,
            periodo: false,
            timeline: false,
            visorPDF: false,
            terceros: false,
            programming: false,
            eventLimit: false
        });

        // ----------------------------------
        // Component: Button State Management
        // ----------------------------------
        const updateButtonStates = () => {
            if (showTimeline.value) {
                disabledButtons.value = {
                    month: true,
                    week: true,
                    today: true,
                    periodo: true,
                    timeline: false,
                    visorPDF: true,
                    terceros: true,
                    programming: true,
                    eventLimit: true
                };
            } else if (showVisorPDF.value) {
                disabledButtons.value = {
                    month: true,
                    week: true,
                    today: true,
                    periodo: true,
                    timeline: true,
                    visorPDF: false,
                    terceros: true,
                    programming: true,
                    eventLimit: true
                };
            } else {
                disabledButtons.value = {
                    month: false,
                    week: false,
                    today: false,
                    periodo: false,
                    timeline: false,
                    visorPDF: false,
                    terceros: false,
                    programming: false,
                    eventLimit: currentView.value !== 'dayGridMonth'
                };
            }
            // Note: To apply a 'disabled' class, update the template to include
            // :class="{ disabled: disabledButtons.month }" (or similar) for each button.
            // Example for month button: <button :class="{ disabled: disabledButtons.month }" :disabled="disabledButtons.month">Month</button>
        };
        // ----------------------------------
        // End Component: Button State Management
        // ----------------------------------

        // ----------------------------------
        // Component: Terceros Management
        // ----------------------------------
        const loadTerceros = async () => {
            terceros.value = await TerceroDataSource();
        };

        const filteredTerceros = computed(() => {
            if (!searchQuery.value) return terceros.value;
            return terceros.value.filter(tercero => 
                tercero.nombreTercero.toLowerCase().includes(searchQuery.value.toLowerCase())
            );
        });

        const filterTerceros = () => {
            showOptions.value = true;
        };

        const selectTercero = (tercero) => {
            form.value.terceroId = tercero.id;
            form.value.title = tercero.nombreTercero;
            searchQuery.value = tercero.nombreTercero;
            showOptions.value = false;
        };

        const hideOptions = () => {
            setTimeout(() => {
                showOptions.value = false;
            }, 200);
        };

        const openTercerosModal = async () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showTercerosModal.value = true;
            showTerceroForm.value = false;
            await loadTerceros();
            updateButtonStates();
        };

        const closeTercerosModal = () => {
            showTercerosModal.value = false;
            showTerceroForm.value = false;
            currentTercero.value = null;
            updateButtonStates();
        };

        const openTerceroForm = () => {
            showTerceroForm.value = true;
            currentTercero.value = null;
            terceroForm.value = {
                id: '',
                ccTercero: '',
                nombreTercero: '',
                inicialTercero: '',
                tipoDocumentoTercero: '03',
                numeroDocumentoTercero: '',
                props: {
                    tipoTercero: 'CONTRATISTA',
                    baseLiquidacion: '',
                    cargoServidor: 'Servidor',
                    entidadBancaria: 'BANCOLOMBIA',
                    cuentaBancaria: '',
                    tipoCuenta: 'Ahorro',
                    telefono: '',
                    correo: '',
                    fechaNacimiento: '',
                    contrato: ''
                }
            };
        };

        const closeTerceroForm = () => {
            showTerceroForm.value = false;
            currentTercero.value = null;
        };

        const editTercero = (tercero) => {
            currentTercero.value = tercero;
            terceroForm.value = JSON.parse(JSON.stringify(tercero));
            showTerceroForm.value = true;
        };

        const saveTercero = () => {
            if (!terceroForm.value.nombreTercero || !terceroForm.value.numeroDocumentoTercero) {
                alert('El nombre y el número de documento son requeridos.');
                return;
            }
            if (currentTercero.value) {
                const index = terceros.value.findIndex(t => t.id === currentTercero.value.id);
                if (index !== -1) terceros.value[index] = { ...terceroForm.value };
            } else {
                const newTercero = { ...terceroForm.value, id: Date.now().toString() };
                terceros.value.push(newTercero);
            }
            closeTerceroForm();
        };

        const deleteTercero = (id) => {
            if (confirm('¿Estás seguro de eliminar este tercero?')) {
                terceros.value = terceros.value.filter(t => t.id !== id);
            }
        };
        // ----------------------------------
        // End Component: Terceros Management
        // ----------------------------------

        // ----------------------------------
        // Component: Cities Management
        // ----------------------------------
        const cities = ref([]);
        const origenQuery = ref('');
        const destinoQuery = ref('');
        const showOrigenOptions = ref(false);
        const showDestinoOptions = ref(false);

        const loadCities = async () => {
            cities.value = await CityDataSource();
        };

        const filteredOrigenCities = computed(() => {
            if (!origenQuery.value) return cities.value;
            return cities.value.filter(city => 
                city.nombreCiudad.toLowerCase().includes(origenQuery.value.toLowerCase())
            );
        });

        const filteredDestinoCities = computed(() => {
            if (!destinoQuery.value) return cities.value;
            return cities.value.filter(city => 
                city.nombreCiudad.toLowerCase().includes(destinoQuery.value.toLowerCase())
            );
        });

        const filterOrigenCities = () => {
            showOrigenOptions.value = true;
        };

        const filterDestinoCities = () => {
            showDestinoOptions.value = true;
        };

        const selectOrigenCity = (city) => {
            form.value.origen = city.id;
            origenQuery.value = city.nombreCiudad;
            showOrigenOptions.value = false;
        };

        const selectDestinoCity = (city) => {
            form.value.destino = city.id;
            destinoQuery.value = city.nombreCiudad;
            showDestinoOptions.value = false;
        };

        const hideOrigenOptions = () => {
            setTimeout(() => {
                showOrigenOptions.value = false;
            }, 200);
        };

        const hideDestinoOptions = () => {
            setTimeout(() => {
                showDestinoOptions.value = false;
            }, 200);
        };
        // ----------------------------------
        // End Component: Cities Management
        // ----------------------------------

        // ----------------------------------
        // Component: Calendar Management
        // ----------------------------------
        const getTitle = () => {
            if (!calendarApi.value) return '';
            const view = calendarApi.value.view;
            if (view.type === 'dayGridMonth') {
                const date = view.currentStart;
                return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            } else if (view.type === 'dayGridWeek') {
                const start = view.currentStart;
                const end = view.currentEnd;
                end.setDate(end.getDate() - 1);
                if (start.getMonth() === end.getMonth()) {
                    return `${start.getDate()} - ${end.getDate()} ${monthNames[start.getMonth()]} ${start.getFullYear()}`;
                } else if (start.getFullYear() === end.getFullYear()) {
                    return `${start.getDate()} ${monthNames[start.getMonth()].substring(0, 3)} - ${end.getDate()} ${monthNames[end.getMonth()].substring(0, 3)} ${start.getFullYear()}`;
                } else {
                    return `${start.getDate()} ${monthNames[start.getMonth()].substring(0, 3)} ${start.getFullYear()} - ${end.getDate()} ${monthNames[end.getMonth()].substring(0, 3)} ${end.getFullYear()}`;
                }
            }
            return '';
        };

        const darkenColor = (color, percent) => {
            if (!color) return '#3b82f6';
            if (color.startsWith('#')) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = Math.max(0, (num >> 16) - amt);
                const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
                const B = Math.max(0, (num & 0x0000FF) - amt);
                return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
            }
            return '#2563eb';
        };

        const navigate = (direction) => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            if (direction === 'prev') calendarApi.value.prev();
            else if (direction === 'next') calendarApi.value.next();
            updateTitle();
        };

        const setView = (view) => {
            if (showTimeline.value || showVisorPDF.value) return;
            currentView.value = view;
            if (calendarApi.value) {
                calendarApi.value.changeView(view);
                if (view === 'dayGridMonth') {
                    calendarApi.value.setOption('dayMaxEventRows', limitEvents.value ? 4 : false);
                    calendarApi.value.setOption('dayMaxEvents', limitEvents.value ? 4 : false);
                } else if (view === 'dayGridWeek') {
                    calendarApi.value.setOption('dayMaxEventRows', false);
                    calendarApi.value.setOption('dayMaxEvents', false);
                }
                updateTitle();
                updateButtonStates();
            }
        };

        const goToToday = () => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            calendarApi.value.today();
            setView(currentView.value);
            updateTitle();
        };

        const toggleEventLimit = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            limitEvents.value = !limitEvents.value;
            if (calendarApi.value && currentView.value === 'dayGridMonth') {
                calendarApi.value.setOption('dayMaxEventRows', limitEvents.value ? 4 : false);
                calendarApi.value.setOption('dayMaxEvents', limitEvents.value ? 4 : false);
            }
            updateButtonStates();
        };

        const updateTitle = () => {
            const titleElement = document.getElementById('calendar-title');
            if (titleElement) titleElement.textContent = getTitle();
        };

        const renderEvents = () => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            try {
                calendarApi.value.getEvents().forEach(event => event.remove());
                events.value.forEach(event => {
                    calendarApi.value.addEvent({
                        id: event.id,
                        title: event.title,
                        start: event.startDate,
                        end: event.endDate,
                        allDay: true,
                        backgroundColor: event.color || '#3b82f6',
                        borderColor: darkenColor(event.color, 20),
                        extendedProps: { 
                            description: event.description || '',
                            terceroId: event.terceroId || '',
                            viatica: event.viatica || false,
                            transporte: event.transporte || '',
                            origen: event.origen || '',
                            destino: event.destino || '',
                            rutaAdicional: event.rutaAdicional || ''
                        }
                    });
                });
            } catch (error) {
                console.error('Error in renderEvents:', error);
            }
        };

        const reinitializeCalendar = () => {
            try {
                const calendarEl = document.getElementById('calendar');
                if (!calendarEl) {
                    console.error('Calendar element not found');
                    return;
                }

                calendarEl.classList.remove('hidden');
                calendarEl.style.height = '100%';

                const savedView = currentView.value;
                const savedEvents = [...events.value];

                if (calendarApi.value) {
                    calendarApi.value.destroy();
                    calendarApi.value = null;
                }

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    locale: 'es',
                    initialView: savedView,
                    headerToolbar: false,
                    firstDay: 1,
                    dayHeaderFormat: { weekday: 'long' },
                    height: '100%',
                    contentHeight: '100%',
                    eventClick: (info) => {
                        editEvent(info);
                    },
                    dateClick: function(info) {
                        openModal(info.dateStr);
                    },
                    eventDisplay: 'block',
                    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                    eventDidMount: function(info) {
                        if (info.event.allDay && info.event.start && info.event.end) {
                            const start = info.event.start;
                            const end = info.event.end;
                            const duration = (end - start) / (1000 * 60 * 60 * 24);
                            if (duration > 1) {
                                info.el.style.borderLeftWidth = '4px';
                                info.el.style.borderLeftStyle = 'solid';
                                info.el.style.borderLeftColor = darkenColor(info.event.backgroundColor, 20);
                            }
                        }
                    },
                    dayHeaderContent: function(arg) {
                        const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                        return { html: `<div>${dayName}</div>` };
                    },
                    views: {
                        dayGridMonth: {
                            dayMaxEventRows: limitEvents.value ? 4 : false,
                            dayMaxEvents: limitEvents.value ? 4 : false,
                            fixedWeekCount: false,
                            aspectRatio: 1.5
                        },
                        dayGridWeek: {
                            type: 'dayGrid',
                            duration: { weeks: 1 },
                            dayCount: 7,
                            dayMaxEventRows: false,
                            dayMaxEvents: false,
                            titleFormat: { year: 'numeric', month: 'long', day: 'numeric' },
                            dayHeaderContent: function(arg) {
                                const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                                const dayNumber = arg.date.getDate();
                                return {
                                    html: `
                                        <div class="flex flex-col items-center">
                                            <span class="fc-day-name">${dayName}</span>
                                            <span class="fc-day-number">${dayNumber}</span>
                                        </div>
                                    `
                                };
                            }
                        }
                    },
                    datesSet: function() {
                        updateTitle();
                    }
                });

                calendarApi.value = calendar;
                calendar.render();

                events.value = savedEvents;
                renderEvents();

                calendar.updateSize();

                const debounce = (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                };

                const handleResize = debounce(() => {
                    if (calendarApi.value) {
                        calendarApi.value.updateSize();
                    }
                }, 100);

                window.addEventListener('resize', handleResize);

                nextTick(() => {
                    window.removeEventListener('resize', handleResize);
                });

                updateButtonStates();
            } catch (error) {
                console.error('Error reinitializing calendar:', error);
            }
        };
        // ----------------------------------
        // End Component: Calendar Management
        // ----------------------------------

        // ----------------------------------
        // Component: Event Management
        // ----------------------------------
        const openModal = (date) => {
            if (showTimeline.value || showVisorPDF.value) return;
            if (date) {
                form.value.startDate = date;
                form.value.endDate = date;
            } else if (!currentEvent.value) {
                const today = new Date().toISOString().split('T')[0];
                form.value.startDate = today;
                form.value.endDate = today;
            }
            showModal.value = true;

            nextTick(() => {
                if (dateRangePicker.value) {
                    flatpickrInstance = flatpickr(dateRangePicker.value, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        locale: 'es',
                        defaultDate: [form.value.startDate, form.value.endDate],
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                form.value.startDate = selectedDates[0].toISOString().split('T')[0];
                                form.value.endDate = selectedDates[1].toISOString().split('T')[0];
                            }
                        },
                        onReady: (selectedDates, dateStr, instance) => {
                            if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                                dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                            }
                        },
                        onOpen: (selectedDates, dateStr, instance) => {
                            if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                                dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                            }
                        }
                    });

                    if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                        dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                    }
                }
            });
        };

        const closeModal = () => {
            showModal.value = false;
            currentEvent.value = null;
            error.value = null;
            form.value = {
                title: '',
                description: '',
                startDate: '',
                endDate: '',
                color: '#3b82f6',
                terceroId: '',
                viatica: true,
                transporte: '',
                origen: '',
                destino: '',
                rutaAdicional: ''
            };
            searchQuery.value = '';
            showOptions.value = false;
            origenQuery.value = '';
            destinoQuery.value = '';
            showOrigenOptions.value = false;
            showDestinoOptions.value = false;
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                flatpickrInstance = null;
            }
        };

        const computeViatico = () => {
            const eventToUse = currentEvent.value || form.value;
            if (eventToUse.terceroId && eventToUse.destino) {
                const viaticoObj = createViaticoObject(eventToUse, terceros.value, cities.value);
                if (viaticoObj && !viaticos.value.some(v => v.event.startDate === viaticoObj.event.startDate && v.tercero.numeroDocumentoTercero === viaticoObj.tercero.numeroDocumentoTercero)) {
                    viaticos.value.push(viaticoObj);
                }
            }
        };

        const editEvent = (eventInfo) => {
            if (showTimeline.value || showVisorPDF.value) return;
            const endDate = new Date(eventInfo.event.end || eventInfo.event.start);
            endDate.setDate(endDate.getDate() - 1);
            
            const origenCity = cities.value.find(city => city.id === eventInfo.event.extendedProps.origen);
            const destinoCity = cities.value.find(city => city.id === eventInfo.event.extendedProps.destino);

            currentEvent.value = {
                id: eventInfo.event.id,
                title: eventInfo.event.title,
                description: eventInfo.event.extendedProps.description || '',
                startDate: eventInfo.event.startStr.split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                color: eventInfo.event.backgroundColor || '#3b82f6',
                terceroId: eventInfo.event.extendedProps.terceroId || '',
                viatica: eventInfo.event.extendedProps.viatica || false,
                transporte: eventInfo.event.extendedProps.transporte || '',
                origen: eventInfo.event.extendedProps.origen || '',
                destino: eventInfo.event.extendedProps.destino || '',
                rutaAdicional: eventInfo.event.extendedProps.rutaAdicional || ''
            };

            form.value = { ...currentEvent.value };
            searchQuery.value = form.value.title;
            origenQuery.value = origenCity ? origenCity.nombreCiudad : '';
            destinoQuery.value = destinoCity ? destinoCity.nombreCiudad : '';
            computeViatico();
            openModal();
        };

        const saveEvent = () => {
            if (!form.value.title) {
                error.value = 'El título es requerido';
                return;
            }
            if (!form.value.startDate || !form.value.endDate) {
                error.value = 'Las fechas son requeridas';
                return;
            }
            const startDate = new Date(form.value.startDate);
            const endDate = new Date(form.value.endDate);
            if (startDate > endDate) {
                error.value = 'La fecha de inicio no puede ser posterior a la fecha final';
                return;
            }
            error.value = null;
            const startDateStr = `${form.value.startDate}T00:00:00`;
            const adjustedEndDate = new Date(form.value.endDate);
            adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
            const endDateStr = adjustedEndDate.toISOString().split('T')[0] + 'T00:00:00';

            const eventData = {
                id: currentEvent.value ? currentEvent.value.id : Date.now().toString(),
                title: form.value.title,
                description: form.value.description,
                startDate: startDateStr,
                endDate: endDateStr,
                color: form.value.color,
                terceroId: form.value.terceroId,
                viatica: form.value.viatica,
                transporte: form.value.transporte,
                origen: form.value.origen,
                destino: form.value.destino,
                rutaAdicional: form.value.rutaAdicional
            };

            if (currentEvent.value) {
                const index = events.value.findIndex(e => e.id === currentEvent.value.id);
                if (index !== -1) events.value[index] = eventData;
            } else {
                events.value.push(eventData);
            }
            localStorage.setItem('academicEvents', JSON.stringify(events.value));
            renderEvents();
            closeModal();
        };

        const deleteEvent = () => {
            if (currentEvent.value) {
                events.value = events.value.filter(e => e.id !== currentEvent.value.id);
                localStorage.setItem('academicEvents', JSON.stringify(events.value));
                renderEvents();
                closeModal();
            }
        };

        const createViaticoObject = (eventData, terceros, cities) => {
            if (!eventData) return null;

            const tercero = terceros.find(t => t.id === eventData.terceroId);
            const destinoCity = cities.find(c => c.id === eventData.destino);
            if (!tercero || !destinoCity) return null;

            const startDate = new Date(eventData.startDate);
            const endDate = new Date(eventData.endDate);
            const duration = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
            };

            const calculateCost = (duration, cityCategory) => {
                const rates = {
                    1: 150000,
                    2: 200000,
                    3: 250000
                };
                return duration * (rates[cityCategory] || 150000);
            };

            return {
                dependencia: DEPENDENCIA,
                currentDate: formatDate(new Date('2025-05-04')),
                duracion: duration,
                tercero: {
                    nombreTercero: tercero.nombreTercero,
                    nacimiento: tercero.props.fechaNacimiento ? formatDate(tercero.props.fechaNacimiento) : '',
                    numeroDocumentoTercero: tercero.numeroDocumentoTercero,
                    correo: tercero.props.correo,
                    telefono: tercero.props.telefono,
                    entidadBancaria: tercero.props.entidadBancaria,
                    cargoServidor: tercero.props.cargoServidor,
                    tipoCuenta: tercero.props.tipoCuenta,
                    tipoTercero: tercero.props.tipoTercero,
                    cuentaBancaria: tercero.props.cuentaBancaria
                },
                event: {
                    startDate: formatDate(eventData.startDate),
                    endDate: formatDate(eventData.endDate),
                    description: eventData.description || '',
                    transporte: eventData.transporte || '0',
                    itinerario: eventData.rutaAdicional || '',
                    ciudadDestino: destinoCity.nombreCiudad,
                    ciudadDestinoDepartamento: destinoCity.departamento
                },
                cost: calculateCost(duration, destinoCity.categoria)
            };
        };
        // ----------------------------------
        // End Component: Event Management
        // ----------------------------------

        // ----------------------------------
        // Component: Event Modal Input Formatting
        // ----------------------------------
        const formatTransporte = (value) => {
            const digitsOnly = value.replace(/\D/g, '');
            return digitsOnly.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const handleTransporteInput = (event) => {
            const input = event.target.value.replace(/,/g, '');
            if (/^\d*$/.test(input)) {
                form.value.transporte = formatTransporte(input);
            } else {
                form.value.transporte = formatTransporte(input.replace(/\D/g, ''));
            }
        };

        const handleRutaAdicionalInput = (event) => {
            let value = event.target.value;
            value = value.replace(/[^a-zA-Z\s]/g, '');
            form.value.rutaAdicional = value.toUpperCase();
        };

        const handleDescriptionInput = (event) => {
            let value = event.target.value;
            value = value.replace(/[^a-zA-Z0-9\-\s]/g, '');
            if (value.length > 120) {
                value = value.substring(0, 120);
            }
            form.value.description = value.toUpperCase();
        };
        // ----------------------------------
        // End Component: Event Modal Input Formatting
        // ----------------------------------

        // ----------------------------------
        // Component: Programming Management
        // ----------------------------------
        const computeViaticoForProgramming = () => {
            if (!programmingRange.value.start || !programmingRange.value.end) {
                const today = new Date();
                const start = new Date(today.getFullYear(), today.getMonth(), 1);
                const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                programmingRange.value.start = start.toISOString().split('T')[0];
                programmingRange.value.end = end.toISOString().split('T')[0];
            }
            const startDate = new Date(programmingRange.value.start);
            const endDate = new Date(programmingRange.value.end);
            const filteredEvents = events.value.filter(event => {
                const eventStart = new Date(event.startDate);
                return eventStart >= startDate && eventStart <= endDate;
            });

            viaticos.value = filteredEvents
                .map(event => createViaticoObject(event, terceros.value, cities.value))
                .filter(viatico => viatico !== null);
        };

        const openProgrammingModal = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showProgrammingModal.value = true;
            programmingEventsJson.value = null;
            computeViaticoForProgramming();
            nextTick(() => {
                if (programmingDateRangePicker.value) {
                    programmingFlatpickrInstance = flatpickr(programmingDateRangePicker.value, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        locale: 'es',
                        defaultDate: [programmingRange.value.start, programmingRange.value.end],
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                programmingRange.value.start = selectedDates[0].toISOString().split('T')[0];
                                programmingRange.value.end = selectedDates[1].toISOString().split('T')[0];
                                computeViaticoForProgramming();
                            }
                        }
                    });
                }
            });
            updateButtonStates();
        };

        const closeProgrammingModal = () => {
            showProgrammingModal.value = false;
            programmingRange.value = { start: '', end: '' };
            programmingEventsJson.value = null;
            if (programmingFlatpickrInstance) {
                programmingFlatpickrInstance.destroy();
                programmingFlatpickrInstance = null;
            }
            updateButtonStates();
        };

        const generateProgrammingJson = () => {
            if (!programmingRange.value.start || !programmingRange.value.end) {
                alert('Por favor, selecciona un rango de fechas.');
                return;
            }
            const startDate = new Date(programmingRange.value.start);
            const endDate = new Date(programmingRange.value.end);
            const filteredEvents = events.value.filter(event => {
                const eventStart = new Date(event.startDate);
                return eventStart >= startDate && eventStart <= endDate;
            });

            const eventsWithViatico = filteredEvents.map(event => ({
                ...event,
                viatico: createViaticoObject(event, terceros.value, cities.value)
            }));

            programmingEventsJson.value = JSON.stringify(eventsWithViatico, null, 2);
            computeViaticoForProgramming();
            if (!showVisorPDF.value) {
                toggleVisorPDF();
            }
            showProgrammingModal.value = false;
        };
        // ----------------------------------
        // End Component: Programming Management
        // ----------------------------------

        // ----------------------------------
        // Component: Periodo Management
        // ----------------------------------
        const showPeriodoForm = ref(false);
        const selectedPeriodos = ref([]);
        const periodoFilter = ref('');
        const centroFilter = ref('');

        const uniquePeriodos = computed(() => {
            return [...new Set(periodos.value.map(p => p.periodo))].sort();
        });

        const filteredPeriodos = computed(() => {
            return periodos.value.filter(periodo => {
                const matchesPeriodo = !periodoFilter.value || periodo.periodo === periodoFilter.value;
                const matchesCentro = !centroFilter.value || 
                    periodo.centro.toLowerCase().includes(centroFilter.value.toLowerCase());
                return matchesPeriodo && matchesCentro;
            });
        });

        const getSelectedSemesters = computed(() => {
            return periodoForm.value.semestres.map((selected, index) => selected ? index + 1 : null).filter(Boolean);
        });

        const getAsignaturasForSemester = (semestre) => {
            const asignaturasPorSemestre = {
                1: ['Matemáticas Básicas', 'Introducción a la Programación'],
                2: ['Álgebra Lineal', 'Física I'],
                3: ['Cálculo II', 'Química General'],
                4: ['Estadística', 'Electiva I'],
                5: ['Programación Avanzada', 'Economía'],
                6: ['Diseño de Sistemas', 'Electiva II'],
                7: ['Gestión de Proyectos', 'Ética Profesional'],
                8: ['Inteligencia Artificial', 'Electiva III'],
                9: ['Tesis I', 'Seminario'],
                10: ['Tesis II', 'Práctica Profesional']
            };
            return asignaturasPorSemestre[semestre] || [];
        };

        const openPeriodoModal = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showPeriodoModal.value = true;
            showPeriodoForm.value = false;
            currentPeriodo.value = null;
            selectedPeriodos.value = [];
            periodoFilter.value = '';
            centroFilter.value = '';
            updateButtonStates();
        };

        const closePeriodoModal = () => {
            showPeriodoModal.value = false;
            showPeriodoForm.value = false;
            currentPeriodo.value = null;
            selectedPeriodos.value = [];
            periodoFilter.value = '';
            centroFilter.value = '';
            periodoForm.value = {
                periodo: '2025-1',
                centro: 'CALI',
                programa: 'ADMINISTRACION PUBLICA',
                semestres: Array(10).fill(false),
                asignaturas: {}
            };
            updateButtonStates();
        };

        const openPeriodoForm = () => {
            showPeriodoForm.value = true;
            currentPeriodo.value = null;
            periodoForm.value = {
                periodo: '2025-1',
                centro: 'CALI',
                programa: 'ADMINISTRACION PUBLICA',
                semestres: Array(10).fill(false),
                asignaturas: {}
            };
            initializeAsignaturas();
        };

        const closePeriodoForm = () => {
            showPeriodoForm.value = false;
            currentPeriodo.value = null;
            periodoForm.value = {
                periodo: '2025-1',
                centro: 'CALI',
                programa: 'ADMINISTRACION PUBLICA',
                semestres: Array(10).fill(false),
                asignaturas: {}
            };
        };

        const initializeAsignaturas = () => {
            periodoForm.value.asignaturas = {};
            for (let i = 1; i <= 10; i++) {
                periodoForm.value.asignaturas[i] = {};
                getAsignaturasForSemester(i).forEach(asignatura => {
                    periodoForm.value.asignaturas[i][asignatura] = '';
                });
            }
        };

        const editPeriodo = (periodo) => {
            currentPeriodo.value = periodo;
            periodoForm.value = JSON.parse(JSON.stringify(periodo));
            showPeriodoForm.value = true;
            initializeAsignaturas();
            Object.keys(periodo.asignaturas).forEach(semestre => {
                Object.keys(periodo.asignaturas[semestre]).forEach(asignatura => {
                    if (periodoForm.value.asignaturas[semestre]) {
                        periodoForm.value.asignaturas[semestre][asignatura] = periodo.asignaturas[semestre][asignatura];
                    }
                });
            });
        };

        const savePeriodo = () => {
            if (!periodoForm.value.periodo || !periodoForm.value.centro || !periodoForm.value.programa) {
                alert('Todos los campos principales son requeridos.');
                return;
            }
            const periodoData = {
                id: currentPeriodo.value ? currentPeriodo.value.id : Date.now().toString(),
                periodo: periodoForm.value.periodo,
                centro: periodoForm.value.centro,
                programa: periodoForm.value.programa,
                semestres: [...periodoForm.value.semestres],
                asignaturas: JSON.parse(JSON.stringify(periodoForm.value.asignaturas))
            };
            if (currentPeriodo.value) {
                const index = periodos.value.findIndex(p => p.id === currentPeriodo.value.id);
                if (index !== -1) periodos.value[index] = periodoData;
            } else {
                periodos.value.push(periodoData);
            }
            localStorage.setItem('periodos', JSON.stringify(periodos.value));
            closePeriodoForm();
        };

        const deletePeriodo = (id) => {
            if (confirm('¿Estás seguro de eliminar este periodo?')) {
                periodos.value = periodos.value.filter(p => p.id !== id);
                selectedPeriodos.value = selectedPeriodos.value.filter(pid => pid !== id);
                localStorage.setItem('periodos', JSON.stringify(periodos.value));
            }
        };

        const toggleAllSemesters = () => {
            const allSelected = periodoForm.value.semestres.every(s => s);
            periodoForm.value.semestres = Array(10).fill(!allSelected);
            initializeAsignaturas();
        };

        const applyFilters = () => {
        };

        const showCronogramaTimeline = () => {
            if (!selectedPeriodos.value.length) return;

            showPeriodoModal.value = false;

            if (!showTimeline.value) {
                toggleTimeline();
            }

            const selected = periodos.value.filter(p => selectedPeriodos.value.includes(p.id));
            const groups = [];
            const items = [];

            selected.forEach(periodo => {
                const centroProgramaId = `${periodo.centro}-${periodo.programa}`;
                groups.push({
                    id: centroProgramaId,
                    content: `${periodo.centro} - ${periodo.programa}`,
                    nestedGroups: [],
                    showNested: true
                });

                const semestres = periodo.semestres
                    .map((s, i) => s ? i + 1 : null)
                    .filter(Boolean);

                semestres.forEach(semestre => {
                    const semestreId = `${centroProgramaId}-semestre-${semestre}`;
                    groups.push({
                        id: semestreId,
                        content: `Semestre ${semestre}`,
                        nestedGroups: [],
                        showNested: true
                    });
                    groups.find(g => g.id === centroProgramaId).nestedGroups.push(semestreId);

                    const asignaturas = getAsignaturasForSemester(semestre);
                    asignaturas.forEach(asignatura => {
                        const asignaturaId = `${semestreId}-asignatura-${asignatura}`;
                        groups.push({
                            id: asignaturaId,
                            content: asignatura
                        });
                        groups.find(g => g.id === semestreId).nestedGroups.push(asignaturaId);

                        const terceroId = periodo.asignaturas[semestre]?.[asignatura];
                        if (terceroId) {
                            const tercero = terceros.value.find(t => t.id === terceroId);
                            const year = parseInt(periodo.periodo.split('-')[0]);
                            const semester = periodo.periodo.split('-')[1];
                            const startMonth = semester === '1' ? 0 : 6;
                            const startDate = new Date(year, startMonth + (semestre - 1) * 0.5, 1);
                            const endDate = new Date(startDate);
                            endDate.setMonth(startDate.getMonth() + 0.5);

                            items.push({
                                id: `${periodo.id}-${semestre}-${asignatura}`,
                                content: `${asignatura} (${tercero ? tercero.nombreTercero : 'Sin tercero'})`,
                                start: startDate,
                                end: endDate,
                                group: asignaturaId,
                                style: 'background-color: #3b82f6; border-color: #2563eb'
                            });
                        }
                    });
                });
            });

            nextTick(() => {
                if (timelineContainer.value) {
                    if (timeline) {
                        timeline.destroy();
                        timeline = null;
                    }
                    const visGroups = new vis.DataSet(groups);
                    const visItems = new vis.DataSet(items);
                    timeline = new vis.Timeline(timelineContainer.value, visItems, visGroups, {
                        start: new Date(2025, 0, 1),
                        end: new Date(2025, 11, 31),
                        editable: false,
                        groupOrder: 'content',
                        zoomMin: 1000 * 60 * 60 * 24 * 7,
                        zoomMax: 1000 * 60 * 60 * 24 * 365,
                        timeAxis: { scale: 'month', step: 1 },
                        format: {
                            minorLabels: (date, scale) => {
                                const jsDate = date._isAMomentObject ? date.toDate() : new Date(date);
                                if (scale === 'month') {
                                    return jsDate.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                                }
                                return '';
                            },
                            majorLabels: (date) => {
                                const jsDate = date._isAMomentObject ? date.toDate() : new Date(date);
                                return jsDate.toLocaleDateString('es-ES', { year: 'numeric', month: 'long' });
                            }
                        }
                    });
                }
            });
        };
        // ----------------------------------
        // End Component: Periodo Management
        // ----------------------------------

        // ----------------------------------
        // Component: Timeline Management
        // ----------------------------------
        const toggleTimeline = () => {
            showTimeline.value = !showTimeline.value;
            showVisorPDF.value = false;

            const calendarEl = document.getElementById('calendar');
            const timelineEl = document.getElementById('timeline');
            const visorPDFEl = document.getElementById('visorPDF');

            if (showTimeline.value) {
                if (calendarEl) calendarEl.classList.add('hidden');
                if (timelineEl) timelineEl.classList.remove('hidden');
                if (visorPDFEl) visorPDFEl.classList.add('hidden');
                nextTick(() => {
                    initializeTimeline();
                });
            } else {
                if (calendarEl) calendarEl.classList.remove('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.add('hidden');
                if (timeline) {
                    timeline.destroy();
                    timeline = null;
                }
                nextTick(() => {
                    if (calendarApi.value) {
                        calendarApi.value.render();
                        renderEvents();
                        calendarApi.value.updateSize();
                    } else {
                        reinitializeCalendar();
                    }
                });
            }
            updateButtonStates();
        };

        const formatDateRange = (startDate, endDate) => {
            const start = new Date(startDate);
            const end = new Date(endDate);
            return `${start.toLocaleDateString('es-ES')} - ${end.toLocaleDateString('es-ES')}`;
        };

        const formatDate = (date) => {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const parseDate = (dateStr) => {
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day);
        };

        const initializeTimeline = () => {
            if (timelineContainer.value && !timeline) {
                const items = new vis.DataSet(events.value.map(event => ({
                    id: event.id,
                    content: event.title,
                    group: event.terceroId,
                    start: new Date(event.startDate),
                    end: new Date(event.endDate),
                    style: `background-color: ${event.color}; border-color: ${darkenColor(event.color, 20)}`
                })));

                const groups = new vis.DataSet(terceros.value.map(tercero => ({
                    id: tercero.id,
                    content: tercero.nombreTercero
                })));

                timeline = new vis.Timeline(timelineContainer.value, items, groups, {
                    start: new Date("2025-04-01"),
                    end: new Date("2025-04-30"),
                    editable: true,
                    groupOrder: 'content',
                    onAdd: (item, callback) => {
                        timelineModalState.isOpen = true;
                        timelineModalState.action = 'add';
                        timelineModalState.eventData = {
                            id: '',
                            content: item.content || '',
                            group: item.group || terceros.value[0]?.id || '',
                            start: item.start ? formatDate(item.start) : '',
                            end: item.end ? formatDate(item.end) : ''
                        };
                        callback(null);
                    },
                    onMove: (item, callback) => {
                        const tooltip = document.getElementById('tooltip');
                        tooltip.style.display = 'block';
                        tooltip.style.left = event.pageX + 10 + 'px';
                        tooltip.style.top = event.pageY + 10 + 'px';
                        tooltip.innerHTML = `Ítem movido: ${item.content}<br>Nueva fecha: ${formatDate(item.start)}`;
                        setTimeout(() => { tooltip.style.display = 'none'; }, 2000);
                        callback(item);
                        const eventIndex = events.value.findIndex(e => e.id === item.id);
                        if (eventIndex !== -1) {
                            events.value[eventIndex] = {
                                ...events.value[eventIndex],
                                startDate: formatDate(item.start) + 'T00:00:00',
                                endDate: formatDate(item.end) + 'T00:00:00'
                            };
                            localStorage.setItem('academicEvents', JSON.stringify(events.value));
                        }
                    },
                    onUpdate: (item, callback) => {
                        timelineModalState.isOpen = true;
                        timelineModalState.action = 'edit';
                        timelineModalState.eventData = {
                            id: item.id,
                            content: item.content,
                            group: item.group,
                            start: formatDate(item.start),
                            end: formatDate(item.end)
                        };
                        callback(null);
                    },
                    tooltip: {
                        followMouse: true,
                        overflowMethod: 'cap'
                    },
                    zoomMin: 1000 * 60 * 60 * 24 * 14,
                    zoomMax: 1000 * 60 * 60 * 24 * 180,
                    timeAxis: { scale: 'day', step: 1 },
                    format: {
                        minorLabels: function (date, scale, step) {
                            const jsDate = new Date(date);
                            if (scale === 'day') {
                                const dayName = jsDate.toLocaleDateString('es-ES', { weekday: 'short' });
                                const dayNumber = jsDate.getDate();
                                return `${dayName} ${dayNumber}`;
                            }
                            return '';
                        },
                        majorLabels: function (date, scale, step) {
                            const jsDate = new Date(date);
                            if (scale === 'day') {
                                return jsDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                            }
                            return '';
                        }
                    }
                });

                timeline.on('doubleClick', (props) => {
                    if (props.item) {
                        const item = items.get(props.item);
                        if (item) {
                            timelineModalState.isOpen = true;
                            timelineModalState.action = 'edit';
                            timelineModalState.eventData = {
                                id: item.id,
                                content: item.content,
                                group: item.group,
                                start: formatDate(item.start),
                                end: formatDate(item.end)
                            };
                        }
                    }
                });

                timeline.on('contextmenu', (props) => {
                    props.event.preventDefault();
                    if (!props.item) {
                        const start = new Date(props.time);
                        start.setHours(0, 0, 0, 0);
                        const end = new Date(start);
                        end.setDate(start.getDate() + 1);
                        timelineModalState.isOpen = true;
                        timelineModalState.action = 'add';
                        timelineModalState.eventData = {
                            id: '',
                            content: '',
                            group: props.group || terceros.value[0]?.id || '',
                            start: formatDate(start),
                            end: formatDate(end)
                        };
                    }
                });

                timeline.on('changed', () => {
                    const cells = document.querySelectorAll('.vis-time-axis .vis-grid');
                    cells.forEach(cell => {
                        cell.style.width = '5px';
                    });
                });
            }
        };

        const closeTimelineModal = () => {
            timelineModalState.isOpen = false;
            timelineModalState.eventData = { id: '', content: '', group: '', start: '', end: '' };
        };

        const handleTimelineModalSubmit = () => {
            const { id, content, group, start, end } = timelineModalState.eventData;
            const startDate = parseDate(start);
            const endDate = parseDate(end);

            if (endDate < startDate) {
                alert('La fecha de fin debe ser posterior a la fecha de inicio');
                return;
            }

            const tercero = terceros.value.find(t => t.id === group);
            const eventData = {
                id: id || Date.now().toString(),
                title: content,
                description: '',
                startDate: formatDate(startDate) + 'T00:00:00',
                endDate: formatDate(endDate) + 'T00:00:00',
                color: '#3b82f6',
                terceroId: group
            };

            if (id) {
                const index = events.value.findIndex(e => e.id === id);
                if (index !== -1) {
                    events.value[index] = eventData;
                }
            } else {
                events.value.push(eventData);
            }

            localStorage.setItem('academicEvents', JSON.stringify(events.value));
            if (timeline) {
                timeline.destroy();
                timeline = null;
                initializeTimeline();
            }
            closeTimelineModal();
        };
        // ----------------------------------
        // End Component: Timeline Management
        // ----------------------------------

        // ----------------------------------
        // Component: Visor PDF Management
        // ----------------------------------
        const toggleVisorPDF = () => {
            showVisorPDF.value = !showVisorPDF.value;
            showTimeline.value = false;

            const calendarEl = document.getElementById('calendar');
            const timelineEl = document.getElementById('timeline');
            const visorPDFEl = document.getElementById('visorPDF');

            if (showVisorPDF.value) {
                if (calendarEl) calendarEl.classList.add('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.remove('hidden');
                if (timeline) {
                    timeline.destroy();
                    timeline = null;
                }
            } else {
                if (calendarEl) calendarEl.classList.remove('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.add('hidden');
                nextTick(() => {
                    if (calendarApi.value) {
                        calendarApi.value.render();
                        renderEvents();
                        calendarApi.value.updateSize();
                    } else {
                        reinitializeCalendar();
                    }
                });
            }
            updateButtonStates();
        };

        const generatePDF = async () => {
            if (viaticos.value.length === 0) {
                alert('No hay viáticos para generar el PDF.');
                return;
            }

            if (typeof window.html2canvas !== 'function') {
                console.error('html2canvas is not loaded.');
                alert('Error: No se puede generar el PDF porque html2canvas no está disponible.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: 'a4'
            });

            let hasValidPages = false;

            for (let index = 0; index < viaticos.value.length; index++) {
                const pageElement = document.getElementById(`pf1-${index}`);
                if (!pageElement) {
                    console.warn(`Page element pf1-${index} not found. Skipping.`);
                    continue;
                }

                try {
                    const originalDisplay = pageElement.style.display;
                    pageElement.style.display = 'block';

                    const canvas = await window.html2canvas(pageElement, {
                        scale: 2,
                        useCORS: true,
                        logging: true,
                        width: pageElement.offsetWidth,
                        height: pageElement.offsetHeight
                    });

                    pageElement.style.display = originalDisplay;

                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    if (index > 0 && hasValidPages) {
                        doc.addPage();
                    }

                    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    hasValidPages = true;
                } catch (error) {
                    console.error(`Error generating page ${index + 1}:`, error);
                    alert(`Error al generar la página ${index + 1}: ${error.message}. Continuando con las demás páginas.`);
                }
            }

            if (hasValidPages) {
                doc.save(`comision_servicios_${new Date().toISOString().split('T')[0]}.pdf`);
            } else {
                alert('No se generaron páginas válidas para el PDF.');
            }
        };
        // ----------------------------------
        // End Component: Visor PDF Management
        // ----------------------------------

        // ----------------------------------
        // Component: Lifecycle Hooks
        // ----------------------------------
        onMounted(async () => {
            await loadTerceros();
            await loadCities();
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: currentView.value,
                headerToolbar: false,
                firstDay: 1,
                dayHeaderFormat: { weekday: 'long' },
                height: '100%',
                contentHeight: '100%',
                eventClick: (info) => {
                    editEvent(info);
                },
                dateClick: function(info) {
                    openModal(info.dateStr);
                },
                eventDisplay: 'block',
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                eventDidMount: function(info) {
                    if (info.event.allDay && info.event.start && info.event.end) {
                        const start = info.event.start;
                        const end = info.event.end;
                        const duration = (end - start) / (1000 * 60 * 60 * 24);
                        if (duration > 1) {
                            info.el.style.borderLeftWidth = '4px';
                            info.el.style.borderLeftStyle = 'solid';
                            info.el.style.borderLeftColor = darkenColor(info.event.backgroundColor, 20);
                        }
                    }
                },
                dayHeaderContent: function(arg) {
                    const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                    return { html: `<div>${dayName}</div>` };
                },
                views: {
                    dayGridMonth: {
                        dayMaxEventRows: limitEvents.value ? 4 : false,
                        dayMaxEvents: limitEvents.value ? 4 : false,
                        fixedWeekCount: false,
                        aspectRatio: 1.5
                    },
                    dayGridWeek: {
                        type: 'dayGrid',
                        duration: { weeks: 1 },
                        dayCount: 7,
                        dayMaxEventRows: false,
                        dayMaxEvents: false,
                        titleFormat: { year: 'numeric', month: 'long', day: 'numeric' },
                        dayHeaderContent: function(arg) {
                            const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                            const dayNumber = arg.date.getDate();
                            return {
                                html: `
                                    <div class="flex flex-col items-center">
                                        <span class="fc-day-name">${dayName}</span>
                                        <span class="fc-day-number">${dayNumber}</span>
                                    </div>
                                `
                            };
                        }
                    }
                },
                datesSet: function() {
                    updateTitle();
                }
            });

            calendarApi.value = calendar;
            calendar.render();
            renderEvents();
            computeViaticoForProgramming();
            updateButtonStates();
        });

        onUnmounted(() => {
            if (calendarApi.value) {
                calendarApi.value.destroy();
                calendarApi.value = null;
            }
            if (timeline) {
                timeline.destroy();
                timeline = null;
            }
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                flatpickrInstance = null;
            }
            if (programmingFlatpickrInstance) {
                programmingFlatpickrInstance.destroy();
                programmingFlatpickrInstance = null;
            }
        });
        // ----------------------------------
        // End Component: Lifecycle Hooks
        // ----------------------------------

        // ----------------------------------
        // Exposed methods and properties
        // ----------------------------------
        return {
            currentView,
            setView,
            navigate,
            goToToday,
            getTitle,
            limitEvents,
            toggleEventLimit,
            showModal,
            currentEvent,
            form,
            error,
            dateRangePicker,
            saveEvent,
            closeModal,
            deleteEvent,
            handleTransporteInput,
            handleRutaAdicionalInput,
            handleDescriptionInput,
            createViaticoObject,
            viaticos,
            showProgrammingModal,
            openProgrammingModal,
            closeProgrammingModal,
            programmingDateRangePicker,
            programmingEventsJson,
            generateProgrammingJson,
            showTercerosModal,
            openTercerosModal,
            closeTercerosModal,
            terceros,
            searchQuery,
            showOptions,
            filteredTerceros,
            filterTerceros,
            selectTercero,
            hideOptions,
            showTerceroForm,
            openTerceroForm,
            closeTerceroForm,
            terceroForm,
            currentTercero,
            editTercero,
            saveTercero,
            deleteTercero,
            cities,
            origenQuery,
            destinoQuery,
            showOrigenOptions,
            showDestinoOptions,
            filteredOrigenCities,
            filteredDestinoCities,
            filterOrigenCities,
            filterDestinoCities,
            selectOrigenCity,
            selectDestinoCity,
            hideOrigenOptions,
            hideDestinoOptions,
            showPeriodoModal,
            openPeriodoModal,
            closePeriodoModal,
            periodos,
            currentPeriodo,
            periodoForm,
            showPeriodoForm,
            openPeriodoForm,
            closePeriodoForm,
            getSelectedSemesters,
            getAsignaturasForSemester,
            toggleAllSemesters,
            savePeriodo,
            editPeriodo,
            deletePeriodo,
            selectedPeriodos,
            periodoFilter,
            centroFilter,
            uniquePeriodos,
            filteredPeriodos,
            applyFilters,
            showCronogramaTimeline,
            showTimeline,
            toggleTimeline,
            timelineContainer,
            timelineModalState,
            closeTimelineModal,
            handleTimelineModalSubmit,
            showVisorPDF,
            toggleVisorPDF,
            generatePDF,
            computeViatico,
            computeViaticoForProgramming,
            reinitializeCalendar,
            disabledButtons
        };
        // ----------------------------------
        // End Exposed methods and properties
        // ----------------------------------
    }
});

app.mount('#app');
</script>
</body>
</html>
