<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Académico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://visjs.github.io/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <!-- PDF Viewer Styles -->
    <link rel="stylesheet" href="assets/base.min.css"/>
    <link rel="stylesheet" href="assets/fancy.min.css"/>
    <link rel="stylesheet" href="assets/main.css?v=1.2"/>
    <link rel="stylesheet" href="assets/styles.css?v=1.3"/>
    <style></style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- ---------------------------------- -->
	<!-- Component: Header -->
	<!-- ---------------------------------- -->
	<header class="bg-blue-600 text-white shadow-lg">
	    <div class="px-4 py-3">
	        <div class="flex flex-col md:flex-row md:justify-between md:items-center space-y-2 md:space-y-0">
	            <div class="flex items-center justify-between">
	                <h1 class="text-xl md:text-2xl font-bold">Calendario Académico main-4v6</h1>
	                <div class="md:hidden">
	                    <button @click="setView('dayGridMonth')" :class="{'bg-blue-700': currentView === 'dayGridMonth'}" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-alt"></i>
	                    </button>
	                    <button @click="setView('dayGridWeek')" :class="{'bg-blue-700': currentView === 'dayGridWeek'}" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-week"></i>
	                    </button>
	                    <button @click="goToToday" class="p-2 rounded-md">
	                        <i class="fas fa-calendar-day"></i>
	                    </button>
	                </div>
	            </div>
	            <div class="flex items-center justify-between space-x-2">
	                <div class="flex items-center space-x-2">
	                    <button @click="navigate('prev')" class="p-2 rounded-full hover:bg-blue-700">
	                        <i class="fas fa-chevron-left"></i>
	                    </button>
	                    <h2 id="calendar-title" class="text-base md:text-lg font-semibold">
	                        {{ getTitle() }}
	                    </h2>
	                    <button @click="navigate('next')" class="p-2 rounded-full hover:bg-blue-700">
	                        <i class="fas fa-chevron-right"></i>
	                    </button>
	                </div>
	                <div class="hidden md:flex space-x-2 ml-4">
	                    <button @click="setView('dayGridMonth')" :class="{'bg-blue-70': currentView === 'dayGridMonth'}" class="px-3 py-1 rounded-md flex items-center" :disabled="disabledButtons.month">
	                        <i class="fas fa-calendar-alt mr-2"></i>
	                        <span>Mes</span>
	                    </button>
	                    <button @click="setView('dayGridWeek')" :class="{'bg-blue-700': currentView === 'dayGridWeek'}" class="px-3 py-1 rounded-md flex items-center" :disabled="disabledButtons.week">
	                        <i class="fas fa-calendar-week mr-2"></i>
	                        <span>Semana</span>
	                    </button>
	                    <button @click="goToToday" class="px-3 py-1 rounded-md flex items-center hover:bg-blue-700" :disabled="disabledButtons.today">
	                        <i class="fas fa-calendar-day mr-2"></i>
	                        <span>Hoy</span>
	                    </button>
			    <button @click="openPeriodoModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.periodo" style="display:none;">
	                        <i class="fas fa-calendar mr-2"></i>
	                        <span>Periodo</span>
	                    </button>
	                    <button @click="toggleTimeline" :class="{'bg-blue-700': showTimeline}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.timeline" style="display:none;">
	                        <i class="fas fa-list-alt mr-2"></i>
	                        <span>Cronograma</span>
	                    </button>	
	                    <button @click="toggleVisorPDF" :class="{'bg-blue-700': showVisorPDF}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.visorPDF">
	                        <i class="fas fa-file-pdf mr-2"></i>
	                        <span>Visor PDF</span>
	                    </button>
	                    <button @click="openTercerosModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.terceros">
	                        <i class="fas fa-users"></i>
	                    </button>
	                    <button @click="openProgrammingModal" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700" :disabled="disabledButtons.programming">
	                        <i class="fas fa-list"></i>
	                    </button>
	                    <button @click="toggleEventLimit" :disabled="currentView !== 'dayGridMonth' || disabledButtons.eventLimit" :class="{'bg-blue-700': limitEvents, 'bg-gray-400 cursor-not-allowed': currentView !== 'dayGridMonth'}" class="px-3 py-1 rounded-md flex items-center justify-center hover:bg-blue-700">
	                        <i :class="limitEvents ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
	                    </button>
	                </div>
	            </div>
	        </div>
	    </div>
	</header>
	<!-- ---------------------------------- -->
	<!-- End Component: Header -->
	<!-- ---------------------------------- -->

        <!-- ---------------------------------- -->
        <!-- Component: Calendar -->
        <!-- ---------------------------------- -->
        <div id="calendar" class="flex-1" v-show="!showTimeline"></div>
        <!-- ---------------------------------- -->
        <!-- End Component: Calendar -->
        <!-- ---------------------------------- -->

        <!-- ---------------------------------- -->
	<!-- Component: Event Modal -->
	<!-- ---------------------------------- -->
	<div v-if="showModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
		<div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
			<div class="p-6">
				<div class="flex justify-between items-center mb-4">
					<h3 class="text-lg font-semibold text-gray-900">
						{{ currentEvent ? 'Editar Viático' : 'Nuevo Viático' }}
					</h3>
					<div class="flex items-center space-x-3">
						<div class="flex items-center">
							<label for="viatica" class="text-sm font-medium text-gray-700 mr-2">Viática</label>
							<input type="checkbox" id="viatica" v-model="form.viatica" class="h-6 w-6 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
						</div>
						<button @click="closeModal" class="text-gray-400 hover:text-gray-500">
							<i class="fas fa-times"></i>
						</button>
					</div>
				</div>
				<div v-if="error" class="mb-4 p-2 bg-red-100 text-red-700 rounded-md">
					{{ error }}
				</div>
				<form @submit.prevent="saveEvent">
					<div class="space-y-4">
						<div>
							<div class="relative">
								<input
									id="title"
									v-model="searchQuery"
									@focus="showOptions = true"
									@blur="hideOptions"
									@input="filterTerceros"
									placeholder="Selecciona un tercero..."
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
								<div v-if="showOptions && filteredTerceros.length" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
									<div
										v-for="tercero in filteredTerceros"
										:key="tercero.id"
										class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
										@mousedown="selectTercero(tercero)"
									>
										{{ tercero.nombreTercero }}
									</div>
								</div>
								<div v-else-if="showOptions" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
									<div class="px-3 py-2 text-gray-500">No se encontraron resultados</div>
								</div>
							</div>
							<input type="hidden" v-model="form.terceroId" name="terceroId" />
						</div>
						<div>
							<label for="description" class="block text-sm font-medium text-gray-700">Descripción de la comisión de servicios o salida de campo</label>
							<textarea
								id="description"
								v-model="form.description"
								@input="handleDescriptionInput"
								rows="3"
								maxlength="120"
								class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
							></textarea>
						</div>
						<div class="grid grid-cols-2 gap-4">
							<div class="relative">
								<label for="origen" class="block text-sm font-medium text-gray-700">Origen</label>
								<input
									id="origen"
									v-model="origenQuery"
									@focus="showOrigenOptions = true"
									@blur="hideOrigenOptions"
									@input="filterOrigenCities"
									placeholder="Selecciona una ciudad..."
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
								<div v-if="showOrigenOptions && filteredOrigenCities.length" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
									<div
										v-for="city in filteredOrigenCities"
										:key="city.id"
										class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
										@mousedown="selectOrigenCity(city)"
									>
										{{ city.nombreCiudad }}
									</div>
								</div>
								<div v-else-if="showOrigenOptions" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
									<div class="px-3 py-2 text-gray-500">No hay resultados</div>
								</div>
							</div>
							<div class="relative">
								<label for="destino" class="block text-sm font-medium text-gray-700">Destino</label>
								<input
									id="destino"
									v-model="destinoQuery"
									@focus="showDestinoOptions = true"
									@blur="hideDestinoOptions"
									@input="filterDestinoCities"
									placeholder="Selecciona una ciudad..."
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
								<div v-if="showDestinoOptions && filteredDestinoCities.length" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
									<div
										v-for="city in filteredDestinoCities"
										:key="city.id"
										class="px-3 py-2 hover:bg-gray-100 cursor-pointer"
										@mousedown="selectDestinoCity(city)"
									>
										{{ city.nombreCiudad }}
									</div>
								</div>
								<div v-else-if="showDestinoOptions" class="absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg">
									<div class="px-3 py-2 text-gray-500">No hay resultados</div>
								</div>
							</div>
						</div>
						<div class="grid grid-cols-2 gap-4">
							<div>
								<label for="dateRange" class="block text-sm font-medium text-gray-700">Rango de Fechas *</label>
								<input type="text" id="dateRange" ref="dateRangePicker" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
							</div>
							<div>
								<label for="rutaAdicional" class="block text-sm font-medium text-gray-700">Ruta Adicional</label>
								<input
									type="text"
									id="rutaAdicional"
									v-model="form.rutaAdicional"
									@input="handleRutaAdicionalInput"
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
							</div>
						</div>
						<div class="flex items-end gap-4">
							<div class="flex-1">
								<label for="transporte" class="block text-sm font-medium text-gray-700">Transporte</label>
								<input
									type="text"
									id="transporte"
									v-model="form.transporte"
									@input="handleTransporteInput"
									class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
								>
							</div>
							<div class="flex-1">
								<label for="color" class="block text-sm font-medium text-gray-700">Color</label>
								<select id="color" v-model="form.color" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
									<option value="#3b82f6">Azul</option>
									<option value="#10b981">Verde</option>
									<option value="#8b5cf6">Morado</option>
									<option value="#f59e0b">Amarillo</option>
									<option value="#ef4444">Rojo</option>
								</select>
							</div>
							<div class="flex space-x-3 items-end">
								<button v-if="currentEvent" type="button" @click="deleteEvent" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
									Eliminar
								</button>
								<button type="button" @click="closeModal" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
									Cancelar
								</button>
								<button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
									Guardar
								</button>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- ---------------------------------- -->
	<!-- End Component: Event Modal -->
	<!-- ---------------------------------- -->
		
<!-- ---------------------------------- -->
<!-- Component: Visor PDF -->
<!-- ---------------------------------- -->
<div v-if="isGeneratingPDF" class="loading-modal">
    <div class="loading-spinner"></div>
</div>
<div id="visorPDF" class="flex-1" v-show="showVisorPDF">
    <!-- Generar PDF Button -->
    <button @click="generatePDF" class="generate-pdf-button">Generar PDF</button>
    <!-- Added hidden #outline element to satisfy theViewer -->
    <div id="outline" style="display: none;"></div>
    <div v-if="viaticos.length === 0" class="text-center visorPDF-white py-4">
        No hay viáticos disponibles para mostrar. Por favor, genera la programación primero.
    </div>

    <!-- Render templates based on tipoTercero -->
    <div v-for="(viatico, index) in viaticos" :key="index">
        <!-- CATEDRATICO Template -->
        <div v-if="viatico.tercero.tipoTercero === 'CATEDRATICO'" :id="'pf1-' + index" class="pf w0 h0" :data-page-no="index + 1">
            <div class="pc pc1 w0 h0">
                <img class="bi x0 y0 w1 h1" alt="" src="assets/bg1.png?v=1" />
                <div class="c x1 y1 w2 h2">
                    <div class="t m0 x2 h3 y2 ff1 fs0 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div>
                    <div class="t m0 x2 h3 y3 ff1 fs0 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div>
                    <div class="t m0 x3 h3 y4 ff1 fs0 fc0 sc0 ls0 ws0">CATEDRATICO</div>
                </div>
                <!-- ... Rest of pf1 template content ... -->
                <div class="c x0 y60 w15 h22"><div class="t m0 x5 h1f y67 ff3 fs3 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
            </div>
            <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
        </div>

        <!-- SERVIDOR Template -->
        <div v-if="viatico.tercero.tipoTercero === 'SERVIDOR'" :id="'pf2-' + index" class="pf w18 h23" :data-page-no="index + 1">
            <div class="pc pc2 w18 h23">
                <img class="bi x0 y0 w19 h24" alt="" src="assets/bg2.png?v=1" />
                <div class="c x2e y68 w1a h25">
                    <div class="t m0 x2f h26 y69 ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div>
                    <div class="t m0 x5 h26 y6a ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div>
                    <div class="t m0 x30 h26 y6b ff1 fs4 fc0 sc0 ls0 ws0">SERVIDOR</div>
                </div>
                <!-- ... Rest of pf2 template content ... -->
		<div class="c x0 ya0 w2b h3b"><div class="t m0 x26 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Descripción del día</div></div>
		<div class="c x36 ya0 w24 h3b"><div class="t m0 x3f h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">No. de Días</div></div>
		<div class="c x33 ya0 w1f h3b"><div class="t m0 x40 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Viáticos Diario</div></div>
		<div class="c x31 ya0 w1b h3b"><div class="t m0 x24 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Total</div></div>
		<div class="c x0 ya2 w2b h3c"><div class="t m0 x3b h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">Pernoctados</div></div>
		<div class="c x36 ya2 w24 h3c"><div class="t m0 x3d h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaPernoctados }}</div></div>
		<div class="c x33 ya2 w1f h3c">
		    <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiario) }}</div>
		</div>
		<div class="c x31 ya2 w1b h3c">
		    <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _7"> </span>-</div>
		</div>
		<div class="c x0 ya4 w2b h3c"><div class="t m0 x25 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">No Pernoctados</div></div>
		<div class="c x36 ya4 w24 h3c"><div class="t m0 x3d h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaNoPernoctados }}</div></div>
		<div class="c x33 ya4 w1f h3c">
		    <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(REDONDEAR(computeViaticoDetails(viatico).viaticoValorDiario / 2, 0)) }}</div>
		</div>
		<div class="c x31 ya4 w1b h3c">
		    <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiarioMedio) }}</div>
		</div>
		<div class="c x0 ya6 w2c h3c"><div class="t m0 x41 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">Total Viáticos</div></div>
		<div class="c x31 ya6 w1b h3c">
		    <div class="t m0 x5 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoTotal) }}</div>
		</div>
                <div class="c x0 yc7 w2c h42"><div class="t m0 x5 h43 yce ff3 fs8 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
            </div>
            <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
        </div>

        <!-- CONTRATISTA Template -->
	<div v-if="viatico.tercero.tipoTercero === 'CONTRATISTA'" :id="'pf3-' + index" class="pf w18 h23" :data-page-no="index + 1">
	    <div class="pc pc3 w18 h23">
	        <img class="bi x0 y0 w19 h24" alt="" src="assets/bg3.png?v=1" />
	        <div class="c x2e y68 w1a h25">
	            <div class="t m0 x2f h26 y69 ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.nombreTercero || '' }}</div>
	            <div class="t m0 x5 h26 y6a ff1 fs4 fc0 sc0 ls0 ws0">{{ viatico?.tercero?.tipoTercero || '' }}</div>
	            <div class="t m0 x30 h26 y6b ff1 fs4 fc0 sc0 ls0 ws0">CONTRATISTA</div>
	        </div>
	        <!-- ... Rest of pf3 template content ... -->
	        <div class="c x0 ya0 w2b h3b"><div class="t m0 x26 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Descripción del día</div></div>
	        <div class="c x36 ya0 w24 h3b"><div class="t m0 x3f h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">No. de Días</div></div>
	        <div class="c x33 ya0 w1f h3b"><div class="t m0 x40 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Viáticos Diario</div></div>
	        <div class="c x31 ya0 w1b h3b"><div class="t m0 x24 h26 ya1 ff1 fs4 fc2 sc2 ls0 ws0">Total</div></div>
	        <div class="c x0 ya2 w2b h3c"><div class="t m0 x3b h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">Pernoctados</div></div>
	        <div class="c x36 ya2 w24 h3c"><div class="t m0 x3d h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaPernoctados }}</div></div>
	        <div class="c x33 ya2 w1f h3c">
	            <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoValorDiario) }}</div>
	        </div>
	        <div class="c x31 ya2 w1b h3c">
	            <div class="t m0 x5 h2e ya3 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiario) }}</div>
	        </div>
	        <div class="c x0 ya4 w2b h3c"><div class="t m0 x25 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">No Pernoctados</div></div>
	        <div class="c x36 ya4 w24 h3c"><div class="t m0 x3d h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">{{ computeViaticoDetails(viatico).viaticoDiaNoPernoctados }}</div></div>
	        <div class="c x33 ya4 w1f h3c">
	            <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _6"> </span>{{ formatCurrency(REDONDEAR(computeViaticoDetails(viatico).viaticoValorDiario / 2, 0)) }}</div>
	        </div>
	        <div class="c x31 ya4 w1b h3c">
	            <div class="t m0 x5 h2e ya5 ff3 fs4 fc2 sc3 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoDiarioMedio) }}</div>
	        </div>
	        <div class="c x0 ya6 w2c h3c"><div class="t m0 x41 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">Total Viáticos</div></div>
	        <div class="c x31 ya6 w1b h3c">
	            <div class="t m0 x5 h26 ya7 ff1 fs4 fc2 sc2 ls0 ws0">$ <span class="_ _8"> </span>{{ formatCurrency(computeViaticoDetails(viatico).viaticoTotal) }}</div>
	        </div>
	        <div class="c x0 yc7 w2c h42"><div class="t m0 x5 h43 yce ff3 fs8 fc2 sc3 ls0 ws0">Aprobó: Yeimi Viviana Agudo, Directora Territorial</div></div>
	    </div>
	    <div class="pi" data-data='{"ctm":[1.000000,0.000000,0.000000,1.000000,0.000000,0.000000]}'></div>
	</div>
	<!-- End CONTRATISTA Template -->    
    </div>
</div>
<!-- ---------------------------------- -->
<!-- End Component: Visor PDF -->
<!-- ---------------------------------- -->


        <!-- ---------------------------------- -->
        <!-- Component: Programming Modal -->
        <!-- ---------------------------------- -->
        <div v-if="showProgrammingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 modal">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Programación</h3>
                        <button @click="closeProgrammingModal" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="programmingDateRange" class="block text-sm font-medium text-gray-700">Seleccionar Rango de Fechas</label>
                            <input type="text" id="programmingDateRange" ref="programmingDateRangePicker" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div v-if="programmingEventsJson" class="mt-4">
                            <label class="block text-sm font-medium text-gray-700">Total eventos: {{ programmingEventsJson ? JSON.parse(programmingEventsJson).length : 0 }}</label>
                            <pre class="bg-gray-100 p-4 rounded-md overflow-auto max-h-60">{{ programmingEventsJson }}</pre>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" @click="closeProgrammingModal" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Cerrar
                        </button>
                        <button type="button" @click="generateProgrammingJson" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Aceptar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ---------------------------------- -->
        <!-- End Component: Programming Modal -->
        <!-- ---------------------------------- -->


    </div>
  
    <!-- JavaScript and Vue app initialization -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://visjs.github.io/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>    
    <!-- Include jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add JSZip and FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<!-- JavaScript and Vue app initialization -->
<script>
// ----------------------------------
// Component: Vue Setup and Imports
// ----------------------------------
const { createApp, ref, onMounted, onUnmounted, nextTick, computed, reactive } = Vue;

// Mock data for terceros
const mockTerceros = [
    { id: '1', ccTercero: 'CC001', nombreTercero: 'Juan Pérez', inicialTercero: 'JP', tipoDocumentoTercero: '03', numeroDocumentoTercero: '12345678', props: { tipoTercero: 'CONTRATISTA', baseLiquidacion: '5000000', cargoServidor: 'Contratista', entidadBancaria: 'BANCOLOMBIA', cuentaBancaria: '1234567890', tipoCuenta: 'Ahorro', telefono: '3001234567', correo: 'juan.perez@example.com', fechaNacimiento: '1980-05-15', contrato: 'C001' } },
    { id: '2', ccTercero: 'CC002', nombreTercero: 'María Gómez', inicialTercero: 'MG', tipoDocumentoTercero: '03', numeroDocumentoTercero: '87654321', props: { tipoTercero: 'CATEDRATICO', baseLiquidacion: '3000000', cargoServidor: 'Hora Catedra', entidadBancaria: 'BANCO DAVIVIENDA', cuentaBancaria: '0987654321', tipoCuenta: 'Corriente', telefono: '3109876543', correo: 'maria.gomez@example.com', fechaNacimiento: '1990-08-22', contrato: 'C002' } },
    { id: '3', ccTercero: 'CC003', nombreTercero: 'Carlos López', inicialTercero: 'CL', tipoDocumentoTercero: '03', numeroDocumentoTercero: '11223344', props: { tipoTercero: 'SERVIDOR', baseLiquidacion: '4000000', cargoServidor: 'Servidor', entidadBancaria: 'BANCO DE BOGOTA', cuentaBancaria: '4567891234', tipoCuenta: 'Ahorro', telefono: '3204567890', correo: 'carlos.lopez@example.com', fechaNacimiento: '1975-03-10', contrato: 'C003' } }
];

// Mock data source simulation
const TerceroDataSource = async () => {
    return new Promise((resolve) => {
        setTimeout(() => resolve([...mockTerceros]), 500);
    });
};

// Mock data for cities
const mockCities = [
    { id: '1', nombreCiudad: 'CALI', departamento: 'VALLE', categoria: 1 },
    { id: '2', nombreCiudad: 'BOGOTA', departamento: 'CUNDINAMARCA', categoria: 2 },
    { id: '3', nombreCiudad: 'MEDELLIN', departamento: 'ANTIOQUIA', categoria: 1 },
    { id: '4', nombreCiudad: 'CARTAGENA', departamento: 'BOLIVAR', categoria: 3 },
    { id: '5', nombreCiudad: 'BARRANQUILLA', departamento: 'ATLANTICO', categoria: 2 },
    { id: '6', nombreCiudad: 'PEREIRA', departamento: 'RISARALDA', categoria: 1 }
];

// Mock data source simulation for cities
const CityDataSource = async () => {
    return new Promise((resolve) => {
        setTimeout(() => resolve([...mockCities]), 500);
    });
};
// ----------------------------------
// End Component: Vue Setup and Imports
// ----------------------------------

// ----------------------------------
// Component: Vue App Initialization
// ----------------------------------
const app = createApp({
    setup() {
        // ----------------------------------
        // Component: State management
        // ----------------------------------
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const currentView = ref('dayGridMonth');
        const calendarApi = ref(null);
        const events = ref(JSON.parse(localStorage.getItem('academicEvents')) || []);
        const showModal = ref(false);
        const currentEvent = ref(null);
        const error = ref(null);
        const dateRangePicker = ref(null);
        const limitEvents = ref(true);
        const form = ref({
            title: '',
            description: '',
            startDate: '',
            endDate: '',
            color: '#3b82f6',
            terceroId: '',
            viatica: true,
            transporte: '',
            origen: '',
            destino: '',
            rutaAdicional: ''
        });
        const showProgrammingModal = ref(false);
        const programmingDateRangePicker = ref(null);
        const programmingRange = ref({ start: '', end: '' });
        const programmingEventsJson = ref(null);
        const showTercerosModal = ref(false);
        const terceros = ref([]);
        const searchQuery = ref('');
        const showOptions = ref(false);
        const currentTercero = ref(null);
        const showTerceroForm = ref(false);
        const terceroForm = ref({
            id: '',
            ccTercero: '',
            nombreTercero: '',
            inicialTercero: '',
            tipoDocumentoTercero: '03',
            numeroDocumentoTercero: '',
            props: {
                tipoTercero: 'CONTRATISTA',
                baseLiquidacion: '',
                cargoServidor: 'Servidor',
                entidadBancaria: 'BANCOLOMBIA',
                cuentaBancaria: '',
                tipoCuenta: 'Ahorro',
                telefono: '',
                correo: '',
                fechaNacimiento: '',
                contrato: ''
            }
        });
        let flatpickrInstance = null;
        let programmingFlatpickrInstance = null;
        const showPeriodoModal = ref(false);
        const periodos = ref(JSON.parse(localStorage.getItem('periodos')) || []);
        const currentPeriodo = ref(null);
        const periodoForm = ref({
            periodo: '2025-1',
            centro: 'CALI',
            programa: 'ADMINISTRACION PUBLICA',
            semestres: Array(10).fill(false),
            asignaturas: {}
        });
        const showTimeline = ref(false);
        const timelineContainer = ref(null);
        let timeline = null;
        const timelineModalState = reactive({
            isOpen: false,
            action: 'add',
            eventData: { id: '', content: '', group: '', start: '', end: '' }
        });
        const DEPENDENCIA = "0072DP - DECANATURA PREGRADO";
        const viaticos = ref([]);
        const isGeneratingPDF = ref(false);    
        const showVisorPDF = ref(false);
        const disabledButtons = ref({
            month: false,
            week: false,
            today: false,
            periodo: false,
            timeline: false,
            visorPDF: false,
            terceros: false,
            programming: false,
            eventLimit: false
        });
        // ----------------------------------
        // End Component: State management
        // ----------------------------------

        // ----------------------------------
        // Component: Button State Management
        // ----------------------------------
        const updateButtonStates = () => {
            if (showTimeline.value) {
                disabledButtons.value = {
                    month: true,
                    week: true,
                    today: true,
                    periodo: true,
                    timeline: false,
                    visorPDF: true,
                    terceros: true,
                    programming: true,
                    eventLimit: true
                };
            } else if (showVisorPDF.value) {
                disabledButtons.value = {
                    month: true,
                    week: true,
                    today: true,
                    periodo: true,
                    timeline: true,
                    visorPDF: false,
                    terceros: true,
                    programming: true,
                    eventLimit: true
                };
            } else {
                disabledButtons.value = {
                    month: false,
                    week: false,
                    today: false,
                    periodo: false,
                    timeline: false,
                    visorPDF: false,
                    terceros: false,
                    programming: false,
                    eventLimit: currentView.value !== 'dayGridMonth'
                };
            }
        };
        // ----------------------------------
        // End Component: Button State Management
        // ----------------------------------

        // ----------------------------------
        // Component: Terceros Management
        // ----------------------------------
        const loadTerceros = async () => {
            terceros.value = await TerceroDataSource();
        };

        const filteredTerceros = computed(() => {
            if (!searchQuery.value) return terceros.value;
            return terceros.value.filter(tercero => 
                tercero.nombreTercero.toLowerCase().includes(searchQuery.value.toLowerCase())
            );
        });

        const filterTerceros = () => {
            showOptions.value = true;
        };

        const selectTercero = (tercero) => {
            form.value.terceroId = tercero.id;
            form.value.title = tercero.nombreTercero;
            searchQuery.value = tercero.nombreTercero;
            showOptions.value = false;
        };

        const hideOptions = () => {
            setTimeout(() => {
                showOptions.value = false;
            }, 200);
        };

        const openTercerosModal = async () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showTercerosModal.value = true;
            showTerceroForm.value = false;
            await loadTerceros();
            updateButtonStates();
        };

        const closeTercerosModal = () => {
            showTercerosModal.value = false;
            showTerceroForm.value = false;
            currentTercero.value = null;
            updateButtonStates();
        };

        const openTerceroForm = () => {
            showTerceroForm.value = true;
            currentTercero.value = null;
            terceroForm.value = {
                id: '',
                ccTercero: '',
                nombreTercero: '',
                inicialTercero: '',
                tipoDocumentoTercero: '03',
                numeroDocumentoTercero: '',
                props: {
                    tipoTercero: 'CONTRATISTA',
                    baseLiquidacion: '',
                    cargoServidor: 'Servidor',
                    entidadBancaria: 'BANCOLOMBIA',
                    cuentaBancaria: '',
                    tipoCuenta: 'Ahorro',
                    telefono: '',
                    correo: '',
                    fechaNacimiento: '',
                    contrato: ''
                }
            };
        };

        const closeTerceroForm = () => {
            showTerceroForm.value = false;
            currentTercero.value = null;
        };

        const editTercero = (tercero) => {
            currentTercero.value = tercero;
            terceroForm.value = JSON.parse(JSON.stringify(tercero));
            showTerceroForm.value = true;
        };

        const saveTercero = () => {
            if (!terceroForm.value.nombreTercero || !terceroForm.value.numeroDocumentoTercero) {
                alert('El nombre y el número de documento son requeridos.');
                return;
            }
            if (currentTercero.value) {
                const index = terceros.value.findIndex(t => t.id === currentTercero.value.id);
                if (index !== -1) terceros.value[index] = { ...terceroForm.value };
            } else {
                const newTercero = { ...terceroForm.value, id: Date.now().toString() };
                terceros.value.push(newTercero);
            }
            closeTerceroForm();
        };

        const deleteTercero = (id) => {
            if (confirm('¿Estás seguro de eliminar este tercero?')) {
                terceros.value = terceros.value.filter(t => t.id !== id);
            }
        };
        // ----------------------------------
        // End Component: Terceros Management
        // ----------------------------------

        // ----------------------------------
        // Component: Cities Management
        // ----------------------------------
        const cities = ref([]);
        const origenQuery = ref('');
        const destinoQuery = ref('');
        const showOrigenOptions = ref(false);
        const showDestinoOptions = ref(false);

        const loadCities = async () => {
            cities.value = await CityDataSource();
        };

        const filteredOrigenCities = computed(() => {
            if (!origenQuery.value) return cities.value;
            return cities.value.filter(city => 
                city.nombreCiudad.toLowerCase().includes(origenQuery.value.toLowerCase())
            );
        });

        const filteredDestinoCities = computed(() => {
            if (!destinoQuery.value) return cities.value;
            return cities.value.filter(city => 
                city.nombreCiudad.toLowerCase().includes(destinoQuery.value.toLowerCase())
            );
        });

        const filterOrigenCities = () => {
            showOrigenOptions.value = true;
        };

        const filterDestinoCities = () => {
            showDestinoOptions.value = true;
        };

        const selectOrigenCity = (city) => {
            form.value.origen = city.id;
            origenQuery.value = city.nombreCiudad;
            showOrigenOptions.value = false;
        };

        const selectDestinoCity = (city) => {
            form.value.destino = city.id;
            destinoQuery.value = city.nombreCiudad;
            showDestinoOptions.value = false;
        };

        const hideOrigenOptions = () => {
            setTimeout(() => {
                showOrigenOptions.value = false;
            }, 200);
        };

        const hideDestinoOptions = () => {
            setTimeout(() => {
                showDestinoOptions.value = false;
            }, 200);
        };
        // ----------------------------------
        // End Component: Cities Management
        // ----------------------------------

        // ----------------------------------
        // Component: Viáticos Calculation Functions
        // ----------------------------------
        // Function to calculate the base tariff based on baseLiquidacion
        const tarifaViaticosDiario = (valor) => {
            const numValor = parseFloat(valor.replace(/,/g, '')); // Remove commas if any
            if (numValor >= 0 && numValor <= 1674542) return 151878;
            if (numValor <= 2631382) return 207569;
            if (numValor <= 3613828) return 251853;
            if (numValor <= 4456815) return 293056;
            if (numValor <= 5382527) return 336520;
            if (numValor <= 8117664) return 379828;
            if (numValor <= 11345698) return 461358;
            if (numValor <= 13471440) return 622374;
            if (numValor <= 16583843) return 809075;
            if (numValor <= 20053045) return 978656;
            return 1152515; // For values >= 20,053,046 ("En adelante")
        };

        // Function to calculate the viático value based on tipoTercero
        const valorViaticosDiario = (viatico) => {
            const tarifaBase = tarifaViaticosDiario(viatico.tercero.props.baseLiquidacion); // Use baseLiquidacion from tercero props

            if (viatico.tercero.tipoTercero === 'SERVIDOR') {
                return tarifaBase * 1.0; // 100% of tarifaBase
            } 
            if (viatico.tercero.tipoTercero === 'CONTRATISTA') {
                return tarifaBase * 0.8; // 80% of tarifaBase
            }

            return tarifaBase; // Default case if tipoTercero is neither SERVIDOR nor CONTRATISTA
        };

        // Function to round numbers as per REDONDEAR specification
        const REDONDEAR = (value, decimals) => {
            return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
        };

        // Function to format numbers with dots for thousands and comma for decimals (e.g., 622.374,00)
        const formatCurrency = (value) => {
            const rounded = REDONDEAR(value, 2); // Ensure 2 decimal places
            const [integerPart, decimalPart = '00'] = rounded.toFixed(2).split('.');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.'); // Add dots for thousands
            return `${formattedInteger},${decimalPart.padStart(2, '0')}`; // Use comma for decimals
        };

        // Compute viático details for each viatico object (used in template)
        const computeViaticoDetails = (viatico) => {
            // Parse dates in DD/MM/YYYY format
            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('/').map(Number);
                return new Date(year, month - 1, day);
            };

            const startDate = parseDate(viatico.event.startDate);
            const endDate = parseDate(viatico.event.endDate);

            // Calculate total days (inclusive of start and end dates)
            const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            // Apply logic for viaticoDiaPernoctados and viaticoDiaNoPernoctados based on totalDays
            let viaticoDiaPernoctados, viaticoDiaNoPernoctados;
            if (totalDays === 1) {
                viaticoDiaPernoctados = 0;
                viaticoDiaNoPernoctados = 1;
            } else if (totalDays === 2) {
                viaticoDiaPernoctados = 1;
                viaticoDiaNoPernoctados = 1;
            } else if (totalDays === 3) {
                viaticoDiaPernoctados = 2;
                viaticoDiaNoPernoctados = 1;
            } else if (totalDays >= 4) {
                viaticoDiaPernoctados = totalDays - 1; // For 4 days: 3 pernoctados
                viaticoDiaNoPernoctados = 1;
            } else {
                // Fallback for unexpected cases
                viaticoDiaPernoctados = totalDays > 1 ? totalDays - 1 : 0;
                viaticoDiaNoPernoctados = totalDays > 1 ? 1 : totalDays;
            }

            // Calculate valorViaticosDiario using the function
            const viaticoValorDiario = valorViaticosDiario(viatico);

            // Calculate viaticoDiario = valorViaticosDiario * viaticoDiaPernoctados
            const viaticoDiario = viaticoValorDiario * viaticoDiaPernoctados;

            // Calculate viaticoDiarioMedio = REDONDEAR((valorViaticosDiario/2), 0) * viaticoDiaNoPernoctados
            const viaticoDiarioMedio = REDONDEAR(viaticoValorDiario / 2, 0) * viaticoDiaNoPernoctados;

            // Calculate viaticoTotal = viaticoDiario + viaticoDiarioMedio
            const viaticoTotal = viaticoDiario + viaticoDiarioMedio;

            return {
                viaticoDiaPernoctados,
                viaticoDiaNoPernoctados,
                viaticoValorDiario,
                viaticoDiario,
                viaticoDiarioMedio,
                viaticoTotal
            };
        };
        // ----------------------------------
        // End Component: Viáticos Calculation Functions
        // ----------------------------------

        // ----------------------------------
        // Component: Calendar Management
        // ----------------------------------
        const getTitle = () => {
            if (!calendarApi.value) return '';
            const view = calendarApi.value.view;
            if (view.type === 'dayGridMonth') {
                const date = view.currentStart;
                return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            } else if (view.type === 'dayGridWeek') {
                const start = view.currentStart;
                const end = view.currentEnd;
                end.setDate(end.getDate() - 1);
                if (start.getMonth() === end.getMonth()) {
                    return `${start.getDate()} - ${end.getDate()} ${monthNames[start.getMonth()]} ${start.getFullYear()}`;
                } else if (start.getFullYear() === end.getFullYear()) {
                    return `${start.getDate()} ${monthNames[start.getMonth()].substring(0, 3)} - ${end.getDate()} ${monthNames[end.getMonth()].substring(0, 3)} ${start.getFullYear()}`;
                } else {
                    return `${start.getDate()} ${monthNames[start.getMonth()].substring(0, 3)} ${start.getFullYear()} - ${end.getDate()} ${monthNames[end.getMonth()].substring(0, 3)} ${end.getFullYear()}`;
                }
            }
            return '';
        };

        const darkenColor = (color, percent) => {
            if (!color) return '#3b82f6';
            if (color.startsWith('#')) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = Math.max(0, (num >> 16) - amt);
                const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
                const B = Math.max(0, (num & 0x0000FF) - amt);
                return `#${(0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1)}`;
            }
            return '#2563eb';
        };

        const navigate = (direction) => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            if (direction === 'prev') calendarApi.value.prev();
            else if (direction === 'next') calendarApi.value.next();
            updateTitle();
        };

        const setView = (view) => {
            if (showTimeline.value || showVisorPDF.value) return;
            currentView.value = view;
            if (calendarApi.value) {
                calendarApi.value.changeView(view);
                if (view === 'dayGridMonth') {
                    calendarApi.value.setOption('dayMaxEventRows', limitEvents.value ? 4 : false);
                    calendarApi.value.setOption('dayMaxEvents', limitEvents.value ? 4 : false);
                } else if (view === 'dayGridWeek') {
                    calendarApi.value.setOption('dayMaxEventRows', false);
                    calendarApi.value.setOption('dayMaxEvents', false);
                }
                updateTitle();
                updateButtonStates();
            }
        };

        const goToToday = () => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            calendarApi.value.today();
            setView(currentView.value);
            updateTitle();
        };

        const toggleEventLimit = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            limitEvents.value = !limitEvents.value;
            if (calendarApi.value && currentView.value === 'dayGridMonth') {
                calendarApi.value.setOption('dayMaxEventRows', limitEvents.value ? 4 : false);
                calendarApi.value.setOption('dayMaxEvents', limitEvents.value ? 4 : false);
            }
            updateButtonStates();
        };

        const updateTitle = () => {
            const titleElement = document.getElementById('calendar-title');
            if (titleElement) titleElement.textContent = getTitle();
        };

        const renderEvents = () => {
            if (!calendarApi.value || showTimeline.value || showVisorPDF.value) return;
            try {
                calendarApi.value.getEvents().forEach(event => event.remove());
                events.value.forEach(event => {
                    calendarApi.value.addEvent({
                        id: event.id,
                        title: event.title,
                        start: event.startDate,
                        end: event.endDate,
                        allDay: true,
                        backgroundColor: event.color || '#3b82f6',
                        borderColor: darkenColor(event.color, 20),
                        extendedProps: { 
                            description: event.description || '',
                            terceroId: event.terceroId || '',
                            viatica: event.viatica || false,
                            transporte: event.transporte || '',
                            origen: event.origen || '',
                            destino: event.destino || '',
                            rutaAdicional: event.rutaAdicional || ''
                        }
                    });
                });
            } catch (error) {
                console.error('Error in renderEvents:', error);
            }
        };

        const reinitializeCalendar = () => {
            try {
                const calendarEl = document.getElementById('calendar');
                if (!calendarEl) {
                    console.error('Calendar element not found');
                    return;
                }

                calendarEl.classList.remove('hidden');
                calendarEl.style.height = '100%';

                const savedView = currentView.value;
                const savedEvents = [...events.value];

                if (calendarApi.value) {
                    calendarApi.value.destroy();
                    calendarApi.value = null;
                }

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    locale: 'es',
                    initialView: savedView,
                    headerToolbar: false,
                    firstDay: 1,
                    dayHeaderFormat: { weekday: 'long' },
                    height: '100%',
                    contentHeight: '100%',
                    eventClick: (info) => {
                        editEvent(info);
                    },
                    dateClick: function(info) {
                        openModal(info.dateStr);
                    },
                    eventDisplay: 'block',
                    eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                    eventDidMount: function(info) {
                        if (info.event.allDay && info.event.start && info.event.end) {
                            const start = info.event.start;
                            const end = info.event.end;
                            const duration = (end - start) / (1000 * 60 * 60 * 24);
                            if (duration > 1) {
                                info.el.style.borderLeftWidth = '4px';
                                info.el.style.borderLeftStyle = 'solid';
                                info.el.style.borderLeftColor = darkenColor(info.event.backgroundColor, 20);
                            }
                        }
                    },
                    dayHeaderContent: function(arg) {
                        const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                        return { html: `<div>${dayName}</div>` };
                    },
                    views: {
                        dayGridMonth: {
                            dayMaxEventRows: limitEvents.value ? 4 : false,
                            dayMaxEvents: limitEvents.value ? 4 : false,
                            fixedWeekCount: false,
                            aspectRatio: 1.5
                        },
                        dayGridWeek: {
                            type: 'dayGrid',
                            duration: { weeks: 1 },
                            dayCount: 7,
                            dayMaxEventRows: false,
                            dayMaxEvents: false,
                            titleFormat: { year: 'numeric', month: 'long', day: 'numeric' },
                            dayHeaderContent: function(arg) {
                                const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                                const dayNumber = arg.date.getDate();
                                return {
                                    html: `
                                        <div class="flex flex-col items-center">
                                            <span class="fc-day-name">${dayName}</span>
                                            <span class="fc-day-number">${dayNumber}</span>
                                        </div>
                                    `
                                };
                            }
                        }
                    },
                    datesSet: function() {
                        updateTitle();
                    }
                });

                calendarApi.value = calendar;
                calendar.render();

                events.value = savedEvents;
                renderEvents();

                calendar.updateSize();

                const debounce = (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                };

                const handleResize = debounce(() => {
                    if (calendarApi.value) {
                        calendarApi.value.updateSize();
                    }
                }, 100);

                window.addEventListener('resize', handleResize);

                nextTick(() => {
                    window.removeEventListener('resize', handleResize);
                });

                updateButtonStates();
            } catch (error) {
                console.error('Error reinitializing calendar:', error);
            }
        };
        // ----------------------------------
        // End Component: Calendar Management
        // ----------------------------------

        // ----------------------------------
        // Component: Event Management
        // ----------------------------------
        const openModal = (date) => {
            if (showTimeline.value || showVisorPDF.value) return;
            if (date) {
                form.value.startDate = date;
                form.value.endDate = date;
            } else if (!currentEvent.value) {
                const today = new Date().toISOString().split('T')[0];
                form.value.startDate = today;
                form.value.endDate = today;
            }
            showModal.value = true;

            nextTick(() => {
                if (dateRangePicker.value) {
                    flatpickrInstance = flatpickr(dateRangePicker.value, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        locale: 'es',
                        defaultDate: [form.value.startDate, form.value.endDate],
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                form.value.startDate = selectedDates[0].toISOString().split('T')[0];
                                form.value.endDate = selectedDates[1].toISOString().split('T')[0];
                            }
                        },
                        onReady: (selectedDates, dateStr, instance) => {
                            if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                                dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                            }
                        },
                        onOpen: (selectedDates, dateStr, instance) => {
                            if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                                dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                            }
                        }
                    });

                    if ((date && form.value.startDate === form.value.endDate) || currentEvent.value) {
                        dateRangePicker.value.value = `${form.value.startDate} a ${form.value.endDate}`;
                    }
                }
            });
        };

        const closeModal = () => {
            showModal.value = false;
            currentEvent.value = null;
            error.value = null;
            form.value = {
                title: '',
                description: '',
                startDate: '',
                endDate: '',
                color: '#3b82f6',
                terceroId: '',
                viatica: true,
                transporte: '',
                origen: '',
                destino: '',
                rutaAdicional: ''
            };
            searchQuery.value = '';
            showOptions.value = false;
            origenQuery.value = '';
            destinoQuery.value = '';
            showOrigenOptions.value = false;
            showDestinoOptions.value = false;
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                flatpickrInstance = null;
            }
        };

        const computeViatico = () => {
            const eventToUse = currentEvent.value || form.value;
            if (eventToUse.terceroId && eventToUse.destino) {
                const viaticoObj = createViaticoObject(eventToUse, terceros.value, cities.value);
                if (viaticoObj && !viaticos.value.some(v => v.event.startDate === viaticoObj.event.startDate && v.tercero.numeroDocumentoTercero === viaticoObj.tercero.numeroDocumentoTercero)) {
                    viaticos.value.push(viaticoObj);
                }
            }
        };

        const editEvent = (eventInfo) => {
            if (showTimeline.value || showVisorPDF.value) return;
            const endDate = new Date(eventInfo.event.end || eventInfo.event.start);
            endDate.setDate(endDate.getDate() - 1);
            
            const origenCity = cities.value.find(city => city.id === eventInfo.event.extendedProps.origen);
            const destinoCity = cities.value.find(city => city.id === eventInfo.event.extendedProps.destino);

            currentEvent.value = {
                id: eventInfo.event.id,
                title: eventInfo.event.title,
                description: eventInfo.event.extendedProps.description || '',
                startDate: eventInfo.event.startStr.split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                color: eventInfo.event.backgroundColor || '#3b82f6',
                terceroId: eventInfo.event.extendedProps.terceroId || '',
                viatica: eventInfo.event.extendedProps.viatica || false,
                transporte: eventInfo.event.extendedProps.transporte || '',
                origen: eventInfo.event.extendedProps.origen || '',
                destino: eventInfo.event.extendedProps.destino || '',
                rutaAdicional: eventInfo.event.extendedProps.rutaAdicional || ''
            };

            form.value = { ...currentEvent.value };
            searchQuery.value = form.value.title;
            origenQuery.value = origenCity ? origenCity.nombreCiudad : '';
            destinoQuery.value = destinoCity ? destinoCity.nombreCiudad : '';
            computeViatico();
            openModal();
        };

        const saveEvent = () => {
            if (!form.value.title) {
                error.value = 'El título es requerido';
                return;
            }
            if (!form.value.startDate || !form.value.endDate) {
                error.value = 'Las fechas son requeridas';
                return;
            }
            const startDate = new Date(form.value.startDate);
            const endDate = new Date(form.value.endDate);
            if (startDate > endDate) {
                error.value = 'La fecha de inicio no puede ser posterior a la fecha final';
                return;
            }
            error.value = null;
            const startDateStr = `${form.value.startDate}T00:00:00`;
            const adjustedEndDate = new Date(form.value.endDate);
            adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
            const endDateStr = adjustedEndDate.toISOString().split('T')[0] + 'T00:00:00';

            const eventData = {
                id: currentEvent.value ? currentEvent.value.id : Date.now().toString(),
                title: form.value.title,
                description: form.value.description,
                startDate: startDateStr,
                endDate: endDateStr,
                color: form.value.color,
                terceroId: form.value.terceroId,
                viatica: form.value.viatica,
                transporte: form.value.transporte,
                origen: form.value.origen,
                destino: form.value.destino,
                rutaAdicional: form.value.rutaAdicional
            };

            if (currentEvent.value) {
                const index = events.value.findIndex(e => e.id === currentEvent.value.id);
                if (index !== -1) events.value[index] = eventData;
            } else {
                events.value.push(eventData);
            }
            localStorage.setItem('academicEvents', JSON.stringify(events.value));
            renderEvents();
            closeModal();
        };

        const deleteEvent = () => {
            if (currentEvent.value) {
                events.value = events.value.filter(e => e.id !== currentEvent.value.id);
                localStorage.setItem('academicEvents', JSON.stringify(events.value));
                renderEvents();
                closeModal();
            }
        };

        const createViaticoObject = (eventData, terceros, cities) => {
            if (!eventData) return null;

            const tercero = terceros.find(t => t.id === eventData.terceroId);
            const destinoCity = cities.find(c => c.id === eventData.destino);
            if (!tercero || !destinoCity) return null;

            const startDate = new Date(eventData.startDate);
            const endDate = new Date(eventData.endDate);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            // Apply logic for duracion based on totalDays
            let duracion;
            if (totalDays === 1) {
                duracion = 0.5;
            } else if (totalDays === 2) {
                duracion = 1.5;
            } else if (totalDays === 3) {
                duracion = 2.5;
            } else if (totalDays >= 4) {
                duracion = totalDays - 0.5; // For 4 days: 3.5, etc.
            } else {
                // Fallback for unexpected cases
                duracion = totalDays > 1 ? totalDays - 0.5 : totalDays / 2;
            }

            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
            };

            const calculateCost = (duration, cityCategory) => {
                const rates = {
                    1: 150000,
                    2: 200000,
                    3: 250000
                };
                return duration * (rates[cityCategory] || 150000);
            };

            return {
                dependencia: DEPENDENCIA,
                currentDate: formatDate(new Date('2025-05-04')),
                duracion: duracion,
                tercero: {
                    nombreTercero: tercero.nombreTercero,
                    nacimiento: tercero.props.fechaNacimiento ? formatDate(tercero.props.fechaNacimiento) : '',
                    numeroDocumentoTercero: tercero.numeroDocumentoTercero,
                    correo: tercero.props.correo,
                    telefono: tercero.props.telefono,
                    entidadBancaria: tercero.props.entidadBancaria,
                    cargoServidor: tercero.props.cargoServidor,
                    tipoCuenta: tercero.props.tipoCuenta,
                    tipoTercero: tercero.props.tipoTercero,
                    cuentaBancaria: tercero.props.cuentaBancaria,
                    props: tercero.props // Include props for baseLiquidacion access
                },
                event: {
                    startDate: formatDate(eventData.startDate),
                    endDate: formatDate(eventData.endDate),
                    description: eventData.description || '',
                    transporte: eventData.transporte || '0',
                    itinerario: eventData.rutaAdicional || '',
                    ciudadDestino: destinoCity.nombreCiudad,
                    ciudadDestinoDepartamento: destinoCity.departamento
                },
                cost: calculateCost(duracion, destinoCity.categoria),
                eventId: eventData.id
            };
        };
        // ----------------------------------
        // End Component: Event Management
        // ----------------------------------

        // ----------------------------------
        // Component: Event Modal Input Formatting
        // ----------------------------------
        const formatTransporte = (value) => {
            const digitsOnly = value.replace(/\D/g, '');
            return digitsOnly.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        };

        const handleTransporteInput = (event) => {
            const input = event.target.value.replace(/,/g, '');
            if (/^\d*$/.test(input)) {
                form.value.transporte = formatTransporte(input);
            } else {
                form.value.transporte = formatTransporte(input.replace(/\D/g, ''));
            }
        };

        const handleRutaAdicionalInput = (event) => {
            let value = event.target.value;
            value = value.replace(/[^a-zA-Z\s]/g, '');
            form.value.rutaAdicional = value.toUpperCase();
        };

        const handleDescriptionInput = (event) => {
            let value = event.target.value;
            value = value.replace(/[^a-zA-Z0-9\-\s]/g, '');
            if (value.length > 120) {
                value = value.substring(0, 120);
            }
            form.value.description = value.toUpperCase();
        };
        // ----------------------------------
        // End Component: Event Modal Input Formatting
        // ----------------------------------

        // ----------------------------------
        // Component: Programming Management
        // ----------------------------------
        const computeViaticoForProgramming = () => {
            console.log('[computeViaticoForProgramming] Starting computation...');
            console.log('[computeViaticoForProgramming] Terceros count:', terceros.value.length);
            console.log('[computeViaticoForProgramming] Cities count:', cities.value.length);
            console.log('[computeViaticoForProgramming] Events count:', events.value.length);

            if (!terceros.value.length || !cities.value.length) {
                console.warn('[computeViaticoForProgramming] Terceros or cities not loaded. Cannot compute viáticos.');
                viaticos.value = [];
                return;
            }

            if (!programmingRange.value.start || !programmingRange.value.end) {
                console.warn('[computeViaticoForProgramming] No date range selected. Setting default range.');
                const today = new Date();
                const start = new Date(today.getFullYear(), today.getMonth(), 1);
                const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                programmingRange.value.start = start.toISOString().split('T')[0];
                programmingRange.value.end = end.toISOString().split('T')[0];
            }

            console.log('[computeViaticoForProgramming] Date range:', {
                start: programmingRange.value.start,
                end: programmingRange.value.end
            });

            const startDate = new Date(programmingRange.value.start);
            const endDate = new Date(programmingRange.value.end);
            endDate.setDate(endDate.getDate() + 1); // Include end date in range

            const filteredEvents = events.value.filter(event => {
                const eventStart = new Date(event.startDate);
                const isWithinRange = eventStart >= startDate && eventStart <= endDate;
                const hasRequiredFields = event.terceroId && event.destino;
                console.log('[computeViaticoForProgramming] Filtering event:', {
                    eventId: event.id,
                    startDate: event.startDate,
                    isWithinRange,
                    hasTercero: !!event.terceroId,
                    hasDestino: !!event.destino,
                    included: isWithinRange && hasRequiredFields
                });
                return isWithinRange && hasRequiredFields;
            });

            console.log('[computeViaticoForProgramming] Filtered events:', filteredEvents.map(e => ({
                id: e.id,
                startDate: e.startDate,
                terceroId: e.terceroId,
                destino: e.destino
            })));

            const newViaticos = filteredEvents
                .map(event => {
                    const viatico = createViaticoObject(event, terceros.value, cities.value);
                    console.log('[computeViaticoForProgramming] Created viatico for event:', {
                        eventId: event.id,
                        viatico: viatico ? {
                            eventId: viatico.eventId,
                            tercero: viatico.tercero.nombreTercero,
                            startDate: viatico.event.startDate,
                            destino: viatico.event.ciudadDestino
                        } : null
                    });
                    return viatico;
                })
                .filter(viatico => viatico !== null);

            // Remove duplicates based on eventId
            viaticos.value = newViaticos.filter((viatico, index, self) =>
                index === self.findIndex(v => v.eventId === viatico.eventId)
            );

            // Force reactivity update
            viaticos.value = reactive([...viaticos.value]);

            console.log('[computeViaticoForProgramming] Computed viáticos:', viaticos.value.map(v => ({
                eventId: v.eventId,
                tercero: v.tercero.nombreTercero,
                startDate: v.event.startDate,
                destino: v.event.ciudadDestino,
                cost: v.cost
            })));

            if (!viaticos.value.length) {
                console.warn('[computeViaticoForProgramming] No viáticos generated for the selected date range.');
            } else {
                console.log('[computeViaticoForProgramming] Total viáticos generated:', viaticos.value.length);
            }
        };

        const generateProgrammingJson = () => {
            console.log('[generateProgrammingJson] Starting...');
            console.log('[generateProgrammingJson] Initial state:', {
                tercerosCount: terceros.value.length,
                citiesCount: cities.value.length,
                eventsCount: events.value.length,
                programmingRange: programmingRange.value,
                viaticosCount: viaticos.value.length
            });

            if (!terceros.value.length || !cities.value.length) {
                console.error('[generateProgrammingJson] Error: Terceros or cities not loaded.');
                alert('Error: Terceros o ciudades no están cargados.');
                return;
            }

            if (!programmingRange.value.start || !programmingRange.value.end) {
                console.warn('[generateProgrammingJson] No date range selected.');
                alert('Por favor, selecciona un rango de fechas.');
                return;
            }

            console.log('[generateProgrammingJson] Computing viáticos...');
            computeViaticoForProgramming();

            console.log('[generateProgrammingJson] Viaticos after computation:', {
                count: viaticos.value.length,
                details: viaticos.value.map(v => ({
                    eventId: v.eventId,
                    tercero: v.tercero.nombreTercero,
                    startDate: v.event.startDate,
                    endDate: v.event.endDate,
                    destino: v.event.ciudadDestino,
                    cost: v.cost
                }))
            });

            const startDate = new Date(programmingRange.value.start);
            const endDate = new Date(programmingRange.value.end);
            endDate.setDate(endDate.getDate() + 1); // Include end date

            console.log('[generateProgrammingJson] Filtering events for JSON...', {
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString()
            });

            const filteredEvents = events.value.filter(event => {
                const eventStart = new Date(event.startDate);
                const isWithinRange = eventStart >= startDate && eventStart <= endDate;
                const hasRequiredFields = event.terceroId && event.destino;
                console.log('[generateProgrammingJson] Event filter:', {
                    eventId: event.id,
                    startDate: event.startDate,
                    isWithinRange,
                    hasTercero: !!event.terceroId,
                    hasDestino: !!event.destino,
                    included: isWithinRange && hasRequiredFields
                });
                return isWithinRange && hasRequiredFields;
            });

            console.log('[generateProgrammingJson] Filtered events for JSON:', filteredEvents.map(e => ({
                id: e.id,
                startDate: e.startDate,
                terceroId: e.terceroId,
                destino: e.destino
            })));

            const eventsWithViatico = filteredEvents.map(event => {
                const viatico = viaticos.value.find(v => v.eventId === event.id);
                console.log('[generateProgrammingJson] Mapping event:', {
                    eventId: event.id,
                    hasViatico: !!viatico,
                    viatico: viatico ? {
                        tercero: viatico.tercero.nombreTercero,
                        startDate: viatico.event.startDate,
                        destino: viatico.event.ciudadDestino
                    } : null
                });
                return {
                    ...event,
                    viatico: viatico || null
                };
            });

            programmingEventsJson.value = JSON.stringify(eventsWithViatico, null, 2);
            console.log('[generateProgrammingJson] Generated JSON:', programmingEventsJson.value);

            // Force reactivity update
            programmingEventsJson.value = reactive(programmingEventsJson.value);

            console.log('[generateProgrammingJson] Final viaticos state:', {
                count: viaticos.value.length,
                details: viaticos.value.map(v => ({
                    eventId: v.eventId,
                    tercero: v.tercero.nombreTercero,
                    startDate: v.event.startDate,
                    destino: v.event.ciudadDestino
                }))
            });

            // Close modal and toggle Visor PDF
            showProgrammingModal.value = false;
            nextTick(() => {
                console.log('[generateProgrammingJson] Toggling Visor PDF...');
                if (showVisorPDF.value) {
                    toggleVisorPDF(); // Briefly toggle off
                    nextTick(() => toggleVisorPDF()); // Toggle back on
                } else {
                    toggleVisorPDF();
                }
                debugViaticos();
                console.log('[generateProgrammingJson] Completed.');
            });
        };

        const openProgrammingModal = () => {
            if (showTimeline.value || showVisorPDF.value) return;
            showProgrammingModal.value = true;
            updateButtonStates();

            nextTick(() => {
                if (programmingDateRangePicker.value) {
                    programmingFlatpickrInstance = flatpickr(programmingDateRangePicker.value, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        locale: 'es',
                        defaultDate: [programmingRange.value.start, programmingRange.value.end],
                        onChange: (selectedDates) => {
                            if (selectedDates.length === 2) {
                                programmingRange.value.start = selectedDates[0].toISOString().split('T')[0];
                                programmingRange.value.end = selectedDates[1].toISOString().split('T')[0];
                            }
                        },
                        onReady: (selectedDates, dateStr, instance) => {
                            if (programmingRange.value.start && programmingRange.value.end) {
                                programmingDateRangePicker.value.value = `${programmingRange.value.start} a ${programmingRange.value.end}`;
                            }
                        },
                        onOpen: (selectedDates, dateStr, instance) => {
                            if (programmingRange.value.start && programmingRange.value.end) {
                                programmingDateRangePicker.value.value = `${programmingRange.value.start} a ${programmingRange.value.end}`;
                            }
                        }
                    });

                    if (programmingRange.value.start && programmingRange.value.end) {
                        programmingDateRangePicker.value.value = `${programmingRange.value.start} a ${programmingRange.value.end}`;
                    }
                }
            });
        };

        const closeProgrammingModal = () => {
            showProgrammingModal.value = false;
            programmingRange.value = { start: '', end: '' };
            if (programmingFlatpickrInstance) {
                programmingFlatpickrInstance.destroy();
                programmingFlatpickrInstance = null;
            }
            updateButtonStates();
        };
        // ----------------------------------
        // End Component: Programming Management
        // ----------------------------------
        
        // ----------------------------------
        // Component: Visor PDF Management
        // ----------------------------------
        const debugViaticos = () => {
            console.log('[debugViaticos] Debugging viaticos...');
            console.log('[debugViaticos] Viaticos count:', viaticos.value.length);
            viaticos.value.forEach((viatico, index) => {
                console.log(`[debugViaticos] Viatico ${index}:`, {
                    tercero: viatico.tercero.nombreTercero,
                    startDate: viatico.event.startDate,
                    endDate: viatico.event.endDate,
                    destino: viatico.event.ciudadDestino,
                    eventId: viatico.eventId,
                    cost: viatico.cost
                });
                const element = document.getElementById(`pf1-${index}`);
                console.log(`[debugViaticos] Element pf1-${index} exists:`, !!element);
            });
        };

        const toggleVisorPDF = () => {
            showVisorPDF.value = !showVisorPDF.value;
            showTimeline.value = false;

            const calendarEl = document.getElementById('calendar');
            const timelineEl = document.getElementById('timeline');
            const visorPDFEl = document.getElementById('visorPDF');

            if (showVisorPDF.value) {
                if (calendarEl) calendarEl.classList.add('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.remove('hidden');
                nextTick(() => debugViaticos());
            } else {
                if (calendarEl) calendarEl.classList.remove('hidden');
                if (timelineEl) timelineEl.classList.add('hidden');
                if (visorPDFEl) visorPDFEl.classList.add('hidden');
                nextTick(() => {
                    if (calendarApi.value) {
                        calendarApi.value.render();
                        renderEvents();
                        calendarApi.value.updateSize();
                    } else {
                        reinitializeCalendar();
                    }
                });
            }
            updateButtonStates();
        };

const generatePDF = async () => {
    if (viaticos.value.length === 0) {
        console.warn('[generatePDF] No viáticos available for PDF generation.');
        alert('No hay viáticos para generar el PDF.');
        return;
    }

    if (typeof window.html2canvas !== 'function') {
        console.error('[generatePDF] html2canvas is not loaded.');
        alert('Error: No se puede generar el PDF porque html2canvas no está disponible.');
        return;
    }

    if (typeof JSZip !== 'function') {
        console.error('[generatePDF] JSZip is not loaded.');
        alert('Error: No se puede generar el ZIP porque JSZip no está disponible.');
        return;
    }

    if (typeof saveAs !== 'function') {
        console.error('[generatePDF] FileSaver.js is not loaded.');
        alert('Error: No se puede guardar el ZIP porque FileSaver.js no está disponible.');
        return;
    }

    isGeneratingPDF.value = true;
    console.log('[generatePDF] Started PDF generation, showing loading modal.');

    const { jsPDF } = window.jspdf;
    const zip = new JSZip();
    let pdfCount = 0;

    // Sort viáticos by tercero.nombreTercero for consistent numbering
    const sortedViaticos = [...viaticos.value].sort((a, b) =>
        a.tercero.nombreTercero.localeCompare(b.tercero.nombreTercero)
    );

    // Define letter size in pixels at 72 DPI
    const letterWidthPx = 612;
    const letterHeightPx = 792;

    for (let index = 0; index < sortedViaticos.length; index++) {
        const viatico = sortedViaticos[index];
        let templateId;
        switch (viatico.tercero.tipoTercero) {
            case 'CATEDRATICO':
                templateId = `pf1-${index}`;
                break;
            case 'SERVIDOR':
                templateId = `pf2-${index}`;
                break;
            case 'CONTRATISTA':
                templateId = `pf3-${index}`;
                break;
            default:
                console.warn(`[generatePDF] Unknown tipoTercero for viático ${index}: ${viatico.tercero.tipoTercero}. Skipping.`);
                continue;
        }

        const pageElement = document.getElementById(templateId);
        if (!pageElement) {
            console.warn(`[generatePDF] Page element ${templateId} not found for viático ${index}. Skipping.`);
            continue;
        }

        try {
            // Create a new jsPDF instance for each viático with letter size
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'px',
                format: [letterWidthPx, letterHeightPx],
                compression: true
            });

            const originalDisplay = pageElement.style.display;
            pageElement.style.display = 'block';

            // Calculate scale for higher quality
            const elementWidth = pageElement.offsetWidth;
            const elementHeight = pageElement.offsetHeight;
            const scale = Math.min(letterWidthPx / elementWidth, letterHeightPx / elementHeight) * 2.0;

            const canvas = await window.html2canvas(pageElement, {
                scale: scale,
                useCORS: true,
                logging: true,
                width: elementWidth,
                height: elementHeight,
                windowWidth: elementWidth,
                windowHeight: elementHeight
            });

            pageElement.style.display = originalDisplay;

            // Convert canvas to JPEG with high quality
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            // Add image with medium compression
            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'MEDIUM');
            console.log(`[generatePDF] Generated PDF for viático ${index + 1}, template: ${templateId}.`);

            // Generate unique filename
            const terceroName = viatico.tercero.nombreTercero.replace(/\s+/g, '_');
            const destinoCity = viatico.event.ciudadDestino.replace(/\s+/g, '_');
            const startDate = viatico.event.startDate.split('/').join('-');
            const paddedIndex = String(index + 1).padStart(2, '0');
            const filename = `${paddedIndex}_${terceroName}_${destinoCity}_${startDate}_${index + 1}.pdf`;

            // Convert PDF to blob and add to ZIP
            const pdfBlob = doc.output('blob');
            zip.file(filename, pdfBlob, { compression: 'DEFLATE', compressionOptions: { level: 6 } });
            pdfCount++;
            console.log(`[generatePDF] Added to ZIP: ${filename}, size: ${(pdfBlob.size / 1024).toFixed(2)} KB`);
        } catch (error) {
            console.error(`[generatePDF] Error generating PDF for viático ${index + 1}, template ${templateId}:`, error);
            alert(`Error al generar el PDF para el viático ${index + 1}: ${error.message}. Continuando con los demás viáticos.`);
        }
    }

    if (pdfCount > 0) {
        try {
            // Generate ZIP file with compression and trigger download
            const zipBlob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            saveAs(zipBlob, `comision_servicios_${new Date().toISOString().split('T')[0]}.zip`);
            console.log('[generatePDF] Saved ZIP file with', pdfCount, 'PDFs, size:', (zipBlob.size / 1024 / 1024).toFixed(2), 'MB');
        } catch (error) {
            console.error('[generatePDF] Error generating ZIP file:', error);
            alert('Error al generar el archivo ZIP: ' + error.message);
        }
    } else {
        console.warn('[generatePDF] No valid PDFs generated for ZIP.');
        alert('No se generaron PDFs válidos para incluir en el ZIP.');
    }

    isGeneratingPDF.value = false;
    console.log('[generatePDF] Completed PDF generation, hiding loading modal.');
};
        // ----------------------------------
        // End Component: Visor PDF Management
        // ----------------------------------

        // ----------------------------------
        // Component: Lifecycle Hooks
        // ----------------------------------
        onMounted(async () => {
            console.log('[onMounted] Initializing app...');
            await loadTerceros();
            await loadCities();
            console.log('[onMounted] Loaded:', {
                terceros: terceros.value.length,
                cities: cities.value.length
            });

            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: currentView.value,
                headerToolbar: false,
                firstDay: 1,
                dayHeaderFormat: { weekday: 'long' },
                height: '100%',
                contentHeight: '100%',
                eventClick: (info) => {
                    editEvent(info);
                },
                dateClick: function(info) {
                    openModal(info.dateStr);
                },
                eventDisplay: 'block',
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
                eventDidMount: function(info) {
                    if (info.event.allDay && info.event.start && info.event.end) {
                        const start = info.event.start;
                        const end = info.event.end;
                        const duration = (end - start) / (1000 * 60 * 60 * 24);
                        if (duration > 1) {
                            info.el.style.borderLeftWidth = '4px';
                            info.el.style.borderLeftStyle = 'solid';
                            info.el.style.borderLeftColor = darkenColor(info.event.backgroundColor, 20);
                        }
                    }
                },
                dayHeaderContent: function(arg) {
                    const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                    return { html: `<div>${dayName}</div>` };
                },
                views: {
                    dayGridMonth: {
                        dayMaxEventRows: limitEvents.value ? 4 : false,
                        dayMaxEvents: limitEvents.value ? 4 : false,
                        fixedWeekCount: false,
                        aspectRatio: 1.5
                    },
                    dayGridWeek: {
                        type: 'dayGrid',
                        duration: { weeks: 1 },
                        dayCount: 7,
                        dayMaxEventRows: false,
                        dayMaxEvents: false,
                        titleFormat: { year: 'numeric', month: 'long', day: 'numeric' },
                        dayHeaderContent: function(arg) {
                            const dayName = arg.text.charAt(0).toUpperCase() + arg.text.slice(1);
                            const dayNumber = arg.date.getDate();
                            return {
                                html: `
                                    <div class="flex flex-col items-center">
                                        <span class="fc-day-name">${dayName}</span>
                                        <span class="fc-day-number">${dayNumber}</span>
                                    </div>
                                `
                            };
                        }
                    }
                },
                datesSet: function() {
                    updateTitle();
                }
            });

            calendarApi.value = calendar;
            calendar.render();
            renderEvents();
            updateButtonStates();
            console.log('[onMounted] Calendar initialized.');
        });

        onUnmounted(() => {
            console.log('[onUnmounted] Cleaning up...');
            if (calendarApi.value) {
                calendarApi.value.destroy();
                calendarApi.value = null;
            }
            if (timeline) {
                timeline.destroy();
                timeline = null;
            }
            if (flatpickrInstance) {
                flatpickrInstance.destroy();
                flatpickrInstance = null;
            }
            if (programmingFlatpickrInstance) {
                programmingFlatpickrInstance.destroy();
                programmingFlatpickrInstance = null;
            }
        });
        // ----------------------------------
        // End Component: Lifecycle Hooks
        // ----------------------------------

        const openPeriodoModal = () => { };
        const toggleTimeline = () => { };

        // ----------------------------------
        // Component: Exposed methods and properties
        // ----------------------------------
        return {
            currentView,
            setView,
            navigate,
            goToToday,
            getTitle,
            limitEvents,
            toggleEventLimit,
            showModal,
            currentEvent,
            form,
            error,
            dateRangePicker,
            saveEvent,
            closeModal,
            deleteEvent,
            handleTransporteInput,
            handleRutaAdicionalInput,
            handleDescriptionInput,
            createViaticoObject,
            viaticos,
            showProgrammingModal,
            openProgrammingModal,
            closeProgrammingModal,
            programmingDateRangePicker,
            programmingEventsJson,
            generateProgrammingJson,
            showTercerosModal,
            openTercerosModal,
            closeTercerosModal,
            terceros,
            searchQuery,
            showOptions,
            filteredTerceros,
            filterTerceros,
            selectTercero,
            hideOptions,
            showTerceroForm,
            openTerceroForm,
            closeTerceroForm,
            terceroForm,
            currentTercero,
            editTercero,
            saveTercero,
            deleteTercero,
            cities,
            origenQuery,
            destinoQuery,
            showOrigenOptions,
            showDestinoOptions,
            filteredOrigenCities,
            filteredDestinoCities,
            filterOrigenCities,
            filterDestinoCities,
            selectOrigenCity,
            selectDestinoCity,
            hideOrigenOptions,
            hideDestinoOptions,            
            showVisorPDF,
            toggleVisorPDF,
            isGeneratingPDF,
            generatePDF,
            computeViatico,
            computeViaticoForProgramming,
            reinitializeCalendar,
            disabledButtons,
            debugViaticos,
            openPeriodoModal, 
            toggleTimeline,
            showTimeline,
            toggleTimeline,
            REDONDEAR,
            formatCurrency,
            computeViaticoDetails // Expose for template usage
        };
        // ----------------------------------
        // End Component: Exposed methods and properties
        // ----------------------------------
    }
});

app.mount('#app');
</script>
<!-- ---------------------------------- -->
<!-- End Component: JavaScript and Vue app initialization -->
<!-- ---------------------------------- -->
</body>
</html>
